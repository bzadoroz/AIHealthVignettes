name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  SUPABASE_TABLE: ${{ secrets.SUPABASE_TABLE }}
  APP_EMAIL: ${{ secrets.SUPABASE_APP_EMAIL }}
  APP_PASSWORD: ${{ secrets.SUPABASE_APP_PASSWORD }}

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with: 
          use-public-rspm: true
        
      - name: Detailed Debug - Check everything
        run: |
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== All files in current directory ==="
          ls -la
          echo ""
          echo "=== Content of app.R (first 10 lines) ==="
          head -10 app.R || echo "app.R not found or not readable"
          echo ""
          echo "=== File permissions ==="
          ls -la app.R || echo "app.R not found"
          echo ""
          echo "=== R working directory check ==="
          Rscript -e "getwd(); list.files()"
        
      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          packages: |
            shiny
            shinylive
        
      - name: Test shinylive detection
        run: |
          Rscript -e "
          cat('R working directory:', getwd(), '\n')
          cat('Files in current directory:\n')
          print(list.files())
          cat('Looking for app files:\n')
          cat('app.R exists:', file.exists('app.R'), '\n')
          cat('server.R exists:', file.exists('server.R'), '\n')
          cat('ui.R exists:', file.exists('ui.R'), '\n')
          "
        
      - name: Export Shinylive app
        run: |
          Rscript -e "
          Sys.setenv(
            SUPABASE_URL = '${{ env.SUPABASE_URL }}',
            SUPABASE_KEY = '${{ env.SUPABASE_KEY }}',
            SUPABASE_TABLE = '${{ env.SUPABASE_TABLE }}',
            APP_EMAIL = '${{ env.APP_EMAIL }}',
            APP_PASSWORD = '${{ env.APP_PASSWORD }}'
          )
          shinylive::export('.', '_site')
          "
