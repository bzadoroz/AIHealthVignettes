[{"name":"app.R","content":"# app.R\nlibrary(shiny)\nlibrary(bslib)\nlibrary(htmltools)\nlibrary(httr)\nlibrary(jsonlite)\n\n# -----------------------------\n# Supabase configuration\n# -----------------------------\n\n# Resolve envs into R variables (single source of truth)\nSUPABASE_URL <- \"\"https://dclbcbvqsupospynrffb.supabase.co\"\"\nSUPABASE_KEY <- \"\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjbGJjYnZxc3Vwb3NweW5yZmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTU3NzAsImV4cCI6MjA3OTA5MTc3MH0.v3Sg6iBzXoOmDLsx8V732q6ZTEkT-c0-XGcPEX8yHjs\"\"\nSUPABASE_TABLE <- \"\"Sys.getenv(\"SUPABASE_TABLE\", unset = \"responses\")\"\"\nAPP_EMAIL <- \"\"bzado@nus.edu.sg\"\"\nAPP_PASSWORD <- \"\"Anchous2025!!\"\"\n\n# Sign in with password grant (server-side)\nsupabase_sign_in <- function(email, password) {\n  url <- paste0(SUPABASE_URL, \"/auth/v1/token?grant_type=password\")\n  res <- POST(\n    url,\n    add_headers(`apikey` = SUPABASE_KEY, `Content-Type` = \"application/json\"),\n    body = toJSON(list(email = email, password = password), auto_unbox = TRUE)\n  )\n  status <- status_code(res)\n  txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n  if (status >= 200 && status < 300) {\n    fromJSON(txt)\n  } else {\n    stop(sprintf(\"Supabase sign-in failed (%s): %s\", status, txt))\n  }\n}\n\n# Refresh token\nsupabase_refresh_token <- function(refresh_token) {\n  url <- paste0(SUPABASE_URL, \"/auth/v1/token?grant_type=refresh_token\")\n  res <- POST(\n    url,\n    add_headers(`apikey` = SUPABASE_KEY, `Content-Type` = \"application/json\"),\n    body = toJSON(list(refresh_token = refresh_token), auto_unbox = TRUE)\n  )\n  status <- status_code(res)\n  txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n  if (status >= 200 && status < 300) {\n    out <- fromJSON(txt)\n    list(access_token = out$access_token, expires_in = out$expires_in)\n  } else {\n    stop(sprintf(\"Supabase token refresh failed (%s): %s\", status, txt))\n  }\n}\n\n# Save to Supabase with Authorization: Bearer <token>\n\n\nsave_to_supabase_auth <- function(row, access_token, return_representation = TRUE) {\n  stopifnot(nzchar(access_token))\n  url <- paste0(SUPABASE_URL, \"/rest/v1/\", SUPABASE_TABLE)\n  \n  # UTC formatting for POSIXct columns - FIXED VERSION\n  for (i in seq_along(row)) {\n    if (inherits(row[[i]], \"POSIXct\")) {\n      row[[i]] <- strftime(as.POSIXct(row[[i]], tz = \"UTC\"), \"%Y-%m-%dT%H:%M:%SZ\", tz = \"UTC\")\n    }\n  }\n  \n  prefer_val <- if (isTRUE(return_representation)) \"return=representation\" else \"return=minimal\"\n  \n  headers <- add_headers(\n    `apikey`          = SUPABASE_KEY,\n    `Authorization`   = paste(\"Bearer\", access_token),\n    `Content-Type`    = \"application/json\",\n    `Accept`          = \"application/json\",\n    `Prefer`          = prefer_val,\n    `Content-Profile` = \"public\",\n    `Accept-Profile`  = \"public\"\n  )\n  \n  # Debug what's actually being sent\n  json_body <- toJSON(row, auto_unbox = TRUE, na = \"null\")\n  cat(\"DEBUG: Final JSON body:\", json_body, \"\\n\")\n  \n  res <- POST(url, headers, body = json_body)\n  status <- status_code(res)\n  txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n  \n  cat(\"DEBUG: Supabase response status:\", status, \"\\n\")\n  cat(\"DEBUG: Supabase response:\", txt, \"\\n\")\n  \n  if (status >= 200 && status < 300) {\n    TRUE\n  } else {\n    stop(sprintf(\"Supabase insert failed (%s): %s\", status, txt))\n  }\n}\n\nsupabase_pid_exists <- function(pid, access_token = NULL) {\n  stopifnot(nzchar(SUPABASE_URL), nzchar(SUPABASE_KEY))\n  # Build endpoint: return at most 1 row for this pid\n  base <- paste0(SUPABASE_URL, \"/rest/v1/\", SUPABASE_TABLE)\n  url  <- httr::modify_url(\n    base,\n    query = list(\n      participant_id = paste0(\"eq.\", pid),\n      select = \"participant_id\",\n      limit  = 1\n    )\n  )\n  # Headers\n  hdrs <- httr::add_headers(\n    `apikey`         = SUPABASE_KEY,\n    `Accept`         = \"application/json\",\n    `Accept-Profile` = \"public\"\n  )\n  if (!is.null(access_token) && nzchar(access_token)) {\n    hdrs <- httr::add_headers(\n      `apikey`         = SUPABASE_KEY,\n      `Accept`         = \"application/json\",\n      `Accept-Profile` = \"public\",\n      `Authorization`  = paste(\"Bearer\", access_token)\n    )\n  }\n  \n  res <- httr::GET(url, hdrs)\n  status <- httr::status_code(res)\n  if (status >= 200 && status < 300) {\n    txt <- httr::content(res, as = \"text\", encoding = \"UTF-8\")\n    if (!nzchar(txt)) return(FALSE)\n    dat <- jsonlite::fromJSON(txt)\n    # dat can be a dataframe or list; treat any non-empty result as \"exists\"\n    return(NROW(dat) >= 1)\n  } else {\n    # If the check fails (network, auth), propagate an error so caller can handle\n    txt <- httr::content(res, as = \"text\", encoding = \"UTF-8\")\n    stop(sprintf(\"Supabase check failed (%s): %s\", status, txt))\n  }\n}\n# -----------------------------\n# Vignette generators and text\n# -----------------------------\ngenerate_balanced_vignettes <- function(seed = NULL) {\n  if (!is.null(seed)) set.seed(seed)\n  pick <- data.frame(\n    provider   = c(\"Doctor\",\"Doctor\",\"AI\",\"AI\"),\n    severity   = c(\"Low\",\"High\",\"Low\",\"High\"),\n    advice_len = c(\"Brief\",\"Long\",\"Long\",\"Brief\"),\n    stringsAsFactors = FALSE\n  )\n  pick <- pick[sample(1:4), ]\n  pick$vignette_id <- seq_len(4)\n  pick\n}\n\ncondition_text <- function(severity) {\n  if (severity == \"Low\") {\n    list(\n      title = \"Skin Rash\",\n      description = paste(\n        \"Imagine that over the past two days, you have found that you have developed a red rash on your upper left forearm. While it is unpleasantly itchy and unsightly, you are glad that it does not seem to be spreading. Moreover, aside from the rash itself, you feel fine and are not experiencing any other symptoms. Specifically, you do not have a fever and there is no blistering.\"\n      )\n    )\n  } else {\n    list(\n      title = \"Chest Pain\",\n      description = paste(\n        \"Imagine that about 30 minutes ago while you were sitting on your couch at home resting and reading, you suddenly started feeling a tightness in your chest that feels like a heavy pressure positioned right in the centre of your chest. This sensation has not gone away, and you are also finding it difficult to breathe. In addition, you have observed that you are sweating more than normal.\"\n      )\n    )\n  }\n}\n\nprovider_text <- function(provider) {\n  if (provider == \"Doctor\") {\n    \"You have been directed to be consulted by a human clinician (a licensed medical doctor). The following advice has been provided by Dr. Tan Wei Min, MBBS (Family Medicine). [ðŸ‘¨â€âš•ï¸]\"\n  } else {\n    \"You have been directed to be consulted by an AI system designed to provide medical guidance. The following advice has been provided by HealthAI Virtual Clinician (LLM-v4). [ðŸ¤–]\"\n  }\n}\n\nadvice_text <- function(severity, advice_len) {\n  if (severity == \"Low\" && advice_len == \"Brief\") {\n    paste(\n      \"Based on your description, this presentation is consistent with simple contact or irritant dermatitis. Lukewarm short showers and using a bland moisturizer at least twice daily are recommended. Avoid known irritants and allergens. Continue to monitor the rash for the next week and watch for signs of infection (pus, honey-colored crusts, increasing pain, and fever) and seek care if present. If this does not improve after a week or two, arrange for a visit to a dermatologist.\"\n    )\n  } else if (severity == \"Low\" && advice_len == \"Long\") {\n    paste(\n      \"Based on your description, this presentation is consistent with simple contact or irritant dermatitis. Lukewarm short showers and using a bland moisturizer at least twice daily are recommended. Avoid known irritants and allergens. Continue to monitor the rash for the next week and watch for signs of infection (pus, honey-colored crusts, increasing pain, and fever) and seek care if present. If this does not improve after a week or two, arrange for a visit to a dermatologist.\", \n      \n      \"The guidance that was provided is consistent with the recommendations made by dermatology groups (including the American Academy of Dermatology) and the Singapore Ministry of Health primary-care guidelines for simple localized rashes. Atopic eczema has a prevalence rate in adults of about 10% and contact dermatitis is common, while serious systemic causes are uncommon in outpatient cohorts (<1%). Therefore, in the absence of danger signs (spreading redness, severe pain, warmth/swelling, fever), the recommended course of action is self-management.\", \n      \n      \"If symptoms do not improve over time, it is recommended to review recent potential exposures (including soaps, detergents, cosmetics, metals) and ask for patch testing.\",\n      sep = \"\\n\\n\"\n    )\n  } else if (severity == \"High\" && advice_len == \"Brief\") {\n    paste(\n      \"Based on your symptoms, this may be a time-sensitive emergency. Do not wait - call 995 or go to the nearest emergency department immediately. Do not drive yourself; use an ambulance or get assistance. If symptoms worsen, stay on the line with emergency services and keep them updated. While waiting, stop activity, sit or lie with head elevated, avoid food and drink, and have a list of your medications, known conditions, and allergies to hand.  \"\n    )\n  } else {\n    paste(\n      \"Based on your symptoms, this may be a time-sensitive emergency. Do not wait - call 995 or go to the nearest emergency department immediately. Do not drive yourself; use an ambulance or get assistance. If symptoms worsen, stay on the line with emergency services and keep them updated. While waiting, stop activity, sit or lie with head elevated, avoid food and drink, and have a list of your medications, known conditions, and allergies to hand.\",  \n      \n      \"This guidance follows widely accepted emergency and cardiology recommendations, including those developed by the American Heart Association and the Singapore Ministry of Health. Chest tightness with sweating and shortness of breath are warning signs of possible heart or lung emergencies, including heart attacks. In such cases, timing is of the essence because prompt treatment can restore blood flow, prevent damage, and reduce the risk death. Although many causes of chest pain are non-cardiac in nature, urgent testing is nevertheless recommended as emergency assessment can shorten time-to-treatment by 5-15%.\", \n      \n      \"After emergency evaluation and any treatment, it is recommended to arrange a follow up with a primary care practitioner or a cardiologist within a week to examine findings, medications, and any recommended further testing. Seek urgent care if chest pain or tightness recurs, if symptoms worsen, you feel faint, or you experience a new shortness of breath.\",\n      sep = \"\\n\\n\"\n    )\n  }\n}\n\nsummary_bullets <- function(severity) {\n  if (severity == \"Low\") {\n    c(\"Localised itchy rash, not spreading\", \"No fever or blistering; otherwise well\")\n  } else {\n    c(\"Chest tightness with sweating\", \"Shortness of breath; persistent symptoms\")\n  }\n}\n\n# Provider icon (emoji or simple symbol)\nprovider_icon <- function(provider) {\n  if (provider == \"Doctor\") {\n    tags$span(class = \"sticky-provider-icon\", \"ðŸ‘¨â€âš•ï¸\")\n  } else {\n    tags$span(class = \"sticky-provider-icon\", \"ðŸ¤–\")\n  }\n}\n\n# -----------------------------\n# Theme and CSS (Typeform-inspired)\n# -----------------------------\ntheme <- bs_theme(\n  version = 5,\n  bootswatch = \"flatly\",\n  base_font = \"'TWKLausanne 400', Arial, sans-serif\",\n  heading_font = \"'Tobias', Arial, sans-serif\",\n  primary = \"#6C5CE7\"\n)\n\ncss <- \"\n/* Fonts */\n@font-face {\n  font-family: 'TWKLausanne 400';\n  src: url('https://cdn.prod.website-files.com/66ffe2174aa8e8d5661c2708/683ffc9a2aa1aa6187af000c_TWKLausanne-400.woff') format('woff');\n  font-weight: 400; font-style: normal; font-display: swap;\n}\n@font-face {\n  font-family: 'Tobias';\n  src: url('https://cdn.prod.website-files.com/66ffe2174aa8e8d5661c2708/67f7e38acef4cde59aad2dbe_Tobias-Regular.woff2') format('woff2');\n  font-weight: 400; font-style: normal; font-display: swap;\n}\n\n/* Base */\nhtml, body { background: #0f172a; color: #e5e7eb;}\n.fullscreen { display: flex; align-items: center; justify-content: center; padding: 4vh 4vw; }\n\n/* Desktop only: allow the outer card to scroll */\n@media (min-width: 769px) {\n\n    html, body { height: 100%;}\n    .fullscreen { min-height: 100vh; }\n    .card {\n          max-height: calc(100vh - 8vh);\n          overflow-y: auto;\n          }\n  #screen { overflow-y: auto; -webkit-overflow-scrolling: touch; }\n}\n\n.modal-content { background: #0f172a; color: #e5e7eb; }\n.modal-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; font-family: Tobias; color: #E7E393; }\n.modal-body, .footer  { font-size: 16px; color: #E8D7F1; margin-bottom: 20px; line-height: 1.6; font-family: Arial, sans-serif; }\n.footer {margin-top: 20px;}\n.admin-panel {color: #e5e7eb}\n\n/* Card canvas */\n.card {\n  width: min(960px, 92vw);\n  background: rgba(17,24,39,0.72);\n  border-radius: 18px;\n  backdrop-filter: blur(12px);\n  box-shadow: 0 24px 48px rgba(0,0,0,0.35);\n  padding: 32px 36px; position: relative;\n}\n\n/* Top progress */\n.top-progress { position: absolute; top: 0; left: 0; height: 4px; width: 100%; overflow: hidden; }\n.top-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #6C5CE7, #00D4FF); transition: width .35s ease; }\n\n/* Typo */\n.title { font-size: 28px; font-weight: 800; margin-bottom: 8px; font-family: Tobias; color: #E7E393; }\n.desc  { font-size: 16px; color: #E8D7F1; margin-bottom: 20px; line-height: 1.6; font-family: Arial, sans-serif; white-space: pre-line; overflow-wrap: anywhere; }\n.label { font-weight: 600; color: #E8D7F1; margin: 10px 0 8px; }\n\n.shiny-input-text, .shiny-input-password { font-family: Arial, sans-serif; }\n\n/* Dots */\n.progress-dots { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }\n.dot { width: 10px; height: 10px; border-radius: 50%; background: #334155; transition: transform .25s, background .25s; }\n.dot.active { background: #6C5CE7; transform: scale(1.2); }\n.dot.done   { background: #2EC4B6; }\n\n/* Inputs */\ntextarea.form-control {\n  background: rgba(2,6,23,0.6); color: #e5e7eb; border: 1px solid #334155;\n  border-radius: 12px; padding: 12px; min-height: 140px;\n}\ntextarea.form-control::placeholder { color: #64748b; }\ntextarea.form-control:focus { outline: none; box-shadow: 0 0 0 2px #6C5CE7; border-color: transparent; }\n.shiny-options-group { color: #E8D7F1; }\n\n/* Buttons */\n.btn {\n  border: none; border-radius: 12px; padding: 12px 18px; font-weight: 700;\n  transition: filter .18s; font-family: Arial, sans-serif;\n}\n.btn:hover { filter: brightness(1.08); }\n.btn-next { background: #2EC4B6; color: #0b1020; }\n.btn-back { background: #6C5CE7; color: #e5e7eb; }\n.btn-download { background: #2EC4B6; color: #0b1020; margin-bottom:10px;}\n#restart {margin-bottom:10px;}\n.btn.disabled, .btn:disabled { opacity: 0.6; cursor: not-allowed; }\n.nav-actions { display: flex; gap: 12px; justify-content: space-between; margin-top: 16px; }\n.nav-actions-right { display: flex; gap: 12px; }\n\n/* Override Bootstrap variables for specific buttons */\n.btn.btn-next {\n  --bs-btn-bg: #10b981;\n  --bs-btn-color: #0b1020;\n  --bs-btn-hover-bg: #00F5F2 !important;\n  --bs-btn-hover-color: #ffffff;\n  --bs-btn-border-color: transparent;\n  --bs-btn-hover-border-color: transparent;\n  --bs-btn-focus-shadow-rgb: 16,185,129;\n  --bs-btn-active-bg: #0f9e9b;\n  --bs-btn-active-border-color: transparent;\n}\n.btn.btn-back {\n  --bs-btn-bg: #475569;\n  --bs-btn-color: #e5e7eb;\n  --bs-btn-hover-bg: #A79EFF !important;\n  --bs-btn-hover-color: #e5e7eb !important;\n  --bs-btn-border-color: transparent;\n  --bs-btn-hover-border-color: transparent;\n  --bs-btn-focus-shadow-rgb: 71,85,105;\n  --bs-btn-active-bg: #2b3443;\n  --bs-btn-active-border-color: transparent;\n}\n.btn.btn-download {\n  --bs-btn-bg: #00D4FF;\n  --bs-btn-color: #0b1020;\n  --bs-btn-hover-bg: #00F5F2 !important;\n  --bs-btn-hover-color: #ffffff;\n  --bs-btn-border-color: transparent;\n  --bs-btn-hover-border-color: transparent;\n  --bs-btn-focus-shadow-rgb: 0,212,255;\n  --bs-btn-active-bg: #08a8c3;\n  --bs-btn-active-border-color: transparent;\n}\n\n/* Modals: harmonise default button */\n.modal-content .modal-footer .btn.btn-default {\n  background-color: #6C5CE7 !important; color: #ffffff !important; border-color: transparent !important;\n}\n.modal-content .modal-footer .btn.btn-default:hover {\n  background-color: #A79EFF !important; color: #ffffff !important; border-color: transparent !important;\n}\n.modal-content .modal-footer .btn:hover { filter: none !important; transform: none !important; }\n\n/* Typeform scales */\n.scale-group { display: grid; gap: 12px; }\n.scale-2 { grid-template-columns: repeat(2, minmax(80px, 1fr)); }\n.scale-3 { grid-template-columns: repeat(3, minmax(80px, 1fr)); }\n.scale-5 { grid-template-columns: repeat(5, minmax(44px, 1fr)); }\n.scale-6 { grid-template-columns: repeat(6, minmax(44px, 1fr)); }\n.scale-7 { grid-template-columns: repeat(7, minmax(44px, 1fr)); }\n\n.scale-item {\n  background: rgba(17,24,39,0.6); border: 1px solid #334155; color: #E8D7F1;\n  border-radius: 12px;   padding: clamp(6px, 1.6vw, 14px) clamp(4px, 1.2vw, 12px); text-align: center; font-weight: 700;\n  user-select: none; cursor: pointer; transition: background .18s, border-color .18s;\n  box-sizing: border-box; font-size: clamp(12px, 2vw, 16px); min-width: 0; ;\n\n}\n.main-pane { min-width: 0; }  /* ensures grid can compress inside pane */\n.scale-item:hover { background: rgba(99,102,241,0.18); border-color: #6C5CE7; }\n.scale-item.selected { background: #6C5CE7; border-color: #6C5CE7; color: #0b1020; }\n.scale-item:focus { outline: 2px solid #6C5CE7; outline-offset: 2px; }\n\n/* 2-flash animation */\n@keyframes tf-flash-twice {\n  0% { background-color: #6C5CE7; box-shadow: 0 0 0 0 rgba(108,92,231,0.00); }\n  50% { background-color: #9E8CFF; box-shadow: 0 0 0 10px rgba(158,140,255,0.25); }\n  100% { background-color: #6C5CE7; box-shadow: 0 0 0 0 rgba(108,92,231,0.00); }\n}\n.scale-item.flash { animation: tf-flash-twice 400ms ease-in-out 2 alternate; }\n\n/* Sticky summary (desktop by default, mobile collapses to one column) */\n.sticky-summary {\n  background: rgba(17,24,39,0.72);\n  border: 1px solid #334155;\n  border-radius: 12px;\n  padding: 12px 14px;\n  backdrop-filter: blur(8px);\n  box-shadow: 0 12px 24px rgba(0,0,0,0.30);\n  color: #E8D7F1;\n}\n.sticky-summary-title { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 18px; color: #E7E393; }\n\n.sticky-summary-ul    { margin: 10px 0 0; padding-left: 18px; font-size: 13px; line-height: 1.4; }\n.sticky-provider-icon { font-size: 24px; line-height: 1; }\n\n/* Screen content layout: mobile first single column */\n.screen-content { display: block; }\n.main-pane { min-width: 0; } /* allow text to wrap in grid/flex */\n\n\n/* Very small phones */\n@media (max-width: 480px) {\n  .full-screen {min-height: 80vh}\n  .title { font-size: 20px; margin-bottom:0px; }\n  .desc  { font-size: 16px; }\n  .scale-wrap { --btn-min: 30px; }\n  .scale-captions { font-size: 11px; }\n  .form-control {font-size: 16px;}\n  .btn {font-size: 15px; padding: 6px 9px;}\n}\n\n/* Desktop/Tablet: two-column layout and sticky aside */\n@media (min-width: 769px) {\n  .screen-content {\n    display: grid;\n    grid-template-columns: minmax(0, 1fr) 280px;\n    gap: 16px; align-items: start;\n  }\n  .sticky-aside { width: auto; }\n  .sticky-summary { position: sticky; top: 16px; max-width: 280px; }\n}\n\n/* Scale + captions wrapper */\n.scale-wrap {\n  width: 100%;\n  display: grid;\n  grid-template-rows: auto auto;       /* row 1 = buttons, row 2 = captions */\n  row-gap: 6px;\n  /* Button min-width is responsive via this variable */\n  --btn-min: 44px;                      /* default */\n}\n\n/* Caption row: left/right labels aligned to edges of the button grid */\n.scale-captions {\n  display: grid;\n  grid-template-columns: repeat(7, 1fr);\n  column-gap: 8px;     /* match the buttons gap so edges line up */\n  align-items: center;\n  width: 100%;\n  color: #E8D7F1;\n  font-size: clamp(11px, 1.6vw, 13px);\n  line-height: 1.3;\n  margin: 0;           /* remove default margins that can nudge alignment */\n  padding: 0;\n}\n/* Prevent long phrases from squishing; allow wrapping gracefully */\n/* Left caption under column 1, left-justified */\n.scale-caption-left {\n  grid-column: 1;\n  justify-self: start;\n  text-align: left;\n  margin: 0;\n  margin-bottom: 2px;\n}\n\n/* Right caption under column 7, right-justified */\n.scale-caption-right {\n  grid-column: 7;\n  justify-self: end;\n  text-align: right;   /* makes â€œVery accurateâ€ / â€œCompletely trustworthyâ€ hug the 7 */\n  margin-right: 5px;\n  margin-bottom: 2px;\n}\n\n/* Slide the whole card container (box) */\n#appStage { position: relative; overflow: hidden; }\n.card { will-change: transform, opacity; }\n\n/* Ghost of outgoing card */\n.card-ghost {\n  position: absolute;\n  inset: 0;\n  width: 100%;\n  z-index: 5;\n  pointer-events: none;\n}\n\n/* Outgoing animations */\n@keyframes card-out-left {\n  from { opacity: 1; transform: translateX(0); }\n  to   { opacity: 0; transform: translateX(-80px); }\n}\n@keyframes card-out-right {\n  from { opacity: 1; transform: translateX(0); }\n  to   { opacity: 0; transform: translateX(80px); }\n}\n.card-out-left  { animation: card-out-left 520ms ease both; }\n.card-out-right { animation: card-out-right 520ms ease both; }\n\n/* Incoming animations */\n@keyframes card-in-right {\n  from { opacity: 0; transform: translateX(80px); }\n  to   { opacity: 1; transform: translateX(0); }\n}\n@keyframes card-in-left {\n  from { opacity: 0; transform: translateX(-80px); }\n  to   { opacity: 1; transform: translateX(0); }\n}\n.card-in-right { animation: card-in-right 520ms ease both; }\n.card-in-left  { animation: card-in-left  520ms ease both; }\n\n/* Mobile: outer card does not scroll; inner content does. Keep card compact when content is short. */\n@media (max-width: 768px) {\n  .sticky-summary{margin-top:10px;}\n   .sticky-aside {\n    display: none; /* Hide on mobile to save space */\n  }\n  \n  /* FIXED: Don't center on mobile, just fill the space */\n  .fullscreen { \n    min-height: 70vh; \n    display: block; /* Changed from flex */\n    padding: 5px; \n    overflow: hidden; /* Prevent outer scroll */\n  }\n  \n    /* Fixed card height - no centering */\n  .card {\n    width: calc(100vw - 50px); /* Account for 5px padding on each side */\n    height: 80vh; /* Default fallback - JavaScript will override */\n    max-height: 80vh; /* Default fallback - JavaScript will override */\n    margin: 0 auto; /* Simple horizontal centering */\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    padding: 16px;\n    box-sizing: border-box;\n  }\n\n  /* Wrapper does not scroll */\n  #screen {\n    flex: 1 1 auto;\n    height: auto;\n    overflow: hidden;\n  }\n\n  /* Flex chain must allow children to shrink so inner can scroll */\n  .screen-content {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    min-height: 0;                /* critical for inner scrolling */\n  }\n  .main-pane {\n    display: flex;\n    flex-direction: column;\n    flex: 1 1 auto;\n    min-height: 0;                /* critical for inner scrolling */\n    max-height: calc(100vh - 120px); /* ADDED: ensure container has max height */\n\n  }\n\n  /* Advice: scroll only when long; otherwise compact (no hole) */\n  .main-pane .desc { flex: 0 1 auto; overflow: visible; max-height: none; }\n  .main-pane .desc.long {\n    flex: 1 1 auto;\n    min-height: 0;\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-right: 2px;\n    padding-bottom: 12px;         /* clearance above buttons */\n    max-height: calc(100vh - 300px); /* Adjust this value as needed */\n\n  }\n\n  /* 1â€“7 scale: scroll inside a capped area; fit columns */\n  .main-pane .scale-wrap {\n    flex: 0 1 auto;               /* donâ€™t fill entire pane */\n    max-height: calc(100vh - 250px);  /* ADDED: explicit max height */\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-right: 2px;\n    padding-bottom: 12px;\n  }\n  .scale-group.scale-7 {\n    display: grid;\n    grid-template-columns: repeat(7, minmax(0, 1fr));\n    column-gap: 8px;\n    width: 100%;\n  }\n  .scale-group.scale-6 {\n    display: grid;\n    grid-template-columns: repeat(6, minmax(0, 1fr));\n    column-gap: 8px;\n    width: 100%;\n  }\n  .scale-item {\n    min-width: 0;\n    padding: 8px 6px;\n    white-space: normal;\n    font-size: 8px;\n  }\n\n  .nav-actions {\n    flex: 0 0 auto; \n    margin-top: 8px; \n    background: rgba(15,23,42,0.9); \n    position: relative;\n    z-index: 10;  \n  }\n  \n  \n/* Collapsible toggles with chevron */\n.admin-toggle {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  cursor: pointer;\n  user-select: none;\n  font-weight: 700;\n  color: #E7E393;\n  text-decoration: none;\n  padding: 8px 10px;\n  border: 1px solid #334155;\n  border-radius: 8px;\n  background: rgba(17,24,39,0.6);\n  margin-top: 10px;\n}\n.admin-toggle:hover { color: #A79EFF; }\n\n.admin-toggle .chev {\n  display: inline-block;\n  transition: transform 0.2s ease;\n  font-size: 14px;\n  line-height: 1;\n}\n/* Rotate chevron when expanded (Bootstrap toggles .collapsed on the trigger) */\n.admin-toggle:not(.collapsed) .chev { transform: rotate(90deg); }\n\n/* Collapsed content containers */\n.admin-panel, .admin-guard-panel {\n  margin-top: 8px;\n  padding: 12px;\n  border: 1px solid #334155;\n  border-radius: 10px;\n  background: rgba(17,24,39,0.6);\n}\n\n/* Warning modal styling */\n.warning-modal .modal-backdrop {\n  background-color: rgba(0, 0, 0, 0.8) !important;\n}\n\n.warning-modal .modal-content {\n  background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;\n  color: #1f2937 !important;\n  border: 3px solid #d97706;\n  box-shadow: 0 25px 50px rgba(217, 119, 6, 0.3);\n  position: relative;\n}\n\n.warning-modal .modal-content::before {\n  content: 'ðŸ”’';\n  position: absolute;\n  top: -15px;\n  right: -15px;\n  font-size: 24px;\n  background: #dc2626;\n  color: white;\n  width: 40px;\n  height: 40px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border: 3px solid white;\n  box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n}\n\n/* Only disable elements when WARNING modal is active */\nbody.warning-modal-active .card:not(.warning-modal) {\n  pointer-events: none !important;\n  opacity: 0.7;\n}\n\n/* Only disable elements when WARNING modal is active, and not in other modals */\nbody.warning-modal-active input:not(#warningOkBtn),\nbody.warning-modal-active button:not(#warningOkBtn),\nbody.warning-modal-active .scale-item {\n  pointer-events: none !important;\n  opacity: 0.3 !important;\n  filter: grayscale(1) !important;\n}\n\n/* Exception: don't disable elements inside non-warning modals */\nbody.warning-modal-active .modal:not(.warning-modal) input,\nbody.warning-modal-active .modal:not(.warning-modal) button {\n  pointer-events: auto !important;\n  opacity: 1 !important;\n  filter: none !important;\n}\n\n/* Character limit styling for post questionnaire */\n#post_q_text {\n  max-length: 2400; /* Roughly 400 words * 6 chars average */\n}\n\n.char-counter {\n  font-size: 12px;\n  color: #64748b;\n  text-align: right;\n  margin-top: 4px;\n}\n\n.char-counter.warning {\n  color: #f59e0b;\n}\n\n.char-counter.error {\n  color: #ef4444;\n}\n\n/* Admin download button styling */\n.download-grid {\n  margin-top: 15px;\n}\n\n.download-grid .btn {\n  width: 100%;\n  text-align: center;\n  font-size: 13px;\n}\n\n.btn.btn-download {\n  --bs-btn-bg: #00D4FF;\n  --bs-btn-color: #0b1020;\n  --bs-btn-hover-bg: #00F5F2 !important;\n  --bs-btn-hover-color: #ffffff;\n  margin-bottom: 0px;\n}\n\"\n\n# -----------------------------\n# UI\n# -----------------------------\nui <- page_fluid(\n  theme = theme,\n  tags$head(\n    tags$title(\"Health Vignette Questionnaire\"),\n    tags$meta(name = \"viewport\", content = \"width=device-width, initial-scale=1\"),\n    tags$meta(name = \"description\", content = \"Participate in our questionnaire experience. Your feedback helps advance behavioral health research.\"),\n    # Open Graph / Facebook / Teams / WhatsApp\n    tags$meta(property = \"og:title\", content = \"Health Vignette Questionnaire\"),\n    tags$meta(property = \"og:description\", content = \"Participate in our questionnaire experience. Your feedback helps advance behavioral health research.\"),\n    tags$meta(property = \"og:type\", content = \"website\"),\n    tags$meta(property = \"og:url\", content = \"https://bzadoroz.shinyapps.io/ShinyVignettesv2/\"),\n    tags$meta(property = \"og:image\", content = \"https://bzadoroz.shinyapps.io/ShinyVignettesv2/splash.jpg\"), \n    \n    # Twitter Card\n    tags$meta(name = \"twitter:card\", content = \"summary_large_image\"),\n    tags$meta(name = \"twitter:title\", content = \"Health Vignette Questionnaire\"),\n    tags$meta(name = \"twitter:description\", content = \"Participate in our questionnaire experience. Your feedback helps advance behavioral health research.\"),\n    tags$meta(name = \"twitter:image\", content = \"https://bzadoroz.shinyapps.io/ShinyVignettesv2/splash.jpg\"), \n    \n    tags$script(src = \"app.js\")\n  ),\n  tags$head(\n    tags$link(rel = \"icon\", type = \"image/svg+xml\", href = \"favicon-ecg.svg\")\n  ),\n  tags$head(tags$style(HTML(css))),\n  div(id = \"appStage\", class = \"fullscreen\",\n      div(class = \"card gallery js-flickity\",\n          div(class = \"top-progress\", div(id = \"topProgressBar\", class = \"top-progress-bar\")),\n          uiOutput(\"progressUI\"),\n          uiOutput(\"screenUI\")\n      )\n  ))\n# -----------------------------\n# Server\n# -----------------------------\nserver <- function(input, output, session) {\n  `%||%` <- function(x, y) if (is.null(x)) y else x\n  \n  TOTAL_STEPS <- 45L # 12 pre + 4 vignettes * 8 steps (Narrative + Expl1 + Expl2 + Q1 + Q2 + Q3 + Q4 + Q5) + post-experience\n  PRE_QUESTIONNAIRE_STEPS <- 12L\n  VIGNETTE_START_STEP <- 13L\n  \n  QUESTIONNAIRE_MAP <- list(\n    \"intro\" = 1L,\n    \"demographics\" = 2L,\n    \"crt_intro\" = 3L,\n    \"crt\" = 4L,\n    \"gaais_intro\" = 5L,\n    \"gaais\" = 6L,\n    \"fwa_intro\" = 7L,\n    \"fwa\" = 8L,\n    \"teique_intro\" = 9L,\n    \"teique\" = 10L,\n    \"mhlc_intro\" = 11L,\n    \"mhlc\" = 12L\n  )\n  \n  rv <- reactiveValues(\n    admin_skip_used = FALSE,\n    \n    started = FALSE,\n    pre_step = 0L,\n    \n    section_started_at = list(\n      demographics = as.POSIXct(NA_character_),\n      crt         = as.POSIXct(NA_character_),\n      gaais       = as.POSIXct(NA_character_),\n      fwa         = as.POSIXct(NA_character_),\n      teique      = as.POSIXct(NA_character_),\n      mhlc        = as.POSIXct(NA_character_)\n    ),\n    \n    pre_q_completed = list(\n      demographics = numeric(),\n      crt = numeric(),\n      gaais = numeric(),\n      fwa = numeric(),\n      teique = numeric(),\n      mhlc = numeric()\n    ),\n    \n    \n    # Popped answers\n    popped_answers = list(\n      demographics = list(), crt = list(),\n      gaais = list(), fwa = list(),\n      teique = list(), mhlc = list()\n    ),\n    \n    \n    # Pre-questionnaire data\n    pre_answers = list(\n      demographics = list(),\n      crt = list(),\n      gaais = list(),\n      fwa = list(),\n      teique = list(),\n      mhlc = list()\n    ),\n    \n    # Track completion status\n    completed_questionnaires = character(),\n    \n    # Vignette data\n    vignettes = NULL,\n    current_vignette = 0L,  # 1..4\n    vig_step = 0L,      # 1..8\n    answers = vector(\"list\", 4),\n    responses = data.frame(\n      participant_id = character(),\n      vignette_number = integer(),\n      provider = character(),\n      severity = character(),\n      advice_len = character(),\n      q_take_advice = logical(),         # TRUE/FALSE\n      q_perceived_accuracy = integer(),\n      q_trustworthiness = integer(),   # remapped to int\n      q_concern_condition = integer(),       # NEW Q4\n      q_concern_circumstances = integer(),   # NEW Q5\n      post_vignette_response = character(),  # post vignette\n      started_at = as.POSIXct(character()),\n      submitted_at = as.POSIXct(character()),\n      stringsAsFactors = FALSE\n    ),\n    post_vignette_answer = NULL,\n    last_dir = \"forward\",\n    sb_access_token = NULL,\n    sb_refresh_token = NULL,\n    sb_expires_at    = NULL,\n    sb_auth_attempted = FALSE,\n    sb_auth_error     = NULL,\n    sb_auth_tries     = 0L,\n    sb_user_email = NULL,\n    # NEW: store start time per vignette\n    vignette_started_at = as.POSIXct(rep(NA_character_, 4))\n    \n    \n  )\n  \n  show_blocking_warning <- function(title, message, duration = 5) {\n    session$sendCustomMessage('showBlockingWarning', list(\n      title = title,\n      message = message,\n      duration = duration\n    ))\n  }\n  \n  rv$warning_cooldowns <- list(\n    gaais_straightline = as.POSIXct(NA),\n    teique_straightline = as.POSIXct(NA),\n    mhlc_straightline = as.POSIXct(NA),\n    vignette_pattern = as.POSIXct(NA),\n    speed_warning = as.POSIXct(NA),\n    attention_check = as.POSIXct(NA)\n  )\n  rv$warning_shown <- list(\n    gaais_straightline = FALSE,\n    teique_straightline = FALSE,\n    mhlc_straightline = FALSE,\n    vignette_pattern = FALSE,\n    speed_warning = FALSE\n  )\n  \n  accuracy_levels <- c(\n    \"Very inaccurate\",\n    \"Inaccurate\",\n    \"Somewhat inaccurate\",\n    \"Neither inaccurate nor accurate\",\n    \"Somewhat accurate\",\n    \"Accurate\",\n    \"Very accurate\"\n  )\n  \n  trust_levels <- c(\n    \"Not trustworthy at all\",\n    \"Untrustworthy\",\n    \"Somewhat untrustworthy\",\n    \"Neutral\",\n    \"Somewhat trustworthy\",\n    \"Trustworthy\",\n    \"Fully trustworthy\"\n  )\n  \n  # Demographics options\n  demographics_questions <- list(\n    age = list(\n      question = \"To which age group do you belong?\",\n      type = \"scale\",\n      options = c(\"<18\", \"18-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\")\n    ),\n    gender = list(\n      question = \"What is your gender?\",\n      type = \"scale\", \n      options = c(\"Male\", \"Female\", \"Non-binary/Other\")\n    ),\n    education = list(\n      question = \"What is the highest level of education that you have attained?\",\n      type = \"scale\",\n      options = c(\"High school or less\", \"Some college\", \"Bachelor's\", \"Master's\", \"Doctoral\", \"Post-doctoral or beyond\")\n    ),\n    postcode = list(\n      question = \"What are the first two digits of your postcode?\",\n      type = \"text\",\n      validation = \"postcode\"\n    )\n  )\n  \n  crt_questions <- list(\n    q1 = \"If youâ€™re running a race and you pass the person in second place, what place are you in?\",\n    q2 = \"A farmer had 15 sheep and all but 8 died. How many are left?\",\n    q3 = \"Emilyâ€™s father has three daughters. The first two are named April and May. What is the third daughterâ€™s name?\",\n    q4 = \"How many cubic feet of dirt are there in a hole that is 3â€™ deep x 3â€™ wide x 3â€™ long?\"\n  )\n  \n  gaais_questions <- c(\n    \"For routine transactions, I would rather interact with an artificially intelligent system than with a human.\",\n    \"Artificial Intelligence can provide new economic opportunities for this country.\", \n    \"Organisations use Artificial Intelligence unethically.\",\n    \"Artificially intelligent systems can help people feel happier.\",\n    \"I am impressed by what Artificial Intelligence can do.\",\n    \"I think artificially intelligent systems make many errors. \",\n    \"I am interested in using artificially intelligent systems in my daily life.\",\n    \"I find Artificial Intelligence sinister. \",\n    \"Artificial Intelligence might take control of people.\",\n    \"I think Artificial Intelligence is dangerous. \",\n    \"Artificial Intelligence can have positive impacts on peopleâ€™s wellbeing.\",\n    \"Artificial Intelligence is exciting. \",\n    \"I would be grateful if you could select Strongly Agree. \",\n    \"An artificially intelligent agent would be better than an employee in many routine jobs.\",\n    \"There are many beneficial applications of Artificial Intelligence. \",\n    \"I shiver with discomfort when I think about future uses of Artificial Intelligence. \",\n    \"Artificially intelligent systems can perform better than humans.\",\n    \"Much of society will benefit from a future full of Artificial Intelligence.\",\n    \"I would like to use Artificial Intelligence in my own job. \",\n    \"People like me will suffer if Artificial Intelligence is used more and more. \",\n    \"Artificial Intelligence is used to spy on people.\"\n  )\n  \n  fwa_questions <- c(\n    \"How frequently do you use artificial intelligence (AI) tools in general?\",\n    \"How frequently do you use artificial intelligence (AI) tools specifically in the medical context?\"\n  )\n  \n  teique_questions <- c(\n    \"Expressing my emotions with words is not a problem for me.\",\n    \"I often find it difficult to see things from another personâ€™s viewpoint.\",\n    \"On the whole, Iâ€™m a highly motivated person.\",\n    \"I usually find it difficult to regulate my emotions. \",\n    \"I generally donâ€™t find life enjoyable. \",\n    \"I can deal effectively with people.\",\n    \"I tend to change my mind frequently. \",\n    \"Many times, I canâ€™t figure out what emotion I'm feeling.\",\n    \"I feel that I have a number of good qualities.\",\n    \"I often find it difficult to stand up for my rights.\",\n    \"Iâ€™m usually able to influence the way other people feel.\",\n    \"On the whole, I have a gloomy perspective on most things.\",\n    \"Those close to me often complain that I donâ€™t treat them right.\",\n    \"I often find it difficult to adjust my life according to the circumstances.\",\n    \"On the whole, Iâ€™m able to deal with stress.\",\n    \"I often find it difficult to show my affection to those close to me.\",\n    \"Iâ€™m normally able to â€œget into someoneâ€™s shoesâ€ and experience their emotions.\",\n    \"I normally find it difficult to keep myself motivated.\",\n    \"Iâ€™m usually able to find ways to control my emotions when I want to.\",\n    \"On the whole, Iâ€™m pleased with my life.\",\n    \"I would describe myself as a good negotiator.\",\n    \"I tend to get involved in things I later wish I could get out of. \",\n    \"I often pause and think about my feelings.\",\n    \"I believe Iâ€™m full of personal strengths.\",\n    \"I tend to â€œback downâ€ even if I know Iâ€™m right. \",\n    \"I donâ€™t seem to have any power at all over other peopleâ€™s feelings. \",\n    \"I generally believe that things will work out fine in my life.\",\n    \"I find it difficult to bond well even with those close to me. \",\n    \"Generally, Iâ€™m able to adapt to new environments.\",\n    \"Others admire me for being relaxed.\",\n    \"I would be grateful if you selected the Completely Disagree option.\"  # NEW - attention check\n  )\n  \n  mhlc_questions <- c(\n    \"If I get sick, it is my own behavior which determines how soon I get well again. \",\n    \"No matter what I do, if I am going to get sick, I will get sick. \",\n    \"Having regular contact with my physician is the best way for me to avoid illness. \",\n    \"Most things that affect my health happen to me by accident.\",\n    \"Whenever I don't feel well, I should consult a medically trained professional.\",\n    \"I am in control of my health.\",\n    \"My family has a lot to do with my becoming sick or staying healthy. \",\n    \"When I get sick, I am to blame.\",\n    \"Luck plays a big part in determining how soon I will recover from an illness.\",\n    \"Health professionals control my health.\",\n    \"My good health is largely a matter of good fortune.\",\n    \"The main thing which affects my health is what I myself do.\",\n    \"If I take care of myself, I can avoid illness.\",\n    \"When I recover from an illness, it's usually because other people (for example, doctors, nurses, family, friends) have been taking good care of me. \",\n    \"No matter what I do, I am likely to get sick.\",\n    \"If it's meant to be, I will stay healthy.\",\n    \"If I take the right actions, I can stay healthy.\",\n    \"Regarding my health, I can only do what my doctor tells me to do.\"\n  )\n  \n  # Enter input error handler (corrected and structured)\n  observeEvent(input$enter_blocked, {\n    # 1) Vignette validation (steps 4..8 are question pages)\n    if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      if (rv$vig_step == 4L) {\n        showModal(modalDialog(\n          title = \"Incomplete Response\",\n          \"Please select Yes or No.\",\n          easyClose = TRUE\n        ))\n      } else if (rv$vig_step %in% c(5L, 6L, 7L, 8L)) {\n        showModal(modalDialog(\n          title = \"Incomplete Response\",\n          \"Please select a value 1â€“7.\",\n          easyClose = TRUE\n        ))\n      } else {\n        showModal(modalDialog(\n          title = \"Action blocked\",\n          \"You can only use Enter to advance on the current screen.\",\n          easyClose = TRUE\n        ))\n      }\n      return()\n    }\n    \n    # 2) Pre-questionnaire validation (even-numbered steps with inputs)\n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 12) {\n      if (rv$pre_step == 2L) {\n        # Demographics\n        current_q_num <- length(rv$pre_answers$demographics) + 1\n        q_names <- names(demographics_questions)\n        current_q_name <- q_names[current_q_num]\n        q_data <- demographics_questions[[current_q_name]]\n        \n        if (q_data$type == \"text\") {\n          # Postcode validation\n          answer <- trimws(input$current_answer %||% \"\")\n          if (!nzchar(answer)) {\n            showModal(modalDialog(\n              title = \"Incomplete Response\",\n              \"Please enter the first two digits of your postcode.\",\n              easyClose = TRUE\n            ))\n          } else if (!grepl(\"^[0-9]{2}$\", answer)) {\n            showModal(modalDialog(\n              title = \"Invalid Input\",\n              \"Please enter exactly 2 digits (numbers only).\",\n              easyClose = TRUE\n            ))\n          }\n        } else {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select an option.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 4L) {\n        # CRT - text must be filled\n        answer <- trimws(input$current_answer %||% \"\")\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please provide an answer.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 6L) {\n        # GAAIS - scale selection required\n        answer <- input$gaais_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 8L) {\n        # FWA\n        answer <- input$fwa_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 10L) {\n        # TEIQue\n        answer <- input$teique_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 12L) {\n        # MHLC\n        answer <- input$mhlc_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else {\n        # Intro screens (1, 3, 5, 7, 9, 11) have no validation\n        showModal(modalDialog(\n          title = \"Action blocked\",\n          \"You can only use Enter to advance on the current screen.\",\n          easyClose = TRUE\n        ))\n      }\n      return()\n    }\n    \n    # 3) Fallback\n    showModal(modalDialog(\n      title = \"Action blocked\",\n      \"You can only use Enter to advance on the current screen.\",\n      easyClose = TRUE\n    ))\n  })\n  \n  \n  # Additional Supabase helpers\n  \n  \n  \n  # Machine user sign-in and token refresh\n  # Try to sign the machine user in; returns TRUE on success, FALSE otherwise\n  machine_sign_in <- function() {\n    rv$sb_auth_attempted <- TRUE\n    rv$sb_auth_tries <- rv$sb_auth_tries + 1L\n    \n    # Explicit checks instead of req()\n    if (!nzchar(APP_EMAIL) || !nzchar(APP_PASSWORD)) {\n      rv$sb_auth_error <- \"Missing SUPABASE_APP_EMAIL or SUPABASE_APP_PASSWORD\"\n      message(rv$sb_auth_error)\n      return(FALSE)\n    }\n    if (!nzchar(SUPABASE_URL) || !nzchar(SUPABASE_KEY)) {\n      rv$sb_auth_error <- \"Missing SUPABASE_URL or SUPABASE_KEY\"\n      message(rv$sb_auth_error)\n      return(FALSE)\n    }\n    \n    # Attempt sign-in\n    tryCatch({\n      tok <- supabase_sign_in(APP_EMAIL, APP_PASSWORD)\n      rv$sb_access_token  <- tok$access_token\n      rv$sb_refresh_token <- tok$refresh_token\n      rv$sb_expires_at    <- Sys.time() + as.numeric(tok$expires_in)\n      rv$sb_auth_error    <- NULL\n      #      message(\"Machine user signed in; token acquired.\")\n      TRUE\n    }, error = function(e) {\n      rv$sb_auth_error <- paste(\"Machine user sign-in error:\", e$message)\n      message(rv$sb_auth_error)\n      FALSE\n    })\n  }\n  \n  # Kick off sign-in and retry up to, say, 10 times (every 5 seconds) until it succeeds\n  # Only attempt machine sign-in if not using admin skip\n  observe({\n    # Skip machine auth if admin skip is being used\n    if (isTRUE(rv$admin_skip_used)) return()\n    \n    if (is.null(rv$sb_access_token) || !nzchar(rv$sb_access_token)) {\n      invalidateLater(5000, session)\n      if (rv$sb_auth_tries < 10L) {\n        machine_sign_in()\n      } else {\n        # Only show this message if not using admin skip\n        if (!isTRUE(rv$admin_skip_used)) {\n          message(\"Machine user sign-in: reached max retries.\")\n        }\n      }\n    }\n  }, label = \"machine_sign_in_retry\")\n  \n  \n  # Admin state\n  rv$admin_unlocked <- FALSE\n  rv$sim_rows <- NULL\n  \n  # Unlock admin \n  observeEvent(input$admin_unlock, {\n    key <- trimws(input$admin_key %||% \"\")\n    if (identical(key, \"H1ghlyS3cure!\")) {\n      rv$admin_unlocked <- TRUE\n      showNotification(\"Admin unlocked.\", type = \"message\", duration = 3)\n    } else {\n      showModal(modalDialog(title = \"Invalid Admin Key\",\n                            \"The key you entered is incorrect.\", easyClose = TRUE))\n    }\n  })\n  \n  # Static (non-collapsible) Admin tools shown after unlock\n  output$adminPanel <- renderUI({\n    if (!isTRUE(rv$admin_unlocked)) return(NULL)  # This line was the issue\n    \n    div(\n      class = \"admin-panel\",\n      \n      # NEW: Skip Pre-questionnaire section\n      div(class = \"label\", \"Development Tools\"),\n      div(class = \"nav-actions\",\n          actionButton(\"btn_skip_pre\", \"Skip to Vignettes\", class = \"btn btn-back\"),\n          actionButton(\"btn_skip_to_post\", \"Skip to Post-Question\", class = \"btn btn-back\")\n      ),\n      \n      # Existing simulation section\n      div(class = \"label\", style = \"margin-top: 20px;\", \"Simulate Participants\"),\n      numericInput(\"sim_n\", \"Number of participants\",\n                   value = 100, min = 1, step = 50, width = \"240px\"),\n      numericInput(\"sim_seed\", \"Random seed (optional)\",\n                   value = NA, min = 1, step = 1, width = \"240px\"),\n      div(class = \"nav-actions\",\n          actionButton(\"btn_simulate\", \"Simulate\", class = \"btn btn-back\")\n      ),\n      \n      # Download buttons in a clean grid\n      div(class = \"download-grid\", style = \"display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;\",\n          downloadButton(\"download_sim_csv\", \"Download All Data\", class = \"btn btn-download\"),\n          downloadButton(\"download_sim_pre\", \"Download Pre-questionnaire\", class = \"btn btn-download\")\n      ),\n      div(style = \"margin-top: 10px;\",\n          downloadButton(\"download_sim_vignettes\", \"Download Vignettes Only\", class = \"btn btn-download\", style = \"width: 100%;\")\n      ),\n      uiOutput(\"simSummary\")\n    )\n  })\n  \n  \n  # Download pre-questionnaire data only\n  output$download_sim_pre <- downloadHandler(\n    filename = function() {\n      paste0(\"simulated_prequestionnaire_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      dat <- rv$sim_rows\n      if (is.null(dat) || !NROW(dat)) {\n        write.csv(data.frame(), file, row.names = FALSE)\n        return()\n      }\n      \n      # Filter to pre-questionnaire data only\n      pre_dat <- dat[dat$vignette_number == 0, ]\n      \n      # Fix Excel postcode issue on export only\n      pre_dat$post_vignette_response <- ifelse(\n        grepl(\"DEMOGRAPHICS_postcode\", pre_dat$severity) & \n          grepl(\"^[0-9]{2}$\", pre_dat$post_vignette_response),\n        paste0(\"'\", pre_dat$post_vignette_response),\n        pre_dat$post_vignette_response\n      )\n      \n      write.csv(pre_dat, file, row.names = FALSE)\n    }\n  )\n  \n  # Download vignette data only\n  output$download_sim_vignettes <- downloadHandler(\n    filename = function() {\n      paste0(\"simulated_vignettes_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      dat <- rv$sim_rows\n      if (is.null(dat) || !NROW(dat)) {\n        write.csv(data.frame(), file, row.names = FALSE)\n        return()\n      }\n      # Filter to vignette data only (vignette_number 1-4 and 99 for post-vignette)\n      vig_dat <- dat[dat$vignette_number >= 1, ]\n      write.csv(vig_dat, file, row.names = FALSE)\n    }\n  )\n  \n  # Random generators for responses (tune as desired)\n  rand_yes_no <- function(p_yes = 0.6) if (runif(1) < p_yes) \"Yes\" else \"No\"\n  rand_scale7 <- function(center = 5, spread = 1.3) {\n    v <- round(rnorm(1, mean = center, sd = spread))\n    max(1, min(7, v))\n  }\n  rand_scale5 <- function(center = 3, spread = 1.0) {\n    v <- round(rnorm(1, mean = center, sd = spread))\n    max(1, min(5, v))\n  }\n  rand_scale6 <- function(center = 3.5, spread = 1.2) {\n    v <- round(rnorm(1, mean = center, sd = spread))\n    max(1, min(6, v))\n  }\n  \n  \n  # Simulate n participants with complete pre-questionnaire and vignette data\n  simulate_participants <- function(n, seed = NULL) {\n    if (!is.null(seed) && !is.na(seed)) set.seed(as.integer(seed))\n    \n    all_rows <- vector(\"list\", n * (4 + 80))  # 4 vignettes + ~80 pre-questionnaire items\n    idx <- 0L\n    \n    for (k in seq_len(n)) {\n      pid <- sprintf(\"sim_%06d\", k)\n      \n      # Random base time within last 24 hours\n      base_t <- Sys.time() - runif(1, min = 3600, max = 24 * 3600)\n      current_time <- base_t\n      \n      # === SIMULATE PRE-QUESTIONNAIRE DATA ===\n      \n      # 1. Demographics (4 questions)\n      demo_start <- current_time\n      current_time <- current_time + runif(1, 30, 120)  # 30-120 seconds\n      \n      # Age (1-7)\n      age_val <- sample(c(\"18-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\", \"<18\"), 1, \n                        prob = c(0.25, 0.25, 0.20, 0.15, 0.10, 0.04, 0.01))\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_age\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = age_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # Gender (1-3)\n      gender_val <- sample(c(\"Male\", \"Female\", \"Non-binary/Other\"), 1, prob = c(0.45, 0.50, 0.05))\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_gender\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = gender_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # Education (1-6)\n      edu_val <- sample(c(\"High school or less\", \"Some college\", \"Bachelor's\", \"Master's\", \"Doctoral\", \"Post-doctoral or beyond\"), \n                        1, prob = c(0.15, 0.25, 0.35, 0.20, 0.04, 0.01))\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_education\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = edu_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # Postcode (2 digits)\n      postcode_val <- sprintf(\"%02d\", sample(1:80, 1))  # Clean data, no prefix\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_postcode\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = postcode_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # 2. CRT (4 questions)\n      crt_start <- current_time + runif(1, 10, 60)\n      current_time <- crt_start\n      \n      crt_answers <- list(\n        sample(1:9, 1),  # Q1: single digit\n        sample(1:9, 1),  # Q2: single digit  \n        sample(c(\"Emily\", \"April\", \"May\", \"June\", \"Lisa\"), 1),  # Q3: name\n        sample(c(\"0\", \"27\", \"5\"), 1)  # Q4: typical answers\n      )\n      \n      for (i in 1:4) {\n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_CRT\",\n          severity = paste0(\"CRT_q\", i), advice_len = \"CRT\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(crt_answers[[i]]), \n          started_at = crt_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 5, 30)\n      }\n      \n      # 3. GAAIS (21 questions)\n      gaais_start <- current_time + runif(1, 10, 60)\n      current_time <- gaais_start\n      \n      # Simulate somewhat consistent GAAIS responses (with some variation)\n      base_attitude <- sample(c(2, 3, 4), 1, prob = c(0.3, 0.4, 0.3))  # Slightly negative to neutral\n      \n      for (i in 1:21) {\n        # Add some variation around base attitude\n        response <- pmax(1, pmin(5, base_attitude + sample(-1:1, 1, prob = c(0.2, 0.6, 0.2))))\n        \n        # Question 13 is attention check - should be \"5\" (Strongly Agree)\n        if (i == 13) response <- 5\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_GAAIS\",\n          severity = paste0(\"GAAIS_q\", i), advice_len = \"GAAIS\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = gaais_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 2, 15)\n      }\n      \n      # 4. FWA (2 questions)\n      fwa_start <- current_time + runif(1, 5, 30)\n      current_time <- fwa_start\n      \n      for (i in 1:2) {\n        # FWA responses tend to be lower (1-3 mostly)\n        response <- sample(1:5, 1, prob = c(0.4, 0.3, 0.2, 0.08, 0.02))\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_FWA\",\n          severity = paste0(\"FWA_q\", i), advice_len = \"FWA\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = fwa_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 3, 20)\n      }\n      \n      # 5. TEIQue (31 questions including attention check)\n      teique_start <- current_time + runif(1, 10, 60)\n      current_time <- teique_start\n      \n      # Simulate personality-based responses\n      base_ei <- sample(3:6, 1)  # Base emotional intelligence level\n      \n      for (i in 1:31) {\n        if (i == 31) {\n          # Attention check - should be \"1\" (Completely Disagree)\n          response <- 1\n        } else {\n          # Add variation around base EI level\n          response <- pmax(1, pmin(7, base_ei + sample(-2:2, 1, prob = c(0.1, 0.2, 0.4, 0.2, 0.1))))\n        }\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_TEIQUE\",\n          severity = paste0(\"TEIQUE_q\", i), advice_len = \"TEIQUE\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = teique_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 2, 12)\n      }\n      \n      # 6. MHLC (18 questions)\n      mhlc_start <- current_time + runif(1, 10, 60)\n      current_time <- mhlc_start\n      \n      # Health locus of control varies by person\n      base_control <- sample(2:5, 1)  # Base control belief\n      \n      for (i in 1:18) {\n        response <- pmax(1, pmin(6, base_control + sample(-1:1, 1, prob = c(0.25, 0.5, 0.25))))\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_MHLC\",\n          severity = paste0(\"MHLC_q\", i), advice_len = \"MHLC\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = mhlc_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 2, 15)\n      }\n      \n      # === SIMULATE VIGNETTE DATA ===\n      vset <- generate_balanced_vignettes()\n      current_time <- current_time + runif(1, 60, 180)  # Break before vignettes\n      \n      for (i in seq_len(nrow(vset))) {\n        v <- vset[i, ]\n        \n        # Make distributions slightly depend on provider/severity\n        p_yes <- if (v$severity == \"High\") 0.75 else 0.55\n        acc_center <- if (v$provider == \"Doctor\") 5.5 else 4.7\n        trust_center <- if (v$provider == \"Doctor\") 5.6 else 4.4\n        \n        q1 <- rand_yes_no(p_yes)\n        q2 <- rand_scale7(center = acc_center, spread = 1.2)\n        q3 <- rand_scale7(center = trust_center, spread = 1.3)\n        q4 <- rand_scale7(center = 3.5, spread = 1.5)  # Concern about condition\n        q5 <- rand_scale7(center = 3.8, spread = 1.4)  # Concern about circumstances\n        \n        # Timings: started a bit earlier than submitted\n        started_at <- current_time + (i - 1) * runif(1, 60, 180)\n        submitted_at <- started_at + runif(1, 20, 90)\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid,\n          vignette_number = i,\n          provider = v$provider,\n          severity = v$severity,\n          advice_len = v$advice_len,\n          q_take_advice = (q1 == \"Yes\"),\n          q_perceived_accuracy = as.integer(q2),\n          q_trustworthiness = as.integer(q3),\n          q_concern_condition = as.integer(q4),\n          q_concern_circumstances = as.integer(q5),\n          post_vignette_response = NA_character_,\n          started_at = started_at,\n          submitted_at = submitted_at,\n          stringsAsFactors = FALSE\n        )\n        current_time <- submitted_at\n      }\n      \n      # === POST-VIGNETTE QUESTION ===\n      post_responses <- c(\n        \"I preferred the doctor because they seemed more knowledgeable and trustworthy.\",\n        \"I liked the AI better because it was more objective and detailed.\",\n        \"Both were helpful in different ways, hard to choose.\",\n        \"The doctor felt more personal and understanding.\",\n        \"The AI was faster and more consistent.\",\n        \"I trust human judgment more for health decisions.\",\n        \"The AI provided more comprehensive information.\"\n      )\n      \n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 99L, provider = \"POST_VIGNETTE\",\n        severity = \"POST_VIGNETTE\", advice_len = \"POST_VIGNETTE\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = sample(post_responses, 1),\n        started_at = current_time, submitted_at = current_time + runif(1, 30, 120),\n        stringsAsFactors = FALSE\n      )\n    }\n    \n    # Remove any NULL entries and combine\n    all_rows <- all_rows[!sapply(all_rows, is.null)]\n    do.call(rbind, all_rows)\n  }\n  \n  # Simulate on click\n  observeEvent(input$btn_simulate, {\n    n <- as.integer(input$sim_n %||% 0)\n    if (is.na(n) || n <= 0) {\n      showModal(modalDialog(title = \"Invalid number\", \"Enter a positive integer.\", easyClose = TRUE))\n      return()\n    }\n    \n    # Show progress notification\n    showNotification(\"Generating simulation data... This may take a moment.\", type = \"message\", duration = 3)\n    \n    sim <- simulate_participants(n, seed = input$sim_seed)\n    rv$sim_rows <- sim\n    \n    # Count the data for notification\n    participants <- length(unique(sim$participant_id))\n    total_rows <- nrow(sim)\n    \n    showNotification(\n      sprintf(\"Simulated %d participants with complete data (%d total rows).\", participants, total_rows), \n      type = \"message\", \n      duration = 5\n    )\n  })\n  \n  # Show a more detailed summary\n  output$simSummary <- renderUI({\n    dat <- rv$sim_rows\n    if (is.null(dat) || !NROW(dat)) return(NULL)\n    \n    # Count different types of data\n    vignette_rows <- sum(dat$vignette_number >= 1 & dat$vignette_number <= 4)\n    pre_rows <- sum(dat$vignette_number == 0)\n    post_rows <- sum(dat$vignette_number == 99)\n    participants <- length(unique(dat$participant_id))\n    \n    # Break down pre-questionnaire data\n    demo_rows <- sum(grepl(\"DEMOGRAPHICS\", dat$provider))\n    crt_rows <- sum(grepl(\"CRT\", dat$provider))\n    gaais_rows <- sum(grepl(\"GAAIS\", dat$provider))\n    fwa_rows <- sum(grepl(\"FWA\", dat$provider))\n    teique_rows <- sum(grepl(\"TEIQUE\", dat$provider))\n    mhlc_rows <- sum(grepl(\"MHLC\", dat$provider))\n    \n    \n  })\n  \n  # Download simulated CSV\n  output$download_sim_csv <- downloadHandler(\n    filename = function() {\n      paste0(\"simulated_responses_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      dat <- rv$sim_rows\n      if (is.null(dat) || !NROW(dat)) {\n        write.csv(data.frame(), file, row.names = FALSE)\n        return()\n      }\n      \n      # Fix Excel postcode issue on export only\n      dat$post_vignette_response <- ifelse(\n        grepl(\"DEMOGRAPHICS_postcode\", dat$severity) & \n          grepl(\"^[0-9]{2}$\", dat$post_vignette_response),\n        paste0(\"'\", dat$post_vignette_response),\n        dat$post_vignette_response\n      )\n      \n      write.csv(dat, file, row.names = FALSE)\n    }\n  )\n  \n  # Progress dots (24 micro-steps)\n  output$progressUI <- renderUI({\n    if (!rv$started) {\n      return(div(class = \"progress-dots\"))\n    }\n    \n    # PRE-QUESTIONNAIRES (before vignettes start)\n    # Hide dots on vignette intro (step 13)\n    if (rv$pre_step == 13L) {\n      return(div(class = \"progress-dots\"))\n    }\n    \n    if (rv$pre_step <= 12) {\n      if (rv$pre_step == 1) {\n        return(div(class = \"progress-dots\")) # No dots for main intro\n      } else if (rv$pre_step == 2) {\n        current_q <- length(rv$pre_answers$demographics) + 1\n        total_q <- 4\n      } else if (rv$pre_step == 4) {\n        current_q <- length(rv$pre_answers$crt) + 1\n        total_q <- 4\n      } else if (rv$pre_step == 6) {\n        current_q <- length(rv$pre_answers$gaais) + 1\n        total_q <- 21\n      } else if (rv$pre_step == 8) {\n        current_q <- length(rv$pre_answers$fwa) + 1\n        total_q <- 2\n      } else if (rv$pre_step == 10) {\n        current_q <- length(rv$pre_answers$teique) + 1\n        total_q <- 30\n      } else if (rv$pre_step == 12) {\n        current_q <- length(rv$pre_answers$mhlc) + 1\n        total_q <- 18\n      } else {\n        return(div(class = \"progress-dots\")) # No dots for other intros\n      }\n      \n      dots <- lapply(1:total_q, function(i) {\n        cls <- \"dot\"\n        if (current_q > i) cls <- paste(cls, \"done\")\n        else if (current_q == i) cls <- paste(cls, \"active\")\n        div(class = cls)\n      })\n      return(div(class = \"progress-dots\", dots))\n    }\n    \n    # Fallback\n    return(div(class = \"progress-dots\"))\n    \n    \n    # VIGNETTES + POST: show a single 33-dot progress bar\n    # Map current position into 1..33\n    total_dots <- 33L\n    current_idx <- 1L\n    \n    if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      # Steps are 1..8 within each vignette; clamp to [1,8]\n      s <- max(1L, min(8L, as.integer(rv$vig_step)))\n      current_idx <- (rv$current_vignette - 1L) * 8L + s  # 1..32\n    } else if (rv$current_vignette == 5L) {\n      # Post-vignette question (single dot, the 33rd)\n      current_idx <- 33L\n    } else {\n      # After completion (rv$current_vignette >= 6)\n      current_idx <- 33L\n    }\n    \n    dots <- lapply(1:total_dots, function(i) {\n      cls <- \"dot\"\n      if (i < current_idx) cls <- paste(cls, \"done\")\n      else if (i == current_idx) cls <- paste(cls, \"active\")\n      div(class = cls)\n    })\n    div(class = \"progress-dots\", dots)\n  })\n  \n  \n  # Top progress bar\n  set_top_progress <- function() {\n    if (!rv$started) {\n      session$sendCustomMessage(\"setTopProgress\", 0)\n      return()\n    }\n    # Linearise position 1..45\n    # Pre: steps 1..13 (13 includes vignette intro)\n    # Vignettes: 4 blocks of 8 steps => 32 steps, indices 13+1 .. 13+32 = 14..45-1\n    # Post: 1 step (index 45)\n    idx <- 0L\n    \n    if (rv$current_vignette == 0L) {\n      # Still in pre (including step 13 vignette intro)\n      idx <- max(1L, min(13L, as.integer(rv$pre_step)))\n    } else if (rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      # 12 pre steps completed fully before entering vignettes\n      s <- max(1L, min(8L, as.integer(rv$vig_step)))\n      idx <- 12L + (rv$current_vignette - 1L) * 8L + s\n      # idx spans 13..44\n    } else if (rv$current_vignette == 5L) {\n      # Post-vignette open question, treat as the 45th \"step\"\n      idx <- 45L\n    } else {\n      # Completed\n      idx <- 45L\n    }\n    \n    pct <- round(idx / 45 * 100)\n    session$sendCustomMessage(\"setTopProgress\", pct)\n  }\n  \n  \n  # Add this function near the top of your server function:\n  calculate_detailed_progress <- function() {\n    if (!rv$started) return(0)\n    \n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 14) {\n      # Pre-questionnaire detailed progress\n      base_progress <- 0\n      \n      # Fixed steps (intros): 1, 3, 5, 7, 9, 11, 13 = 7 steps\n      # Variable steps: 2(4q), 4(4q), 6(21q), 8(2q), 10(31q), 12(18q) = 80 questions\n      # Total pre steps equivalent: 7 + 80 = 87 \"micro-steps\"\n      \n      if (rv$pre_step == 1) {\n        return(1)\n      } else if (rv$pre_step == 2) {\n        # Demographics: 4 questions\n        q_completed <- length(rv$pre_answers$demographics)\n        return(2 + (q_completed * 4) / 4)  # 2-6\n      } else if (rv$pre_step == 3) {\n        return(7)\n      } else if (rv$pre_step == 4) {\n        # CRT: 4 questions\n        q_completed <- length(rv$pre_answers$crt)\n        return(8 + (q_completed * 4) / 4)  # 8-12\n      } else if (rv$pre_step == 5) {\n        return(13)\n      } else if (rv$pre_step == 6) {\n        # GAAIS: 21 questions\n        q_completed <- length(rv$pre_answers$gaais)\n        return(14 + (q_completed * 21) / 21)  # 14-35\n      } else if (rv$pre_step == 7) {\n        return(36)\n      } else if (rv$pre_step == 8) {\n        # FWA: 2 questions\n        q_completed <- length(rv$pre_answers$fwa)\n        return(37 + (q_completed * 2) / 2)  # 37-39\n      } else if (rv$pre_step == 9) {\n        return(40)\n      } else if (rv$pre_step == 10) {\n        # TEIQue: 31 questions (including attention check)\n        q_completed <- length(rv$pre_answers$teique)\n        return(41 + (q_completed * 31) / 31)  # 41-72\n      } else if (rv$pre_step == 11) {\n        return(73)\n      } else if (rv$pre_step == 12) {\n        # MHLC: 18 questions\n        q_completed <- length(rv$pre_answers$mhlc)\n        return(74 + (q_completed * 18) / 18)  # 74-92\n      } else if (rv$pre_step == 13) {\n        return(93)  # Vignette intro\n      }\n    } else if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      # Vignettes: start from step 93, add 32 steps for vignettes\n      s <- max(1L, min(8L, as.integer(rv$vig_step)))\n      return(93 + (rv$current_vignette - 1L) * 8L + s)  # 94-125\n    } else if (rv$current_vignette == 5L) {\n      return(126)  # Post-vignette\n    } else {\n      return(126)  # Completed\n    }\n  }\n  \n  set_detailed_progress <- function() {\n    detailed_step <- calculate_detailed_progress()\n    pct <- round(detailed_step / 126 * 100)  # 126 total micro-steps\n    session$sendCustomMessage(\"setTopProgress\", pct)\n  }\n  \n  # Pre-questionnaire rendering\n  \n  render_pre_questionnaire_screen <- function() {\n    pre_step <- rv$pre_step\n    \n    if (pre_step == 1) {\n      # Main introduction\n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", \"Study Overview\"),\n          div(class = \"desc\", \"You will complete 6 questionnaires before the main study. For your convenience, you will be shown two types of progress indicators. The bar at the top indicates your progress through the entire study, while the dots beneath it indicate your progress through the current set of questions (not displayed on this page).\"),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", \"Begin Questionnaires\", class = \"btn btn-next\")\n              )\n          )\n      )\n    } else if (pre_step == 2) {\n      render_demographics_screen()\n    } else if (pre_step == 3) {\n      render_intro_screen(\"Additional Screening\", \"You will now complete a series of four open-ended questions designed to generate a baseline.\")\n    } else if (pre_step == 4) {\n      render_crt_screen()\n    } else if (pre_step == 5) {\n      render_intro_screen(\"General Attitudes toward AI \", \"You will now complete questions about your attitudes toward artificial intelligence.\")\n    } else if (pre_step == 6) {\n      render_gaais_screen()\n    } else if (pre_step == 7) {\n      render_intro_screen(\"Familiarity with AI\", \"You will now answer questions about your familiarity with artificial intelligence.\")\n    } else if (pre_step == 8) {\n      render_fwa_screen()\n    } else if (pre_step == 9) {\n      render_intro_screen(\"TEIQue\", \"You will now complete a questionnaire that evaluates your level of trait emotional intelligence.\")\n    } else if (pre_step == 10) {\n      render_teique_screen()\n    } else if (pre_step == 11) {\n      render_intro_screen(\"MHLC\", \"You will now complete questions about health beliefs.\")\n    } else if (pre_step == 12) {\n      render_mhlc_screen()\n    } else if (pre_step == 13) {\n      # Vignette introduction\n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", \"Healthcare Scenarios\"),\n          div(class = \"desc\", \"You will now be presented with a series of healthcare scenarios. You will be asked to imagine that you have certain symptoms for which you will receive healthcare advice. Please read it carefully. Following each scenario, you will be asked to share your perspectives on the advice provided.\"),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", \"Begin Vignettes\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_intro_screen <- function(title, description) {\n    div(id = \"screen\", class = \"screen\",\n        div(class = \"title\", title),\n        div(class = \"desc\", description),\n        div(class = \"nav-actions\",\n            actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n            div(class = \"nav-actions-right\",\n                actionButton(\"btn_next\", \"Continue\", class = \"btn btn-next\")\n            )\n        )\n    )\n  }\n  \n  # Individual questionnaire renders\n  \n  render_demographics_screen <- function() {\n    current_q <- length(rv$pre_answers$demographics) + 1\n    total_q <- 4\n    \n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_names <- names(demographics_questions)\n      current_q_name <- q_names[current_q]\n      q_data <- demographics_questions[[current_q_name]]\n      \n      # ADD DEBUG LINE\n      # cat(\"DEBUG: Rendering demographics screen, question\", current_q, \"type:\", q_data$type, \"name:\", current_q_name, \"\\n\")\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"Demographics\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_data$question),\n          \n          if (q_data$type == \"scale\") {\n            # Render as clickable scale\n            existing <- rv$pre_answers$demographics[[current_q_name]] %||% NULL\n            scale_class <- if (current_q_name == \"age\") \"scale-7\" else if (current_q_name == \"gender\") \"scale-3\" else \"scale-6\"\n            \n            div(class = \"scale-wrap\",\n                div(class = paste(\"scale-group\", scale_class), `data-input` = paste0(\"demo_\", current_q_name),\n                    lapply(seq_along(q_data$options), function(i) {\n                      option_text <- q_data$options[i]\n                      div(\n                        class = paste(\"scale-item\", if (!is.null(existing) && existing == option_text) \"selected\"),\n                        `data-value` = as.character(i),\n                        option_text\n                      )\n                    })\n                )\n            )\n          } else {\n            # Use a unique input ID for this specific question\n            input_id <- paste0(\"demo_text_\", current_q_name)  # e.g., \"demo_text_postcode\"\n            \n            # cat(\"DEBUG: Creating textInput with ID:\", input_id, \"\\n\")\n            \n            # ADD AUTOFOCUS TRIGGER HERE\n            session$onFlushed(function() {\n              session$sendCustomMessage(\"autoFocusText\", TRUE)\n            }, once = TRUE)\n            \n            textInput(input_id, NULL, placeholder = \"Enter first two digits (numbers only)\")\n          }\n          ,\n          \n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit Demographics\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_crt_screen <- function() {\n    current_q <- length(rv$pre_answers$crt) + 1\n    total_q <- 4\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      q_text <- crt_questions[[current_q]]\n      \n      # Use unique input ID for CRT questions\n      input_id <- paste0(\"crt_text_q\", current_q)  # e.g., \"crt_text_q1\"\n      \n      # CRT input constraints by question number with character limits\n      if (current_q == 1) {  # Q1: one character (digit)\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter digits only\", width = \"150px\"),\n          maxlength = \"1\"\n        )\n      } else if (current_q == 2) {  # Q2: one character (digit)\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter digits only\", width = \"150px\"),\n          maxlength = \"1\"\n        )\n      } else if (current_q == 3) {  # Q3: Emily question - 10 characters\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter name\", width = \"150px\"),\n          maxlength = \"10\"\n        )\n      } else if (current_q == 4) {  # Q4: three characters\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter digits only\", width = \"150px\"),\n          maxlength = \"3\"\n        )\n      }\n      \n      # ADD AUTOFOCUS TRIGGER HERE\n      session$onFlushed(function() {\n        session$sendCustomMessage(\"autoFocusText\", TRUE)\n      }, once = TRUE)\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"Additional Screening\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          crt_input_ui,\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit Baseline\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_gaais_screen <- function() {\n    current_q <- length(rv$pre_answers$gaais) + 1\n    total_q <- 21\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      \n      q_text <- gaais_questions[current_q]\n      existing <- rv$pre_answers$gaais[[paste0(\"q\", current_q)]] %||% NULL\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"GAAIS\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-5\"), `data-input` = \"gaais_q\",\n                  lapply(1:5, function(i) {\n                    labels <- c(\"Strongly Disagree\", \"(Somewhat) Disagree\", \"Neutral\", \"(Somewhat) Agree\", \"Strongly Agree\")\n                    div(\n                      class = paste(\"scale-item\", if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                      `data-value` = as.character(i),\n                      div(style = \"font-size: 14px; font-weight: bold;\", as.character(i)),\n                      div(style = \"font-size: 11px; margin-top: 2px;\", labels[i])\n                    )\n                  })\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit GAAIS\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_fwa_screen <- function() {\n    current_q <- length(rv$pre_answers$fwa) + 1\n    total_q <- 2\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_text <- fwa_questions[current_q]\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"FWA\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-5\"), `data-input` = \"fwa_q\",\n                  lapply(1:5, function(i) {\n                    labels <- c(\"Never\", \"Rarely\", \"Monthly\", \"Weekly\", \"Daily\")\n                    div(\n                      class = paste(\"scale-item\"),\n                      `data-value` = as.character(i),\n                      div(style = \"font-size: 14px; font-weight: bold;\", as.character(i)),\n                      div(style = \"font-size: 11px; margin-top: 2px;\", labels[i])\n                    )\n                  })\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit FWA\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_teique_screen <- function() {\n    current_q <- length(rv$pre_answers$teique) + 1\n    total_q <- 31 # plus one for attention check \n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_text <- teique_questions[current_q]\n      existing <- rv$pre_answers$teique[[paste0(\"q\", current_q)]] %||% NULL\n      \n      # Check if this is the attention check question (question 31)\n      is_attention_check <- (current_q == 31)\n      \n      # Don't show TEIQue header for the attention check question\n      title_text <- if (current_q == 31) {\n        paste(\"Kind Request\")\n      } else {\n        paste(\"TEIQue\", current_q, \"of\", 30)\n      }\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", title_text),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"teique_q\",\n                  lapply(1:7, function(i) {\n                    div(\n                      class = paste(\"scale-item\", if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                      `data-value` = as.character(i),\n                      as.character(i)\n                    )\n                  })\n              ),\n              div(class = \"scale-captions\",\n                  div(class = \"scale-caption-left\", \"Completely Disagree\"),\n                  div(class = \"scale-caption-right\", \"Completely Agree\")\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit TEIQue\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n      \n    }\n  }\n  \n  render_mhlc_screen <- function() {\n    current_q <- length(rv$pre_answers$mhlc) + 1\n    total_q <- 18\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_text <- mhlc_questions[current_q]\n      existing <- rv$pre_answers$mhlc[[paste0(\"q\", current_q)]] %||% NULL\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"MHLC\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-6\"), `data-input` = \"mhlc_q\",\n                  lapply(1:6, function(i) {\n                    div(\n                      class = paste(\"scale-item\", if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                      `data-value` = as.character(i),\n                      as.character(i)\n                    )\n                  })\n              ),\n              div(class = \"scale-captions\",\n                  div(class = \"scale-caption-left\", \"Strongly Disagree\"),\n                  div(class = \"scale-caption-right\", \"Strongly Agree\")\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit MHLC\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  save_demographics_data <- function() {\n    if (length(rv$pre_answers$demographics) != 4) return()\n    \n    demo_row <- data.frame(\n      participant_id = input$participant_id,\n      age        = rv$pre_answers$demographics$age,\n      gender     = rv$pre_answers$demographics$gender,\n      education  = rv$pre_answers$demographics$education,\n      postcode   = rv$pre_answers$demographics$postcode,\n      demo.started_at   = rv$section_started_at$demographics,\n      demo.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(demo_row, \"demographics\")\n  }\n  \n  save_crt_data <- function() {\n    if (length(rv$pre_answers$crt) != 4) return()\n    \n    crt_row <- data.frame(\n      participant_id = input$participant_id,\n      crt.q1 = rv$pre_answers$crt$q1,\n      crt.q2 = rv$pre_answers$crt$q2,\n      crt.q3 = rv$pre_answers$crt$q3,\n      crt.q4 = rv$pre_answers$crt$q4,\n      crt.started_at   = rv$section_started_at$crt,\n      crt.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(crt_row, \"crt\")\n  }\n  \n  \n  save_gaais_data <- function() {\n    if (length(rv$pre_answers$gaais) != 21) return()\n    \n    gaais_row <- data.frame(\n      participant_id = input$participant_id,\n      ga.q1 = rv$pre_answers$gaais$q1, ga.q2 = rv$pre_answers$gaais$q2, ga.q3 = rv$pre_answers$gaais$q3,\n      ga.q4 = rv$pre_answers$gaais$q4, ga.q5 = rv$pre_answers$gaais$q5, ga.q6 = rv$pre_answers$gaais$q6,\n      ga.q7 = rv$pre_answers$gaais$q7, ga.q8 = rv$pre_answers$gaais$q8, ga.q9 = rv$pre_answers$gaais$q9,\n      ga.q10 = rv$pre_answers$gaais$q10, ga.q11 = rv$pre_answers$gaais$q11, \n      ga.q12 = rv$pre_answers$gaais$q12,\n      ga.q13.attentioncheck = rv$pre_answers$gaais$q13, ga.q14 = rv$pre_answers$gaais$q14, \n      ga.q15 = rv$pre_answers$gaais$q15,\n      ga.q16 = rv$pre_answers$gaais$q16, ga.q17 = rv$pre_answers$gaais$q17, \n      ga.q18 = rv$pre_answers$gaais$q18,\n      ga.q19 = rv$pre_answers$gaais$q19, ga.q20 = rv$pre_answers$gaais$q20, \n      ga.q21 = rv$pre_answers$gaais$q21,\n      ga.started_at   = rv$section_started_at$gaais,\n      ga.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(gaais_row, \"gaais\")\n  }\n  \n  save_fwa_data <- function() {\n    if (length(rv$pre_answers$fwa) != 2) return()\n    \n    fwa_row <- data.frame(\n      participant_id = input$participant_id,\n      fwa.q1 = rv$pre_answers$fwa$q1,\n      fwa.q2 = rv$pre_answers$fwa$q2,\n      fwa.started_at   = rv$section_started_at$fwa,\n      fwa.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(fwa_row, \"fwa\")\n  }\n  \n  save_teique_data <- function() {\n    if (length(rv$pre_answers$teique) != 31) return()\n    \n    teique_row <- data.frame(\n      participant_id = input$participant_id,\n      tq.q1 = rv$pre_answers$teique$q1, tq.q2 = rv$pre_answers$teique$q2, tq.q3 = rv$pre_answers$teique$q3,\n      tq.q4 = rv$pre_answers$teique$q4, tq.q5 = rv$pre_answers$teique$q5, tq.q6 = rv$pre_answers$teique$q6,\n      tq.q7 = rv$pre_answers$teique$q7, tq.q8 = rv$pre_answers$teique$q8, tq.q9 = rv$pre_answers$teique$q9,\n      tq.q10 = rv$pre_answers$teique$q10, tq.q11 = rv$pre_answers$teique$q11, tq.q12 = rv$pre_answers$teique$q12,\n      tq.q13 = rv$pre_answers$teique$q13, tq.q14 = rv$pre_answers$teique$q14, tq.q15 = rv$pre_answers$teique$q15,\n      tq.q16 = rv$pre_answers$teique$q16, tq.q17 = rv$pre_answers$teique$q17, tq.q18 = rv$pre_answers$teique$q18,\n      tq.q19 = rv$pre_answers$teique$q19, tq.q20 = rv$pre_answers$teique$q20, tq.q21 = rv$pre_answers$teique$q21,\n      tq.q22 = rv$pre_answers$teique$q22, tq.q23 = rv$pre_answers$teique$q23, tq.q24 = rv$pre_answers$teique$q24,\n      tq.q25 = rv$pre_answers$teique$q25, tq.q26 = rv$pre_answers$teique$q26, tq.q27 = rv$pre_answers$teique$q27,\n      tq.q28 = rv$pre_answers$teique$q28, tq.q29 = rv$pre_answers$teique$q29, tq.q30 = rv$pre_answers$teique$q30,\n      tq.attentioncheck = rv$pre_answers$teique$q31, # new attention check!\n      tq.started_at   = rv$section_started_at$teique,\n      tq.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(teique_row, \"teique\")\n  }\n  \n  save_mhlc_data <- function() {\n    if (length(rv$pre_answers$mhlc) != 18) return()\n    \n    mhlc_row <- data.frame(\n      participant_id = input$participant_id,\n      mhlc.q1 = rv$pre_answers$mhlc$q1, mhlc.q2 = rv$pre_answers$mhlc$q2, mhlc.q3 = rv$pre_answers$mhlc$q3,\n      mhlc.q4 = rv$pre_answers$mhlc$q4, mhlc.q5 = rv$pre_answers$mhlc$q5, mhlc.q6 = rv$pre_answers$mhlc$q6,\n      mhlc.q7 = rv$pre_answers$mhlc$q7, mhlc.q8 = rv$pre_answers$mhlc$q8, mhlc.q9 = rv$pre_answers$mhlc$q9,\n      mhlc.q10 = rv$pre_answers$mhlc$q10, mhlc.q11 = rv$pre_answers$mhlc$q11, \n      mhlc.q12 = rv$pre_answers$mhlc$q12,\n      mhlc.q13 = rv$pre_answers$mhlc$q13, mhlc.q14 = rv$pre_answers$mhlc$q14, \n      mhlc.q15 = rv$pre_answers$mhlc$q15,\n      mhlc.q16 = rv$pre_answers$mhlc$q16, mhlc.q17 = rv$pre_answers$mhlc$q17, \n      mhlc.q18 = rv$pre_answers$mhlc$q18,\n      mhlc.started_at   = rv$section_started_at$mhlc,\n      mhlc.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(mhlc_row, \"mhlc\")\n  }\n  \n  \n  # Helper function to save to different tables\n  save_to_table <- function(row, table_name) {\n    if (!is.null(rv$sb_access_token) && nzchar(rv$sb_access_token)) {\n      tryCatch({\n        # Create custom save function for different table\n        url <- paste0(SUPABASE_URL, \"/rest/v1/\", table_name)\n        \n        # UTC formatting for POSIXct columns\n        for (i in seq_along(row)) {\n          if (inherits(row[[i]], \"POSIXct\")) {\n            row[[i]] <- strftime(as.POSIXct(row[[i]], tz = \"UTC\"), \"%Y-%m-%dT%H:%M:%SZ\", tz = \"UTC\")\n          }\n        }\n        \n        headers <- add_headers(\n          `apikey` = SUPABASE_KEY,\n          `Authorization` = paste(\"Bearer\", rv$sb_access_token),\n          `Content-Type` = \"application/json\",\n          `Accept` = \"application/json\",\n          `Prefer` = \"return=minimal\",\n          `Content-Profile` = \"public\",\n          `Accept-Profile` = \"public\"\n        )\n        \n        json_body <- toJSON(row, auto_unbox = TRUE, na = \"null\")\n        res <- POST(url, headers, body = json_body)\n        status <- status_code(res)\n        \n        if (status >= 200 && status < 300) {\n          showNotification(paste(toupper(table_name), \"data saved to remote database.\"), type = \"message\", duration = 3)\n          return(TRUE)\n        } else {\n          txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n          stop(sprintf(\"Supabase insert failed (%s): %s\", status, txt))\n        }\n      }, error = function(e) {\n        showModal(modalDialog(\n          title = \"Supabase Save Error\",\n          paste(\"Error saving\", table_name, \"data:\", e$message),\n          easyClose = TRUE\n        ))\n      })\n    }\n  }\n  \n  # helper for postcodes\n  \n  # Replace your validate_postcode function with this complete mapping:\n  validate_postcode <- function(postcode) {\n    postcode_map <- list(\n      # District 01: Raffles Place, Cecil, Marina, People's Park\n      \"01\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"02\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"03\" = \"Raffles Place / Cecil / Marina / People's Park\", \n      \"04\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"05\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"06\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \n      # District 02: Anson, Tanjong Pagar\n      \"07\" = \"Anson / Tanjong Pagar\",\n      \"08\" = \"Anson / Tanjong Pagar\",\n      \n      # District 03: Queenstown, Tiong Bahru\n      \"14\" = \"Queenstown / Tiong Bahru\",\n      \"15\" = \"Queenstown / Tiong Bahru\", \n      \"16\" = \"Queenstown / Tiong Bahru\",\n      \n      # District 04: Telok Blangah, Harbourfront\n      \"09\" = \"Telok Blangah / Harbourfront\",\n      \"10\" = \"Telok Blangah / Harbourfront\",\n      \n      # District 05: Pasir Panjang, Hong Leong Garden, Clementi New Town\n      \"11\" = \"Pasir Panjang / Hong Leong Garden / Clementi New Town\",\n      \"12\" = \"Pasir Panjang / Hong Leong Garden / Clementi New Town\",\n      \"13\" = \"Pasir Panjang / Hong Leong Garden / Clementi New Town\",\n      \n      # District 06: High Street, Beach Road (part)\n      \"17\" = \"High Street / Beach Road\",\n      \n      # District 07: Middle Road, Golden Mile\n      \"18\" = \"Middle Road / Golden Mile\",\n      \"19\" = \"Middle Road / Golden Mile\",\n      \n      # District 08: Little India\n      \"20\" = \"Little India\",\n      \"21\" = \"Little India\",\n      \n      # District 09: Orchard, Cairnhill, River Valley\n      \"22\" = \"Orchard / Cairnhill / River Valley\",\n      \"23\" = \"Orchard / Cairnhill / River Valley\",\n      \n      # District 10: Ardmore, Bukit Timah, Holland Road, Tanglin\n      \"24\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \"25\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \"26\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \"27\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \n      # District 11: Watten Estate, Novena, Thomson\n      \"28\" = \"Watten Estate / Novena / Thomson\",\n      \"29\" = \"Watten Estate / Novena / Thomson\",\n      \"30\" = \"Watten Estate / Novena / Thomson\",\n      \n      # District 12: Balestier, Toa Payoh, Serangoon\n      \"31\" = \"Balestier / Toa Payoh / Serangoon\",\n      \"32\" = \"Balestier / Toa Payoh / Serangoon\",\n      \"33\" = \"Balestier / Toa Payoh / Serangoon\",\n      \n      # District 13: Macpherson, Braddell\n      \"34\" = \"Macpherson / Braddell\",\n      \"35\" = \"Macpherson / Braddell\",\n      \"36\" = \"Macpherson / Braddell\",\n      \"37\" = \"Macpherson / Braddell\",\n      \n      # District 14: Geylang, Eunos\n      \"38\" = \"Geylang / Eunos\",\n      \"39\" = \"Geylang / Eunos\",\n      \"40\" = \"Geylang / Eunos\",\n      \"41\" = \"Geylang / Eunos\",\n      \n      # District 15: Katong, Joo Chiat, Amber Road\n      \"42\" = \"Katong / Joo Chiat / Amber Road\",\n      \"43\" = \"Katong / Joo Chiat / Amber Road\",\n      \"44\" = \"Katong / Joo Chiat / Amber Road\",\n      \"45\" = \"Katong / Joo Chiat / Amber Road\",\n      \n      # District 16: Bedok, Upper East Coast, Eastwood, Kew Drive\n      \"46\" = \"Bedok / Upper East Coast / Eastwood / Kew Drive\",\n      \"47\" = \"Bedok / Upper East Coast / Eastwood / Kew Drive\",\n      \"48\" = \"Bedok / Upper East Coast / Eastwood / Kew Drive\",\n      \n      # District 17: Loyang, Changi\n      \"49\" = \"Loyang / Changi\",\n      \"50\" = \"Loyang / Changi\",\n      \"81\" = \"Loyang / Changi\",\n      \n      # District 18: Tampines, Pasir Ris\n      \"51\" = \"Tampines / Pasir Ris\",\n      \"52\" = \"Tampines / Pasir Ris\",\n      \n      # District 19: Serangoon Garden, Hougang, Punggol\n      \"53\" = \"Serangoon Garden / Hougang / Punggol\",\n      \"54\" = \"Serangoon Garden / Hougang / Punggol\",\n      \"55\" = \"Serangoon Garden / Hougang / Punggol\",\n      \"82\" = \"Serangoon Garden / Hougang / Punggol\",\n      \n      # District 20: Bishan, Ang Mo Kio\n      \"56\" = \"Bishan / Ang Mo Kio\",\n      \"57\" = \"Bishan / Ang Mo Kio\",\n      \n      # District 21: Upper Bukit Timah, Clementi Park, Ulu Pandan\n      \"58\" = \"Upper Bukit Timah / Clementi Park / Ulu Pandan\",\n      \"59\" = \"Upper Bukit Timah / Clementi Park / Ulu Pandan\",\n      \n      # District 22: Jurong\n      \"60\" = \"Jurong\",\n      \"61\" = \"Jurong\",\n      \"62\" = \"Jurong\",\n      \"63\" = \"Jurong\",\n      \"64\" = \"Jurong\",\n      \n      # District 23: Hillview, Dairy Farm, Bukit Panjang, Choa Chu Kang\n      \"65\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \"66\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \"67\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \"68\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \n      # District 24: Lim Chu Kang, Tengah\n      \"69\" = \"Lim Chu Kang / Tengah\",\n      \"70\" = \"Lim Chu Kang / Tengah\",\n      \"71\" = \"Lim Chu Kang / Tengah\",\n      \n      # District 25: Kranji, Woodgrove\n      \"72\" = \"Kranji / Woodgrove\",\n      \"73\" = \"Kranji / Woodgrove\",\n      \n      # District 26: Upper Thomson, Springleaf\n      \"77\" = \"Upper Thomson / Springleaf\",\n      \"78\" = \"Upper Thomson / Springleaf\",\n      \n      # District 27: Yishun, Sembawang\n      \"75\" = \"Yishun / Sembawang\",\n      \"76\" = \"Yishun / Sembawang\",\n      \n      # District 28: Seletar\n      \"79\" = \"Seletar\",\n      \"80\" = \"Seletar\"\n    )\n    \n    # Return the neighborhood name if valid, NULL if invalid\n    return(postcode_map[[postcode]])\n  }\n  \n  # Add the confirmation handler\n  show_postcode_confirmation <- function(postcode, neighborhood) {\n    session$sendCustomMessage('showPostcodeConfirmation', list(\n      postcode = postcode,\n      neighborhood = neighborhood\n    ))\n  }\n  \n  handle_pre_questionnaire_step <- function() {\n    pre_step <- rv$pre_step\n    \n    if (pre_step %in% c(1, 3, 5, 7, 9, 11)) {\n      # Intro screens - just advance\n      rv$pre_step <- rv$pre_step + 1L\n      session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n      return()\n      \n      \n    } else if (pre_step == 2) {\n      # Demographics\n      current_q_num <- length(rv$pre_answers$demographics) + 1\n      \n      # Demographics started_at when first question appears\n      if (current_q_num == 1L && is.na(rv$section_started_at$demographics)) {\n        rv$section_started_at$demographics <- Sys.time()\n      }\n      \n      q_names <- names(demographics_questions)\n      current_q_name <- q_names[current_q_num]\n      q_data <- demographics_questions[[current_q_name]]\n      \n      if (q_data$type == \"scale\") {\n        answer_index <- as.integer(input[[paste0(\"demo_\", current_q_name)]] %||% \"0\")\n        if (answer_index == 0) {\n          # Try to restore from buffer\n          buf_val <- rv$popped_answers$demographics[[current_q_name]]\n          if (!is.null(buf_val)) {\n            rv$pre_answers$demographics[[current_q_name]] <- buf_val\n            rv$popped_answers$demographics[[current_q_name]] <- NULL\n            answer_restored <- TRUE\n          } else {\n            showModal(modalDialog(title = \"Missing Answer\", \"Please provide an answer.\", easyClose = TRUE))\n            return()\n          }\n        } else {\n          answer_text <- q_data$options[answer_index]\n          rv$pre_answers$demographics[[current_q_name]] <- answer_text\n          rv$pre_q_completed$demographics[current_q_num] <- Sys.time()\n          \n          rv$popped_answers$demographics[[current_q_name]] <- NULL  # clear buffer\n          check_response_patterns()\n          \n          set_detailed_progress()  \n          \n        }\n      } else {\n        input_id <- paste0(\"demo_text_\", current_q_name)\n        answer <- trimws(input[[input_id]] %||% \"\")\n        \n        if (!nzchar(answer)) {\n          buf_val <- rv$popped_answers$demographics[[current_q_name]]\n          if (!is.null(buf_val)) {\n            rv$pre_answers$demographics[[current_q_name]] <- buf_val\n            rv$popped_answers$demographics[[current_q_name]] <- NULL\n          } else {\n            showModal(modalDialog(title = \"Missing Answer\", \"Please provide an answer.\", easyClose = TRUE))\n            return()\n          }\n        } else {\n          # Basic format validation\n          if (!grepl(\"^[0-9]{2}$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Postcode\", \"Please enter exactly 2 digits (numbers only).\", easyClose = TRUE))\n            return()\n          }\n          \n          # Check if it's a valid postcode\n          neighborhood <- validate_postcode(answer)\n          if (!is.null(neighborhood)) {\n            # Valid postcode - show confirmation\n            show_postcode_confirmation(answer, neighborhood)\n            return()  # Don't proceed until user confirms\n          } else {\n            # Invalid postcode - show error\n            showModal(modalDialog(\n              title = \"Unrecognized Postcode\", \n              paste(\"We don't recognize the postcode\", answer, \"in our system. Please double-check and enter the first two digits of your postcode.\"),\n              easyClose = TRUE\n            ))\n            return()\n          }\n        }\n      }\n      \n      \n      if (current_q_num < 4) {\n        # Clear inputs for next question\n        updateTextInput(session, \"current_answer\", value = \"\")\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = paste0('demo_', current_q_name)))\n      } else {\n        # Complete demographics - save and move to next\n        save_demographics_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))   \n        \n      }\n      \n    } else if (pre_step == 4) {\n      q_num <- length(rv$pre_answers$crt) + 1\n      input_id <- paste0(\"crt_text_q\", q_num)\n      \n      answer <- trimws(input[[input_id]] %||% \"\")\n      q_name <- paste0(\"q\", q_num)\n      \n      if (length(rv$pre_answers$crt) == 0L && is.na(rv$section_started_at$crt)) {\n        rv$section_started_at$crt <- Sys.time()\n      }\n      \n      # Enhanced validation by question with character limits\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$crt[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$crt[[q_name]] <- buf_val\n          rv$popped_answers$crt[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please provide an answer.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        # Character and content validation by question\n        if (q_num == 1) {  # Q1: single digit\n          if (nchar(answer) != 1) {\n            showModal(modalDialog(title = \"Invalid Length\", \"Please enter exactly 1 digit.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[0-9]$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter a single digit (0-9).\", easyClose = TRUE))\n            return()\n          }\n        } else if (q_num == 2) {  # Q2: single digit\n          if (nchar(answer) != 1) {\n            showModal(modalDialog(title = \"Invalid Length\", \"Please enter exactly 1 digit.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[0-9]$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter a single digit (0-9).\", easyClose = TRUE))\n            return()\n          }\n        } else if (q_num == 3) {  # Q3: Emily question - up to 10 characters, letters only\n          if (nchar(answer) > 10) {\n            showModal(modalDialog(title = \"Too Long\", \"Please enter 10 characters or fewer.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[A-Za-z]+$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter letters only (no numbers or symbols).\", easyClose = TRUE))\n            return()\n          }\n        } else if (q_num == 4) {  # Q4: up to 3 characters, digits only\n          if (nchar(answer) > 3) {\n            showModal(modalDialog(title = \"Too Long\", \"Please enter 3 characters or fewer.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[0-9]+$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter digits only.\", easyClose = TRUE))\n            return()\n          }\n        }\n        \n        rv$pre_answers$crt[[q_name]] <- answer\n        rv$pre_q_completed$crt[q_num] <- Sys.time()\n        rv$popped_answers$crt[[q_name]] <- NULL\n        check_response_patterns()\n        set_detailed_progress()\n      }\n      \n      if (q_num < 4) {\n        updateTextInput(session, \"current_answer\", value = \"\")\n      } else {\n        save_crt_data()\n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n      }\n    } else if (pre_step == 6) {\n      # GAAIS\n      answer <- input$gaais_q %||% \"\"\n      q_num <- length(rv$pre_answers$gaais) + 1\n      if (length(rv$pre_answers$gaais) == 0L && is.na(rv$section_started_at$gaais)) {\n        rv$section_started_at$gaais <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$gaais[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$gaais[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$gaais[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$gaais[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$gaais[q_num] <- Sys.time()\n        \n        rv$popped_answers$gaais[[q_name]] <- NULL  # clear buffer\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      \n      if (q_num < 21) {\n        # Reset scale selection\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'gaais_q'))\n      } else {\n        save_gaais_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))   \n        \n      }\n      \n    } else if (pre_step == 8) {\n      # FWA\n      answer <- input$fwa_q %||% \"\"\n      q_num <- length(rv$pre_answers$fwa) + 1\n      if (length(rv$pre_answers$fwa) == 0L && is.na(rv$section_started_at$fwa)) {\n        rv$section_started_at$fwa <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$fwa[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$fwa[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$fwa[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$fwa[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$fwa[q_num] <- Sys.time()\n        \n        rv$popped_answers$fwa[[q_name]] <- NULL  # clear buffer\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      if (q_num < 2) {\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'fwa_q'))\n      } else {\n        save_fwa_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))   \n        \n      }\n      \n    } else if (pre_step == 10) {\n      # TEIQue\n      answer <- input$teique_q %||% \"\"\n      q_num <- length(rv$pre_answers$teique) + 1\n      if (length(rv$pre_answers$teique) == 0L && is.na(rv$section_started_at$teique)) {\n        rv$section_started_at$teique <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$teique[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$teique[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$teique[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$teique[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$teique[q_num] <- Sys.time()\n        \n        rv$popped_answers$teique[[q_name]] <- NULL  # clear buffer\n        \n        # ADD THE ATTENTION CHECK HERE:\n        if (q_num == 31 && as.integer(answer) != 1) {\n          rv$attention_check_failed <- TRUE\n          show_blocking_warning(\n            title = \"Attention Check Failed\",\n            message = \"The previous question specifically asked you to select 'Completely Disagree' but you selected a different option. Please read all instructions carefully throughout the study.\",\n            duration = 15\n          )\n        }\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      \n      if (q_num < 31) {\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'teique_q'))\n      } else {\n        save_teique_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n        \n      }\n      \n    } else if (pre_step == 12) {\n      # MHLC - last questionnaire\n      answer <- input$mhlc_q %||% \"\"\n      q_num <- length(rv$pre_answers$mhlc) + 1\n      if (length(rv$pre_answers$mhlc) == 0L && is.na(rv$section_started_at$mhlc)) {\n        rv$section_started_at$mhlc <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$mhlc[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$mhlc[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$mhlc[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$mhlc[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$mhlc[q_num] <- Sys.time()\n        \n        rv$popped_answers$mhlc[[q_name]] <- NULL  # clear buffer\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      \n      if (q_num < 18) {\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'mhlc_q'))\n      } else {\n        save_mhlc_data()\n        \n        # After MHLC completion, move to vignette intro\n        rv$pre_step <- 13L  # Move to vignette intro\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))    \n        \n      }\n      \n    } else if (pre_step == 13) {\n      # 1) Generate vignettes with optional seed (only once, when starting vignettes)\n      seed_val <- suppressWarnings(as.integer(input$seed))\n      rv$vignettes <- generate_balanced_vignettes(\n        seed = if (!is.na(seed_val)) seed_val else NULL\n      )\n      \n      # 2) Switch to Vignette 1, Step 1\n      rv$current_vignette <- 1L\n      rv$vig_step <- 1L\n      \n      # 3) Record vignette start time (only once)\n      if (is.na(rv$vignette_started_at[1])) {\n        rv$vignette_started_at[1] <- Sys.time()\n      }\n      sync_question_vig_step()\n      \n    }\n  }\n  \n  \n  # Data compile for CSV:\n  compile_all_data <- function() {\n    tryCatch({\n      # Start with a copy of vignette data structure\n      all_data <- rv$responses\n      \n      # Get the exact column structure from rv$responses\n      template_row <- all_data[1, , drop = FALSE]\n      if (nrow(all_data) > 0) {\n        template_row[1, ] <- NA  # Clear the values but keep structure\n      } else {\n        # Create template if no vignette data exists\n        template_row <- data.frame(\n          participant_id = character(1),\n          vignette_number = integer(1),\n          provider = character(1),\n          severity = character(1),\n          advice_len = character(1),\n          q_take_advice = logical(1),\n          q_perceived_accuracy = integer(1),\n          q_trustworthiness = integer(1),\n          q_concern_condition = integer(1),\n          q_concern_circumstances = integer(1),\n          post_vignette_response = character(1),\n          started_at = as.POSIXct(character(1)),\n          submitted_at = as.POSIXct(character(1)),\n          stringsAsFactors = FALSE\n        )\n      }\n      \n      # Helper function to create rows with correct structure\n      create_pre_row <- function(q_type, q_name, response, started_time) {\n        new_row <- template_row\n        new_row$participant_id <- input$participant_id\n        new_row$vignette_number <- 0L  # Use 0 for pre-questionnaire\n        new_row$provider <- paste0(\"PRE_\", toupper(q_type))\n        new_row$severity <- paste0(toupper(q_type), \"_\", q_name)\n        new_row$advice_len <- toupper(q_type)\n        new_row$q_take_advice <- NA\n        new_row$q_perceived_accuracy <- NA_integer_\n        new_row$q_trustworthiness <- NA_integer_\n        new_row$q_concern_condition <- NA_integer_\n        new_row$q_concern_circumstances <- NA_integer_\n        new_row$post_vignette_response <- as.character(response)\n        new_row$started_at <- started_time\n        new_row$submitted_at <- started_time\n        return(new_row)\n      }\n      \n      # Add demographics data\n      if (length(rv$pre_answers$demographics) > 0) {\n        for (q_name in names(rv$pre_answers$demographics)) {\n          new_row <- create_pre_row(\"demographics\", q_name, \n                                    rv$pre_answers$demographics[[q_name]], \n                                    rv$section_started_at$demographics)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add CRT data\n      if (length(rv$pre_answers$crt) > 0) {\n        for (q_name in names(rv$pre_answers$crt)) {\n          new_row <- create_pre_row(\"crt\", q_name, \n                                    rv$pre_answers$crt[[q_name]], \n                                    rv$section_started_at$crt)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add GAAIS data\n      if (length(rv$pre_answers$gaais) > 0) {\n        for (q_name in names(rv$pre_answers$gaais)) {\n          new_row <- create_pre_row(\"gaais\", q_name, \n                                    rv$pre_answers$gaais[[q_name]], \n                                    rv$section_started_at$gaais)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add FWA data\n      if (length(rv$pre_answers$fwa) > 0) {\n        for (q_name in names(rv$pre_answers$fwa)) {\n          new_row <- create_pre_row(\"fwa\", q_name, \n                                    rv$pre_answers$fwa[[q_name]], \n                                    rv$section_started_at$fwa)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add TEIQue data (including attention check)\n      if (length(rv$pre_answers$teique) > 0) {\n        for (q_name in names(rv$pre_answers$teique)) {\n          new_row <- create_pre_row(\"teique\", q_name, \n                                    rv$pre_answers$teique[[q_name]], \n                                    rv$section_started_at$teique)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add MHLC data\n      if (length(rv$pre_answers$mhlc) > 0) {\n        for (q_name in names(rv$pre_answers$mhlc)) {\n          new_row <- create_pre_row(\"mhlc\", q_name, \n                                    rv$pre_answers$mhlc[[q_name]], \n                                    rv$section_started_at$mhlc)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      return(all_data)\n      \n    }, error = function(e) {\n      cat(\"Error in compile_all_data:\", e$message, \"\\n\")\n      return(rv$responses)  # Return original data if error\n    })\n  }\n  \n  # Screen UI\n  output$screenUI <- renderUI({\n    if (!rv$started) {\n      div(id = \"screen\", class=\"screen\",\n          div(class = \"title\", \"Welcome\"),\n          div(class = \"desc\",\n              \"Once you have clicked â€˜Start,â€™ you will begin the questionnaire experience. To navigate, you can click the on-screen buttons or use the keyboard: Hit Enter to continue, Shift+Enter to go back, Y/N for Yes and No, and the number keys for the corresponding selections.\"\n          ),\n          tagAppendAttributes(\n            textInput(\"participant_id\", NULL, \n                      placeholder = \"Participant ID (First and last name)\")\n          ),\n          textInput(\"seed\", NULL, placeholder = \"Optional randomisation seed\"),\n          textInput(\"sb_email\", NULL, placeholder = \"Supabase email (optional)\"),\n          passwordInput(\"sb_password\", NULL, \n                        placeholder = \"Supabase password (optional)\"),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_sb_login\", \n                           \"Sign in (Optional)\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_start\", \"Start\", class = \"btn btn-next\")\n              )\n          ),\n          div(class = \"footer\", \"\"),\n          # Admin - guarded by a passphrase to reveal controls\n          # Clickable bar that reveals the Admin Key + Unlock button\n          tags$a(\n            class = \"admin-toggle collapsed\",\n            `data-bs-toggle` = \"collapse\",\n            href = \"#adminKeyCollapse\",\n            role = \"button\",\n            `aria-expanded` = \"false\",\n            `aria-controls` = \"adminKeyCollapse\",\n            tags$span(class = \"chev\", HTML(\"&#9656;\")),  # â–º\n            \"Admin\"\n          ),\n          div(\n            id = \"adminKeyCollapse\",\n            class = \"collapse admin-guard-panel\",\n            div(class = \"label\", \"Enter Admin Key\"),\n            passwordInput(\"admin_key\", NULL, placeholder = \"Admin key\", width = \"260px\"),\n            actionButton(\"admin_unlock\", \"Unlock Admin\", class = \"btn btn-back\")\n          ),\n          \n          # Static tools panel (only shown after unlock)\n          uiOutput(\"adminPanel\")\n      )\n    } \n    \n    # Show pre-questionnaire (including pre_step 13 vignette splash) only before vignettes start\n    else if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 13) {\n      render_pre_questionnaire_screen()\n    }\n    \n    \n    else if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      v <- rv$vignettes[rv$current_vignette, ]\n      cond <- condition_text(v$severity)\n      prov_text <- provider_text(v$provider)\n      adv  <- advice_text(v$severity, v$advice_len)\n      bullets <- summary_bullets(v$severity)\n      icon <- provider_icon(v$provider)\n      \n      # Sticky summary appears from step 2 onward\n      sticky <- if (rv$vig_step >= 2L) {\n        div(class = \"sticky-summary\",\n            div(class = \"sticky-summary-title\", icon, cond$title),\n            tags$ul(class = \"sticky-summary-ul\",\n                    tags$li(bullets[1]),\n                    tags$li(bullets[2])\n            )\n        )\n      } else NULL\n      \n      # Step 1: Symptoms only\n      if (rv$vig_step == 1L) {\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4: \", cond$title)),\n            div(class = \"desc\", cond$description),\n            div(class = \"nav-actions\",\n                actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                div(class = \"nav-actions-right\",\n                    actionButton(\"btn_next\", \"Seek medical advice\", class = \"btn btn-next\")\n                )\n            )\n        )\n        \n        # Step 2: Reveal provider\n      } else if (rv$vig_step == 2L) {\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"Your case has been assigned.\"),\n                    div(class = \"desc\", prov_text),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Receive advice\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 3: Reveal advice\n      } else if (rv$vig_step == 3L) {\n        # Mark advice as \"long\" when it exceeds a threshold (adjust as needed)\n        is_long <- nchar(adv) > 500\n        \n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"Advice:\"),\n                    # Use \"desc long\" when is_long is TRUE, otherwise just \"desc\"\n                    div(class = if (is_long) \"desc long\" else \"desc\", adv),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Continue\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                if (!is_long) div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 4: Q1 Yes/No (Typeform boxes)\n      } else if (rv$vig_step == 4L) {\n        existing <- rv$answers[[rv$current_vignette]]$q1 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"I would be likely to take this advice, precisely as stated.\"),\n                    div(class = paste(\"scale-group\", \"scale-2\"), `data-input` = \"q1\",\n                        div(class = paste(\"scale-item\", if (!is.null(existing) && existing == \"Yes\") \"selected\"),\n                            `data-value` = \"Yes\", \"Yes\"\n                        ),\n                        div(class = paste(\"scale-item\", if (!is.null(existing) && existing == \"No\") \"selected\"),\n                            `data-value` = \"No\", \"No\"\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 5: Q2 (1..7) with end captions (Very inaccurate ... Very accurate)\n      } else if (rv$vig_step == 5L) {\n        existing <- rv$answers[[rv$current_vignette]]$q2 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"To me, the advice seemedâ€¦\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q2\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Very inaccurate\"),\n                            div(class = \"scale-caption-right\", \"Very accurate\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 6: Q3 (1..7) with end captions (Not trustworthy at all ... Completely trustworthy)\n      } else if (rv$vig_step == 6L) {\n        existing <- rv$answers[[rv$current_vignette]]$q3 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"I felt that the advice that I was given wasâ€¦\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q3\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Not trustworthy at all\"),\n                            div(class = \"scale-caption-right\", \"Completely trustworthy\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        \n        # Step 7: Q4 (1..7) Concern provider wouldn't recognize uniqueness of medical condition\n      } else if (rv$vig_step == 7L) {\n        existing <- rv$answers[[rv$current_vignette]]$q4 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"In this scenario, how concerned are you that this provider would not recognize the uniqueness of your medical condition?\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q4\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Not at all\"),\n                            div(class = \"scale-caption-right\", \"Very much\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 8: Q5 (1..7) Concern provider wouldn't recognize unique circumstances\n      } else if (rv$vig_step == 8L) {\n        existing <- rv$answers[[rv$current_vignette]]$q5 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"In this scenario, how concerned are you that this provider would not recognize your unique circumstances?\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q5\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Not at all\"),\n                            div(class = \"scale-caption-right\", \"Very much\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\",\n                                         if (rv$current_vignette < 4) \"Submit & Next Vignette\" else \"Submit & Finish\",\n                                         class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n      }\n    } else if (rv$current_vignette == 5 && rv$vig_step == 1) {\n      # Post-vignette question - open-ended\n      existing <- rv$post_vignette_answer\n      \n      # ADD AUTOFOCUS TRIGGER HERE\n      session$onFlushed(function() {\n        session$sendCustomMessage(\"autoFocusText\", TRUE)\n      }, once = TRUE)\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", \"Final Question\"),\n          div(class = \"label\", \"Did you prefer receiving advice from the doctor or the AI overall? If so, why did you prefer one or the other?\"),\n          textAreaInput(\n            inputId = \"post_q_text\",\n            label = NULL,\n            value = existing %||% \"\",\n            placeholder = \"Type your response here... (400 words maximum)\",\n            rows = 6,\n            width = \"100%\",\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", \"Submit & Finish\", class = \"btn btn-next\")\n              )\n          )\n      )\n    } else {\n      # Final\n      div(id = \"screen\", class=\"screen show\",\n          div(class = \"title\", \"Thank you\"),\n          div(class = \"desc\", \"You may download your responses or restart.\"),\n          downloadButton(\"download_csv\", \"Download Responses (CSV)\", class = \"btn btn-download\"),\n          actionButton(\"restart\", \"Restart\", class = \"btn btn-back\"),\n          div(class = \"footer\", \"Responses are saved remotely on Supabase. Click download to store your own copy.\")\n      )\n    }\n  })\n  outputOptions(output, \"screenUI\", suspendWhenHidden = FALSE)\n  outputOptions(output, \"progressUI\", suspendWhenHidden = FALSE)  # optional, keeps dots updating\n  \n  # Run once after the first render/flush (safe reactive read via isolate)\n  session$onFlushed(function() {\n    session$sendCustomMessage(\"enforceNextDisable\", isolate(rv$pre_step))\n  }, once = TRUE)\n  \n  # Run once after the first render/flush (safe reactive read via isolate)\n  session$onFlushed(function() {\n    session$sendCustomMessage(\"enforceVigNextDisable\", isolate(rv$vig_step))\n  }, once = TRUE)\n  \n  # sync question vig steps\n  \n  sync_question_vig_step <- function() {\n    session$sendCustomMessage('setCurrentVigStep', list(step = rv$vig_step))\n    \n    v <- rv$current_vignette\n    s <- rv$vig_step\n    \n    if (s == 4L) {\n      val <- rv$answers[[v]]$q1 %||% NULL\n      if (is.null(val) || !nzchar(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q1'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q1', value = as.character(val)))\n      }\n    } else if (s == 5L) {\n      val <- rv$answers[[v]]$q2 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q2'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q2', value = as.character(val)))\n      }\n    } else if (s == 6L) {\n      val <- rv$answers[[v]]$q3 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q3'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q3', value = as.character(val)))\n      }\n      \n    } else if (s == 7L) {  # NEW\n      val <- rv$answers[[v]]$q4 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q4'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q4', value = as.character(val)))\n      }\n    } else if (s == 8L) {  # NEW\n      val <- rv$answers[[v]]$q5 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q5'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q5', value = as.character(val)))\n      }\n    } else if (v == 5 && s == 1) {  # Post-vignette question\n      val <- rv$post_vignette_answer\n      if (is.null(val) || !nzchar(val)) {\n        # Clear the text area\n        updateTextAreaInput(session, \"post_q_text\", value = \"\")\n      } else {\n        # Pre-fill the text area\n        updateTextAreaInput(session, \"post_q_text\", value = val)\n      }\n    } else {\n      # Non-question steps\n      session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n      return()\n    }\n    \n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  }\n  \n  observeEvent(input$modal_enter_close, {\n    removeModal()\n  })\n  \n  # Skip to vignettes (bypass all pre-questionnaires)\n  observeEvent(input$btn_skip_pre, {\n    if (!isTRUE(rv$admin_unlocked)) return()\n    \n    # Validate participant ID is entered\n    id <- trimws(input$participant_id %||% \"\")\n    if (!nzchar(id)) {\n      showModal(modalDialog(\n        title = \"Missing Participant ID\",\n        \"Please enter a Participant ID first.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # SET THE SKIP FLAG\n    rv$admin_skip_used <- TRUE\n    \n    # Generate fake pre-questionnaire data\n    rv$pre_answers <- list(\n      demographics = list(\n        age = \"25-34\",\n        gender = \"Male\", \n        education = \"Bachelor's\",\n        postcode = \"12\"\n      ),\n      crt = list(\n        q1 = \"2\", q2 = \"8\", q3 = \"Emily\", q4 = \"0\"\n      ),\n      gaais = as.list(setNames(rep(3L, 21), paste0(\"q\", 1:21))),\n      fwa = list(q1 = 2L, q2 = 1L),\n      teique = as.list(setNames(rep(4L, 31), paste0(\"q\", 1:31))),\n      mhlc = as.list(setNames(rep(3L, 18), paste0(\"q\", 1:18)))\n    )\n    \n    # Set fake timestamps\n    fake_time <- Sys.time() - 300  # 5 minutes ago\n    rv$section_started_at <- list(\n      demographics = fake_time,\n      crt = fake_time + 60,\n      gaais = fake_time + 120,\n      fwa = fake_time + 180,\n      teique = fake_time + 240,\n      mhlc = fake_time + 300\n    )\n    \n    # Generate vignettes\n    seed_val <- suppressWarnings(as.integer(input$seed))\n    rv$vignettes <- generate_balanced_vignettes(\n      seed = if (!is.na(seed_val)) seed_val else NULL\n    )\n    \n    # Skip to vignettes\n    rv$started <- TRUE\n    rv$current_vignette <- 1L\n    rv$vig_step <- 1L\n    rv$pre_step <- 13L  # Completed\n    \n    # Record vignette start time\n    rv$vignette_started_at[1] <- Sys.time()\n    \n    # Update client state\n    session$sendCustomMessage('setCurrentVignette', list(vignette = 1))\n    session$sendCustomMessage('setCurrentVigStep', list(step = 1))\n    session$sendCustomMessage('setPreStep', list(step = 13))\n    \n    sync_question_vig_step()\n    set_detailed_progress()\n    \n    showNotification(\"Skipped to Vignette 1 with fake pre-questionnaire data.\", \n                     type = \"message\", duration = 4)\n  })\n  \n  # Skip to post-vignette question\n  observeEvent(input$btn_skip_to_post, {\n    if (!isTRUE(rv$admin_unlocked)) return()\n    \n    # Validate participant ID is entered\n    id <- trimws(input$participant_id %||% \"\")\n    if (!nzchar(id)) {\n      showModal(modalDialog(\n        title = \"Missing Participant ID\", \n        \"Please enter a Participant ID first.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # SET THE SKIP FLAG\n    rv$admin_skip_used <- TRUE\n    \n    # Generate fake pre-questionnaire data (same as above)\n    rv$pre_answers <- list(\n      demographics = list(age = \"25-34\", gender = \"Male\", education = \"Bachelor's\", postcode = \"12\"),\n      crt = list(q1 = \"2\", q2 = \"8\", q3 = \"Emily\", q4 = \"0\"),\n      gaais = as.list(setNames(rep(3L, 21), paste0(\"q\", 1:21))),\n      fwa = list(q1 = 2L, q2 = 1L),\n      teique = as.list(setNames(rep(4L, 31), paste0(\"q\", 1:31))),\n      mhlc = as.list(setNames(rep(3L, 18), paste0(\"q\", 1:18)))\n    )\n    \n    # Generate fake vignette data\n    seed_val <- suppressWarnings(as.integer(input$seed))\n    rv$vignettes <- generate_balanced_vignettes(\n      seed = if (!is.na(seed_val)) seed_val else NULL\n    )\n    \n    fake_time <- Sys.time() - 600  # 10 minutes ago\n    \n    # Generate fake vignette responses\n    for (i in 1:4) {\n      rv$answers[[i]] <- list(\n        q1 = sample(c(\"Yes\", \"No\"), 1),\n        q2 = sample(1:7, 1),\n        q3 = sample(1:7, 1), \n        q4 = sample(1:7, 1),\n        q5 = sample(1:7, 1)\n      )\n      \n      # Add fake response to database\n      v <- rv$vignettes[i, ]\n      row <- data.frame(\n        participant_id = id,\n        vignette_number = i,\n        provider = v$provider,\n        severity = v$severity,\n        advice_len = v$advice_len,\n        q_take_advice = rv$answers[[i]]$q1 == \"Yes\",\n        q_perceived_accuracy = as.integer(rv$answers[[i]]$q2),\n        q_trustworthiness = as.integer(rv$answers[[i]]$q3),\n        q_concern_condition = as.integer(rv$answers[[i]]$q4),\n        q_concern_circumstances = as.integer(rv$answers[[i]]$q5),\n        post_vignette_response = NA_character_,\n        started_at = fake_time + (i-1) * 120,\n        submitted_at = fake_time + i * 120,\n        stringsAsFactors = FALSE\n      )\n      rv$responses <- rbind(rv$responses, row)\n    }\n    \n    # Skip to post-vignette question\n    rv$started <- TRUE\n    rv$current_vignette <- 5L\n    rv$vig_step <- 1L\n    rv$pre_step <- 13L\n    \n    # Update client state\n    session$sendCustomMessage('setCurrentVignette', list(vignette = 5))\n    session$sendCustomMessage('setCurrentVigStep', list(step = 1))\n    \n    set_detailed_progress()\n    \n    showNotification(\"Skipped to post-vignette question with fake data.\", \n                     type = \"message\", duration = 4)\n  })\n  \n  # Supabase login handler\n  observeEvent(input$btn_sb_login, {\n    email <- trimws(input$sb_email %||% \"\")\n    password <- input$sb_password %||% \"\"\n    if (!nzchar(email) || !nzchar(password)) {\n      showModal(modalDialog(\n        title = \"Missing Credentials\",\n        \"Please enter both email and password to sign in to Supabase.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    tryCatch({\n      token <- supabase_sign_in(email, password)\n      rv$sb_access_token <- token$access_token\n      rv$sb_refresh_token <- token$refresh_token\n      rv$sb_expires_at    <- Sys.time() + as.numeric(token$expires_in)\n      rv$sb_user_email <- email\n      showNotification(\"Signed in to Supabase successfully.\", type = \"message\", duration = 4)\n    }, error = function(e) {\n      showModal(modalDialog(\n        title = \"Supabase Sign-in Error\",\n        paste(\"Could not sign in:\", e$message),\n        easyClose = TRUE\n      ))\n    })\n  })\n  \n  # Navigation: Start Button\n  \n  observeEvent(input$btn_start, {\n    id <- trimws(input$participant_id %||% \"\")\n    seed_input <- trimws(input$seed %||% \"\")\n    email_input <- trimws(input$sb_email %||% \"\")\n    password_input <- input$sb_password %||% \"\"\n    \n    # Validate input lengths\n    if (nchar(id) > 50) {\n      showModal(modalDialog(\n        title = \"Participant ID Too Long\",\n        \"Participant ID must be 50 characters or fewer.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    if (nchar(seed_input) > 10) {\n      showModal(modalDialog(\n        title = \"Seed Too Long\", \n        \"Seed must be 10 characters or fewer.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    if (nchar(email_input) > 100) {\n      showModal(modalDialog(\n        title = \"Email Too Long\",\n        \"Email must be 100 characters or fewer.\", \n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    if (nchar(password_input) > 50) {\n      showModal(modalDialog(\n        title = \"Password Too Long\",\n        \"Password must be 50 characters or fewer.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    \n    if (!nzchar(id)) {\n      showModal(modalDialog(\n        title = \"Missing Participant ID\",\n        \"Please enter a Participant ID to begin.\",\n        footer = tagList(modalButton(\"Dismiss\")),\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # Uniqueness check (as you already have)\n    exists <- FALSE\n    tryCatch({\n      exists <- supabase_pid_exists(id, access_token = rv$sb_access_token)\n    }, error = function(e) {\n      showModal(modalDialog(\n        title = \"Connectivity Issue\",\n        paste(\"Could not verify Participant ID uniqueness:\", e$message),\n        easyClose = TRUE\n      ))\n      return()\n    })\n    if (isTRUE(exists)) {\n      showModal(modalDialog(\n        title = \"Participant ID Already Used\",\n        \"It appears that you have already participated in the research. Thank you. If you have not, please enter a different Participant ID.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # Pre-questionnaires first\n    rv$started <- TRUE\n    rv$current_vignette <- 0L\n    rv$pre_step <- 1L\n    \n    # INFORM CLIENT OF CURRENT PRE STEP\n    session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n    \n    \n    session$onFlushed(function() {\n      session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n    }, once = FALSE)\n    \n    rv$last_dir <- \"forward\"\n    set_detailed_progress()\n    session$sendCustomMessage('enforceNextDisable', rv$pre_step)\n    \n    # Disable interior scrolling when leaving welcome screen\n    session$onFlushed(function() {\n      session$sendCustomMessage(\"disableInteriorScrolling\", NULL)\n    }, once = TRUE)\n  })\n  \n  ## observeEvent(input$btn_start_2, {\n  ##   id <- trimws(input$participant_id %||% \"\")\n  ##   seed_val <- suppressWarnings(as.integer(input$seed))\n  ##     rv$vignettes <- generate_balanced_vignettes(\n  ##  seed = if (!is.na(seed_val)) seed_val else NULL\n  ##     )\n  ## rv$started <- TRUE\n  ## rv$current_vignette <- 1L\n  ## rv$vig_step <- 1L\n  ##     \n  ## session$onFlushed(function() {\n  ## session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n  ## }, once = FALSE)\n  ##     \n  ## sync_question_vig_step()\n  ## # Record start time for vignette 1 when step 1 is first shown\n  ## if (is.na(rv$vignette_started_at[1])) {\n  ## rv$vignette_started_at[1] <- Sys.time()\n  ## }\n  ## rv$last_dir <- \"forward\"\n  ## set_detailed_progress()\n  ## session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  ## })\n  \n  \n  # Navigation: Start / Next\n  \n  observeEvent(input$btn_next, {\n    dir <- \"forward\"\n    \n    # NEW SECTION FOR PRE-QUESTIONNAIRES\n    if (rv$started && rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 13) {\n      handle_pre_questionnaire_step()\n      set_detailed_progress()\n      session$onFlushed(function() {\n        session$sendCustomMessage('cardApplySlideIn', NULL)\n      }, once = FALSE)\n      return()\n    }\n    \n    # Start flow\n    if (!rv$started) {\n      session$onFlushed(function() {\n        session$sendCustomMessage('focusPID', TRUE)\n      }, once = FALSE)\n      id <- trimws(input$participant_id %||% \"\")\n      if (!nzchar(id)) {\n        showModal(modalDialog(\n          title = \"Missing Participant ID\",\n          \"Please enter a Participant ID to begin.\",\n          easyClose = TRUE\n        ))\n        return()\n      }\n      \n      seed_val <- suppressWarnings(as.integer(input$seed))\n      rv$vignettes <- generate_balanced_vignettes(\n        seed = if (!is.na(seed_val)) seed_val else NULL\n      )\n      rv$started <- TRUE\n      rv$current_vignette <- 1L\n      rv$vig_step <- 1L\n      \n      session$onFlushed(function() {\n        session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n      }, once = FALSE)\n      \n      sync_question_vig_step()\n      # Record start time for vignette 1 when step 1 is first shown\n      if (is.na(rv$vignette_started_at[1])) {\n        rv$vignette_started_at[1] <- Sys.time()\n      }\n      rv$last_dir <- dir\n      set_detailed_progress()\n      session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n      \n    }\n    \n    # DEBUG: Always print current state\n    # cat(\"DEBUG: Current vignette:\", rv$current_vignette, \"VigStep:\", rv$vig_step, \"\\n\")\n    \n    # Handle post-vignette question FIRST - before any other conditions\n    if (rv$current_vignette == 5L && rv$vig_step == 1L) {\n      #  cat(\"DEBUG: In post-vignette handler\\n\")\n      post_q <- trimws(input$post_q_text %||% \"\")\n      #  cat(\"DEBUG: post_q value: '\", post_q, \"'\\n\")\n      \n      if (is.null(post_q) || !nzchar(trimws(post_q))) {\n        showModal(modalDialog(title = \"Incomplete Response\", \"Please provide an answer to the final question.\", easyClose = TRUE))\n        return()\n      }\n      \n      # Word count validation\n      word_count <- length(strsplit(post_q, \"\\\\s+\")[[1]])\n      if (word_count > 400) {\n        showModal(modalDialog(\n          title = \"Response Too Long\", \n          paste(\"Your response is\", word_count, \"words. Please shorten it to 400 words or fewer.\"), \n          easyClose = TRUE\n        ))\n        return()\n      }\n      \n      rv$post_vignette_answer <- post_q\n      \n      # Create post-vignette row\n      post_row <- data.frame(\n        participant_id = input$participant_id,\n        vignette_number = 99L,\n        provider = \"POST_VIGNETTE\",\n        severity = \"POST_VIGNETTE\", \n        advice_len = \"POST_VIGNETTE\",\n        q_take_advice = NA,\n        q_perceived_accuracy = NA,\n        q_trustworthiness = NA,\n        q_concern_condition = NA,\n        q_concern_circumstances = NA,\n        post_vignette_response = post_q,\n        started_at = Sys.time(),\n        submitted_at = Sys.time(),\n        stringsAsFactors = FALSE\n      )\n      \n      # DEBUG: Check what's in the row before sending\n      cat(\"DEBUG: post_row contents:\\n\")\n      print(post_row)\n      cat(\"DEBUG: post_vignette_response value:\", post_row$post_vignette_response, \"\\n\")\n      cat(\"DEBUG: JSON being sent:\", toJSON(post_row, auto_unbox = TRUE, na = \"null\"), \"\\n\")\n      \n      # Add to responses\n      rv$responses <- rbind(rv$responses, post_row)\n      cat(\"DEBUG: Added to responses, now has\", nrow(rv$responses), \"rows\\n\")\n      \n      # Check if we have access token\n      if (is.null(rv$sb_access_token)) {\n        cat(\"DEBUG: sb_access_token is NULL\\n\")\n      } else if (!nzchar(rv$sb_access_token)) {\n        cat(\"DEBUG: sb_access_token is empty string\\n\")\n      } else {\n        cat(\"DEBUG: sb_access_token exists, length:\", nchar(rv$sb_access_token), \"\\n\")\n      }\n      \n      # Save to Supabase\n      tryCatch({\n        cat(\"DEBUG: About to save post-vignette to Supabase\\n\")\n        ok <- save_to_supabase_auth(post_row, access_token = rv$sb_access_token)\n        if (isTRUE(ok)) {\n          showNotification(\"Post-vignette response saved to remote database.\", type = \"message\", duration = 4)\n          cat(\"DEBUG: Post-vignette saved to remote database successfully\\n\")\n        } else {\n          cat(\"DEBUG: Post-vignette Supabase save returned FALSE\\n\")\n        }\n      }, error = function(e) {\n        cat(\"DEBUG: Post-vignette Supabase error:\", e$message, \"\\n\")\n        showModal(modalDialog(\n          title = \"Supabase Save Error\", \n          paste(\"Error saving post-vignette response:\", e$message),\n          easyClose = TRUE\n        ))\n      })\n      \n      # Move to completion\n      rv$current_vignette <- 6L\n      rv$vig_step <- 0L\n      rv$last_dir <- dir\n      \n      set_detailed_progress()\n      session$onFlushed(function() {\n        session$sendCustomMessage('cardApplySlideIn', NULL)\n      }, once = FALSE)\n      session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n      return()\n    }\n    \n    # Regular vignette progression (steps 1-8)\n    # Regular vignette progression (steps 1-8)\n    if (rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      if (rv$vig_step %in% c(1L, 2L, 3L)) {\n        rv$vig_step <- rv$vig_step + 1L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # already present\n      } else if (rv$vig_step == 4L) {\n        q1 <- input$q1 %||% \"\"\n        if (!nzchar(q1)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select Yes or No.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q1 <- q1\n        \n        rv$vig_step <- 5L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q2 at step 5\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 5L) {\n        q2 <- input$q2 %||% \"\"\n        if (!nzchar(q2)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q2 <- as.integer(q2)\n        \n        rv$vig_step <- 6L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q3 at step 6\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 6L) {\n        q3 <- input$q3 %||% \"\"\n        if (!nzchar(q3)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q3 <- as.integer(q3)\n        \n        rv$vig_step <- 7L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q4 at step 7\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 7L) {\n        q4 <- input$q4 %||% \"\"\n        if (!nzchar(q4)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q4 <- as.integer(q4)\n        \n        rv$vig_step <- 8L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q5 at step 8\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 8L) {\n        # Last question of vignette\n        q5 <- input$q5 %||% \"\"\n        if (!nzchar(q5)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q5 <- as.integer(q5)\n        check_response_patterns() \n        \n        # Save vignette data\n        ans <- rv$answers[[rv$current_vignette]]\n        take_bool <- ans$q1 == \"Yes\"\n        v <- rv$vignettes[rv$current_vignette, ]\n        now <- Sys.time()\n        \n        row <- data.frame(\n          participant_id        = input$participant_id,\n          vignette_number       = rv$current_vignette,\n          provider              = v$provider,\n          severity              = v$severity,\n          advice_len            = v$advice_len,\n          q_take_advice         = take_bool,\n          q_perceived_accuracy  = as.integer(ans$q2),\n          q_trustworthiness     = as.integer(ans$q3),\n          q_concern_condition   = as.integer(ans$q4),\n          q_concern_circumstances = as.integer(ans$q5),\n          post_vignette_response = NA_character_,  \n          started_at            = rv$vignette_started_at[rv$current_vignette],\n          submitted_at          = now,\n          stringsAsFactors      = FALSE\n        )\n        rv$responses <- rbind(rv$responses, row)\n        \n        # Save to Supabase\n        if (!is.null(rv$sb_access_token) && nzchar(rv$sb_access_token)) {\n          tryCatch({\n            ok <- save_to_supabase_auth(row, access_token = rv$sb_access_token)\n            if (isTRUE(ok)) {\n              showNotification(sprintf(\"Saved vignette %d to remote database.\", rv$current_vignette), type = \"message\", duration = 4)\n            }\n          }, error = function(e) {\n            showModal(modalDialog(title = \"Supabase Save Error\", paste(\"Error:\", e$message), easyClose = TRUE))\n          })\n        }\n        \n        if (rv$current_vignette < 4L) {\n          # Next vignette\n          rv$current_vignette <- rv$current_vignette + 1L\n          rv$vig_step <- 1L\n          if (is.na(rv$vignette_started_at[rv$current_vignette])) {\n            rv$vignette_started_at[rv$current_vignette] <- Sys.time()\n          }\n          sync_question_vig_step()  # KEEP THIS: step 1 screen setup\n        } else {\n          # Go to post-vignette question\n          rv$current_vignette <- 5L\n          rv$vig_step <- 1L\n        }\n        rv$last_dir <- dir\n      }\n    }\n    \n    # Capture the current step and vignette BEFORE the onFlushed callback\n    current_vigstep_val <- rv$vig_step\n    current_vignette_val <- rv$current_vignette\n    \n    set_detailed_progress()\n    session$onFlushed(function() {\n      session$sendCustomMessage('cardApplySlideIn', NULL)\n      # Use the captured values instead of accessing reactive values\n      session$sendCustomMessage('setCurrentVigStep', list(step = current_vigstep_val))\n      session$sendCustomMessage('setCurrentVignette', list(vignette = current_vignette_val))\n    }, once = FALSE)\n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  })\n  \n  # Navigation: Back\n  observeEvent(input$btn_back, {\n    if (!rv$started) return()\n    dir <- \"back\"\n    \n    # ONLY block in pre-questionnaires (current_vignette == 0)\n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 12) {\n      if (rv$pre_step %in% c(3, 5, 7, 9, 11)) {\n        showNotification(\"Cannot go back to completed questionnaire.\", type = \"warning\", duration = 3)\n        return()\n      }\n    }\n    \n    \n    # Show notification when at the very beginning (vignette 1, step 1)\n    if (rv$current_vignette == 1L && rv$vig_step == 1L) {\n      showNotification(\"Already at the first step.\", type = \"message\", duration = 2)\n      return()\n    }\n    \n    # HANDLE BACK NAVIGATION WITHIN PRE-QUESTIONNAIRES\n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 12) {\n      \n      if (rv$pre_step == 2) {\n        # Demographics - go back within questions or to intro\n        current_q_num <- length(rv$pre_answers$demographics) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$demographics)[length(rv$pre_answers$demographics)]\n          last_val <- rv$pre_answers$demographics[[last_q]]\n          \n          # Save to buffer\n          rv$popped_answers$demographics[[last_q]] <- last_val\n          \n          \n          rv$pre_answers$demographics[[last_q]] <- NULL\n          \n          q_data   <- demographics_questions[[last_q]]\n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (q_data$type == \"scale\") {\n              idx <- match(last_val, q_data$options)\n              if (!is.na(idx)) {\n                session$sendCustomMessage(\n                  'prefillStepInputs',\n                  list(step = pre_step_val, id = paste0('demo_', last_q), value = as.character(idx))\n                )\n              }\n            } else {\n              updateTextInput(session, \"current_answer\", value = last_val %||% \"\")\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 1L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step))  \n          \n        }\n        \n      } else if (rv$pre_step == 4) {\n        current_q_num <- length(rv$pre_answers$crt) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$crt)[length(rv$pre_answers$crt)]\n          last_val <- rv$pre_answers$crt[[last_q]]\n          rv$popped_answers$crt[[last_q]] <- last_val\n          \n          rv$pre_answers$crt[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            updateTextInput(session, \"current_answer\", value = last_val %||% \"\")\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 3L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n          \n        }\n        \n      } else if (rv$pre_step == 6) {\n        current_q_num <- length(rv$pre_answers$gaais) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$gaais)[length(rv$pre_answers$gaais)]\n          last_val <- rv$pre_answers$gaais[[last_q]]  # integer 1..5\n          \n          rv$popped_answers$gaais[[last_q]] <- last_val\n          \n          rv$pre_answers$gaais[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'gaais_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 5L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n          \n        }\n        \n      } else if (rv$pre_step == 8) {\n        current_q_num <- length(rv$pre_answers$fwa) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$fwa)[length(rv$pre_answers$fwa)]\n          last_val <- rv$pre_answers$fwa[[last_q]]  # integer 1..5\n          rv$popped_answers$fwa[[last_q]] <- last_val\n          \n          rv$pre_answers$fwa[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'fwa_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 7L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n          \n        }\n        \n      } else if (rv$pre_step == 10) {\n        current_q_num <- length(rv$pre_answers$teique) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$teique)[length(rv$pre_answers$teique)]\n          last_val <- rv$pre_answers$teique[[last_q]]  # integer 1..7\n          rv$popped_answers$teique[[last_q]] <- last_val\n          \n          rv$pre_answers$teique[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'teique_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 9L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n          \n        }\n        \n      } else if (rv$pre_step == 12) {\n        current_q_num <- length(rv$pre_answers$mhlc) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$mhlc)[length(rv$pre_answers$mhlc)]\n          last_val <- rv$pre_answers$mhlc[[last_q]]  # integer 1..6\n          rv$popped_answers$mhlc[[last_q]] <- last_val\n          \n          rv$pre_answers$mhlc[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'mhlc_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 11L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step))  \n          \n        }\n      }\n      \n      rv$last_dir <- dir\n      set_detailed_progress()\n      session$onFlushed(function() {\n        session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n      }, once = FALSE)\n      session$sendCustomMessage('enforceNextDisable', rv$pre_step)\n      return()\n    }\n    \n    # VIGNETTE BACK NAVIGATION (restored)\n    if (rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      if (rv$vig_step > 1L) {\n        rv$vig_step <- rv$vig_step - 1L\n      } else if (rv$vig_step == 1L && rv$current_vignette > 1L) {\n        rv$current_vignette <- rv$current_vignette - 1L\n        rv$vig_step <- 6L\n      }\n    } else if (rv$current_vignette == 5L && rv$vig_step == 1L) {\n      # Go back to last step of last vignette\n      rv$current_vignette <- 4L\n      rv$vig_step <- 8L\n    } else if (rv$current_vignette == 6L) {\n      # Go back to post-vignette question\n      rv$current_vignette <- 5L\n      rv$vig_step <- 1L}\n    \n    # If we land on step 1 of a vignette, ensure its start time is set (only once)\n    if (rv$vig_step == 1L && rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      if (is.na(rv$vignette_started_at[rv$current_vignette])) {\n        rv$vignette_started_at[rv$current_vignette] <- Sys.time()\n      }\n    }\n    \n    rv$last_dir <- dir\n    set_detailed_progress()\n    sync_question_vig_step()\n    session$onFlushed(function() {\n      session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n    }, once = FALSE)\n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  })\n  \n  # CSV download\n  output$download_csv <- downloadHandler(\n    filename = function() {\n      paste0(\"complete_responses_\",\n             gsub(\"[^A-Za-z0-9_-]\", \"_\", input$participant_id %||% \"anon\"),\n             \".csv\")\n    },\n    content = function(file) {\n      tryCatch({\n        cat(\"Starting CSV compilation...\\n\")\n        all_data <- compile_all_data()\n        cat(\"Data compiled, rows:\", nrow(all_data), \"\\n\")\n        \n        if (nrow(all_data) > 0) {\n          # Fix Excel postcode issue on export\n          all_data$post_vignette_response <- ifelse(\n            grepl(\"DEMOGRAPHICS_postcode\", all_data$severity) & \n              grepl(\"^[0-9]{2}$\", all_data$post_vignette_response),\n            paste0(\"'\", all_data$post_vignette_response),\n            all_data$post_vignette_response\n          )\n          \n          write.csv(all_data, file, row.names = FALSE)\n          cat(\"CSV written successfully\\n\")\n        } else {\n          cat(\"No data to write, creating empty file\\n\")\n          write.csv(data.frame(message = \"No data available\"), file, row.names = FALSE)\n        }\n      }, error = function(e) {\n        cat(\"Error in download handler:\", e$message, \"\\n\")\n        write.csv(data.frame(\n          error = e$message,\n          vignette_rows = nrow(rv$responses),\n          demographics_answers = length(rv$pre_answers$demographics)\n        ), file, row.names = FALSE)\n      })\n    }\n  )\n  \n  # Restart\n  observeEvent(input$restart, {\n    rv$admin_skip_used <- FALSE\n    rv$started <- FALSE\n    rv$vignettes <- NULL\n    rv$current_vignette <- 0L\n    rv$pre_step <- 0L\n    rv$vig_step <- 0L\n    rv$answers <- vector(\"list\", 4)\n    rv$responses <- rv$responses[0, , drop = FALSE]\n    rv$last_dir <- \"forward\"\n    rv$sb_access_token <- NULL\n    rv$sb_user_email <- NULL\n    rv$post_vignette_answer <- NULL\n    \n    \n    # ADD THESE MISSING RESETS:\n    rv$pre_answers <- list(\n      demographics = list(),\n      crt = list(),\n      gaais = list(),\n      fwa = list(),\n      teique = list(),\n      mhlc = list()\n    )\n    \n    rv$popped_answers <- list(\n      demographics = list(), \n      crt = list(),\n      gaais = list(), \n      fwa = list(),\n      teique = list(), \n      mhlc = list()\n    )\n    \n    rv$pre_q_completed <- list(\n      demographics = numeric(),\n      crt = numeric(),\n      gaais = numeric(),\n      fwa = numeric(),\n      teique = numeric(),\n      mhlc = numeric()\n    )\n    \n    rv$section_started_at <- list(\n      demographics = as.POSIXct(NA_character_),\n      crt         = as.POSIXct(NA_character_),\n      gaais       = as.POSIXct(NA_character_),\n      fwa         = as.POSIXct(NA_character_),\n      teique      = as.POSIXct(NA_character_),\n      mhlc        = as.POSIXct(NA_character_)\n    )\n    \n    rv$completed_questionnaires <- character()\n    rv$vignette_started_at <- as.POSIXct(rep(NA_character_, 4))\n    \n    # Clear all input values\n    updateTextInput(session, \"participant_id\", value = \"\")\n    updateTextInput(session, \"seed\", value = \"\")\n    updateTextInput(session, \"sb_email\", value = \"\")\n    updateTextInput(session, \"sb_password\", value = \"\")\n    updateTextAreaInput(session, \"post_q_text\", value = \"\")\n    \n    # Reset client-side state\n    session$sendCustomMessage(\"setTopProgress\", 0)\n    session$sendCustomMessage('setPreStep', list(step = 0))\n    session$sendCustomMessage('setCurrentVignette', list(vignette = 0))\n    session$sendCustomMessage('setCurrentVigStep', list(step = 0))\n    \n    # Reset warning tracking\n    rv$warning_cooldowns <- list(\n      gaais_straightline = as.POSIXct(NA),\n      teique_straightline = as.POSIXct(NA),\n      mhlc_straightline = as.POSIXct(NA),\n      vignette_pattern = as.POSIXct(NA),\n      speed_warning = as.POSIXct(NA),\n      attention_check = as.POSIXct(NA)\n    )\n    rv$warning_shown <- list(\n      gaais_straightline = FALSE,\n      teique_straightline = FALSE,\n      mhlc_straightline = FALSE,\n      vignette_pattern = FALSE,\n      speed_warning = FALSE\n    )\n    \n    session$onFlushed(function() {\n      session$sendCustomMessage('focusPID', TRUE)\n    }, once = FALSE)\n  })\n  \n  # Initial transition/progress sync\n  observe({\n    set_detailed_progress()\n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n    if (exists(\"sync_question_vig_step\", inherits = FALSE)) sync_question_vig_step()\n    if (!rv$started) {\n      session$onFlushed(function() {\n        session$sendCustomMessage('focusPID', TRUE)\n      }, once = FALSE)\n    }\n  })\n  \n  \n  # attention checks\n  check_response_patterns <- function() {\n    \n    # SKIP ALL PATTERN DETECTION IF ADMIN SKIP WAS USED\n    if (isTRUE(rv$admin_skip_used)) {\n      return()\n    }\n    \n    # Helper function to check if warning is on cooldown\n    is_on_cooldown <- function(warning_type, cooldown_minutes = 10) {\n      last_warning <- rv$warning_cooldowns[[warning_type]]\n      if (is.na(last_warning)) return(FALSE)\n      \n      time_since <- as.numeric(difftime(Sys.time(), last_warning, units = \"mins\"))\n      return(time_since < cooldown_minutes)\n    }\n    \n    # Helper function to set cooldown\n    set_cooldown <- function(warning_type) {\n      rv$warning_cooldowns[[warning_type]] <- Sys.time()\n      rv$warning_shown[[warning_type]] <- TRUE\n    }\n    \n    # Check GAAIS for straight-lining (only once per session)\n    if (length(rv$pre_answers$gaais) >= 8 && \n        !rv$warning_shown$gaais_straightline && \n        !is_on_cooldown(\"gaais_straightline\")) {\n      \n      recent_gaais <- tail(unlist(rv$pre_answers$gaais), 8)\n      if (length(unique(recent_gaais)) <= 2) {\n        show_blocking_warning(\n          title = \"Response Pattern Detected\",\n          message = \"We've noticed you have been naughty and have been selecting similar responses to recent questions. Each question asks about different aspects of artificial intelligence. Please read each statement carefully before responding, as your genuine opinions help make this research valuable.\",\n          duration = 5\n        )\n        set_cooldown(\"gaais_straightline\")\n        return()\n      }\n    }\n    \n    # Check TEIQue for straight-lining (only once per session)\n    if (length(rv$pre_answers$teique) >= 10 && \n        !rv$warning_shown$teique_straightline && \n        !is_on_cooldown(\"teique_straightline\")) {\n      \n      recent_teique <- tail(unlist(rv$pre_answers$teique), 10)\n      if (length(unique(recent_teique)) == 1) {\n        show_blocking_warning(\n          title = \"Identical Responses Detected\", \n          message = \"We have noticed you have been naughty and have given the same response to the last 10 questions. People typically vary in their emotional intelligence responses. Please take your time to consider how each statement applies to you personally.\",\n          duration = 5\n        )\n        set_cooldown(\"teique_straightline\")\n        return()\n      }\n    }\n    \n    # Check MHLC for straight-lining (only once per session)\n    if (length(rv$pre_answers$mhlc) >= 8 && \n        !rv$warning_shown$mhlc_straightline && \n        !is_on_cooldown(\"mhlc_straightline\")) {\n      \n      recent_mhlc <- tail(unlist(rv$pre_answers$mhlc), 8)\n      if (length(unique(recent_mhlc)) <= 2) {\n        show_blocking_warning(\n          title = \"Response Pattern Detected\",\n          message = \"We noticed you have been naughty and have been selecting similar responses repeatedly. Please take a moment to read each health belief statement carefully, as people typically have varied opinions on these topics. Your thoughtful responses are important for our research.\",\n          duration = 5\n        )\n        set_cooldown(\"mhlc_straightline\")\n        return()\n      }\n    }\n    \n    # Check vignette responses for patterns (only once per session)\n    if (rv$current_vignette >= 3 && \n        !rv$warning_shown$vignette_pattern && \n        !is_on_cooldown(\"vignette_pattern\")) {\n      \n      # Check Q2 (accuracy) responses\n      q2_responses <- sapply(1:(rv$current_vignette-1), function(v) {\n        rv$answers[[v]]$q2\n      })\n      q2_responses <- q2_responses[!is.null(q2_responses)]\n      \n      # Check Q3 (trustworthiness) responses  \n      q3_responses <- sapply(1:(rv$current_vignette-1), function(v) {\n        rv$answers[[v]]$q3\n      })\n      q3_responses <- q3_responses[!is.null(q3_responses)]\n      \n      if ((length(q2_responses) >= 3 && length(unique(q2_responses)) == 1) ||\n          (length(q3_responses) >= 3 && length(unique(q3_responses)) == 1)) {\n        \n        show_blocking_warning(\n          title = \"Consider Each Scenario Independently\",\n          message = \"You've given identical ratings across different healthcare scenarios. Each scenario involves different conditions and providers. Please evaluate each piece of advice on its own merits.\",\n          duration = 5\n        )\n        set_cooldown(\"vignette_pattern\")\n        return()\n      }\n    }\n    \n    # Check for very fast responses (can repeat, but with cooldown)\n    if (length(rv$response_times) > 0 && !is_on_cooldown(\"speed_warning\", 5)) {\n      recent_times <- tail(unlist(rv$response_times), 5)\n      \n      # Very fast average\n      if (length(recent_times) >= 4 && mean(recent_times) < 1.5) {\n        show_blocking_warning(\n          title = \"Please Slow Down\",\n          message = \"You appear to be responding very quickly (less than 1.5 seconds per question). Quality research depends on thoughtful responses. Please take time to read and consider each question carefully.\",\n          duration = 5\n        )\n        set_cooldown(\"speed_warning\")\n        return()\n      }\n      \n      # Extremely fast individual responses\n      if (length(recent_times) >= 2 && any(recent_times < 0.8)) {\n        show_blocking_warning(\n          title = \"Response Too Fast\",\n          message = \"Some of your recent responses were given in less than a second. Please ensure you're reading each question completely before selecting your answer.\",\n          duration = 5\n        )\n        set_cooldown(\"speed_warning\")\n        return()\n      }\n    }\n  }\n  \n  # Add this helper function to your server:\n  is_on_cooldown <- function(warning_type, cooldown_minutes = 10) {\n    last_warning <- rv$warning_cooldowns[[warning_type]]\n    if (is.na(last_warning)) return(FALSE)\n    \n    time_since <- as.numeric(difftime(Sys.time(), last_warning, units = \"mins\"))\n    return(time_since < cooldown_minutes)\n  }\n  \n  # Handle postcode confirmation\n  observeEvent(input$postcode_confirmed, {\n    # User confirmed the postcode is correct - proceed to next question\n    current_q_num <- length(rv$pre_answers$demographics) + 1\n    q_names <- names(demographics_questions)\n    current_q_name <- q_names[current_q_num]\n    \n    # Get the postcode value\n    input_id <- paste0(\"demo_text_\", current_q_name)\n    postcode_value <- trimws(input[[input_id]] %||% \"\")\n    \n    # Save the confirmed postcode\n    excel_postcode <- paste0(\"'\", postcode_value)\n    rv$pre_answers$demographics[[current_q_name]] <- postcode_value\n    \n    rv$pre_q_completed$demographics[current_q_num] <- Sys.time()\n    rv$popped_answers$demographics[[current_q_name]] <- NULL\n    \n    # Proceed with normal flow\n    if (current_q_num < 4) {\n      session$sendCustomMessage('resetPreStepInputs', list(step = rv$pre_step, id = paste0('demo_', current_q_name)))\n    } else {\n      save_demographics_data()\n      rv$pre_step <- rv$pre_step + 1L\n      session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n    }\n    \n    set_detailed_progress()\n  })\n  \n  # Handle postcode rejection  \n  observeEvent(input$postcode_rejected, {\n    # User wants to correct - just clear the input and let them re-enter\n    current_q_num <- length(rv$pre_answers$demographics) + 1\n    q_names <- names(demographics_questions)\n    current_q_name <- q_names[current_q_num]\n    input_id <- paste0(\"demo_text_\", current_q_name)\n    \n    # Clear the input\n    updateTextInput(session, input_id, value = \"\")\n    \n    # Focus back on the input\n    session$onFlushed(function() {\n      session$sendCustomMessage(\"autoFocusText\", TRUE)\n    }, once = TRUE)\n  })\n  \n  # Auto-refresh ~5 minutes before expiry\n  observe({\n    invalidateLater(60 * 1000, session)\n    if (!is.null(rv$sb_expires_at) && !is.null(rv$sb_refresh_token)) {\n      if (difftime(rv$sb_expires_at, Sys.time(), units = \"mins\") < 5) {\n        try({\n          rt <- supabase_refresh_token(rv$sb_refresh_token)\n          rv$sb_access_token <- rt$access_token\n          rv$sb_expires_at   <- Sys.time() + as.numeric(rt$expires_in)\n          message(\"Machine user token refreshed.\")\n        }, silent = TRUE)\n      }\n    }\n  })\n  \n}\n\n\n\nshinyApp(ui, server)","type":"text"},{"name":"app.R.template","content":"# app.R\nlibrary(shiny)\nlibrary(bslib)\nlibrary(htmltools)\nlibrary(httr)\nlibrary(jsonlite)\n\n# -----------------------------\n# Supabase configuration\n# -----------------------------\n\n# Resolve envs into R variables (single source of truth)\nSUPABASE_URL <- \"SUPABASE_URL_PLACEHOLDER\"\nSUPABASE_KEY <- \"SUPABASE_KEY_PLACEHOLDER\"\nSUPABASE_TABLE <- \"SUPABASE_TABLE_PLACEHOLDER\"\nAPP_EMAIL <- \"APP_EMAIL_PLACEHOLDER\"\nAPP_PASSWORD <- \"APP_PASSWORD_PLACEHOLDER\"\n\n# Sign in with password grant (server-side)\nsupabase_sign_in <- function(email, password) {\n  url <- paste0(SUPABASE_URL, \"/auth/v1/token?grant_type=password\")\n  res <- POST(\n    url,\n    add_headers(`apikey` = SUPABASE_KEY, `Content-Type` = \"application/json\"),\n    body = toJSON(list(email = email, password = password), auto_unbox = TRUE)\n  )\n  status <- status_code(res)\n  txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n  if (status >= 200 && status < 300) {\n    fromJSON(txt)\n  } else {\n    stop(sprintf(\"Supabase sign-in failed (%s): %s\", status, txt))\n  }\n}\n\n# Refresh token\nsupabase_refresh_token <- function(refresh_token) {\n  url <- paste0(SUPABASE_URL, \"/auth/v1/token?grant_type=refresh_token\")\n  res <- POST(\n    url,\n    add_headers(`apikey` = SUPABASE_KEY, `Content-Type` = \"application/json\"),\n    body = toJSON(list(refresh_token = refresh_token), auto_unbox = TRUE)\n  )\n  status <- status_code(res)\n  txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n  if (status >= 200 && status < 300) {\n    out <- fromJSON(txt)\n    list(access_token = out$access_token, expires_in = out$expires_in)\n  } else {\n    stop(sprintf(\"Supabase token refresh failed (%s): %s\", status, txt))\n  }\n}\n\n# Save to Supabase with Authorization: Bearer <token>\n\n\nsave_to_supabase_auth <- function(row, access_token, return_representation = TRUE) {\n  stopifnot(nzchar(access_token))\n  url <- paste0(SUPABASE_URL, \"/rest/v1/\", SUPABASE_TABLE)\n  \n  # UTC formatting for POSIXct columns - FIXED VERSION\n  for (i in seq_along(row)) {\n    if (inherits(row[[i]], \"POSIXct\")) {\n      row[[i]] <- strftime(as.POSIXct(row[[i]], tz = \"UTC\"), \"%Y-%m-%dT%H:%M:%SZ\", tz = \"UTC\")\n    }\n  }\n  \n  prefer_val <- if (isTRUE(return_representation)) \"return=representation\" else \"return=minimal\"\n  \n  headers <- add_headers(\n    `apikey`          = SUPABASE_KEY,\n    `Authorization`   = paste(\"Bearer\", access_token),\n    `Content-Type`    = \"application/json\",\n    `Accept`          = \"application/json\",\n    `Prefer`          = prefer_val,\n    `Content-Profile` = \"public\",\n    `Accept-Profile`  = \"public\"\n  )\n  \n  # Debug what's actually being sent\n  json_body <- toJSON(row, auto_unbox = TRUE, na = \"null\")\n  cat(\"DEBUG: Final JSON body:\", json_body, \"\\n\")\n  \n  res <- POST(url, headers, body = json_body)\n  status <- status_code(res)\n  txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n  \n  cat(\"DEBUG: Supabase response status:\", status, \"\\n\")\n  cat(\"DEBUG: Supabase response:\", txt, \"\\n\")\n  \n  if (status >= 200 && status < 300) {\n    TRUE\n  } else {\n    stop(sprintf(\"Supabase insert failed (%s): %s\", status, txt))\n  }\n}\n\nsupabase_pid_exists <- function(pid, access_token = NULL) {\n  stopifnot(nzchar(SUPABASE_URL), nzchar(SUPABASE_KEY))\n  # Build endpoint: return at most 1 row for this pid\n  base <- paste0(SUPABASE_URL, \"/rest/v1/\", SUPABASE_TABLE)\n  url  <- httr::modify_url(\n    base,\n    query = list(\n      participant_id = paste0(\"eq.\", pid),\n      select = \"participant_id\",\n      limit  = 1\n    )\n  )\n  # Headers\n  hdrs <- httr::add_headers(\n    `apikey`         = SUPABASE_KEY,\n    `Accept`         = \"application/json\",\n    `Accept-Profile` = \"public\"\n  )\n  if (!is.null(access_token) && nzchar(access_token)) {\n    hdrs <- httr::add_headers(\n      `apikey`         = SUPABASE_KEY,\n      `Accept`         = \"application/json\",\n      `Accept-Profile` = \"public\",\n      `Authorization`  = paste(\"Bearer\", access_token)\n    )\n  }\n  \n  res <- httr::GET(url, hdrs)\n  status <- httr::status_code(res)\n  if (status >= 200 && status < 300) {\n    txt <- httr::content(res, as = \"text\", encoding = \"UTF-8\")\n    if (!nzchar(txt)) return(FALSE)\n    dat <- jsonlite::fromJSON(txt)\n    # dat can be a dataframe or list; treat any non-empty result as \"exists\"\n    return(NROW(dat) >= 1)\n  } else {\n    # If the check fails (network, auth), propagate an error so caller can handle\n    txt <- httr::content(res, as = \"text\", encoding = \"UTF-8\")\n    stop(sprintf(\"Supabase check failed (%s): %s\", status, txt))\n  }\n}\n# -----------------------------\n# Vignette generators and text\n# -----------------------------\ngenerate_balanced_vignettes <- function(seed = NULL) {\n  if (!is.null(seed)) set.seed(seed)\n  pick <- data.frame(\n    provider   = c(\"Doctor\",\"Doctor\",\"AI\",\"AI\"),\n    severity   = c(\"Low\",\"High\",\"Low\",\"High\"),\n    advice_len = c(\"Brief\",\"Long\",\"Long\",\"Brief\"),\n    stringsAsFactors = FALSE\n  )\n  pick <- pick[sample(1:4), ]\n  pick$vignette_id <- seq_len(4)\n  pick\n}\n\ncondition_text <- function(severity) {\n  if (severity == \"Low\") {\n    list(\n      title = \"Skin Rash\",\n      description = paste(\n        \"Imagine that over the past two days, you have found that you have developed a red rash on your upper left forearm. While it is unpleasantly itchy and unsightly, you are glad that it does not seem to be spreading. Moreover, aside from the rash itself, you feel fine and are not experiencing any other symptoms. Specifically, you do not have a fever and there is no blistering.\"\n      )\n    )\n  } else {\n    list(\n      title = \"Chest Pain\",\n      description = paste(\n        \"Imagine that about 30 minutes ago while you were sitting on your couch at home resting and reading, you suddenly started feeling a tightness in your chest that feels like a heavy pressure positioned right in the centre of your chest. This sensation has not gone away, and you are also finding it difficult to breathe. In addition, you have observed that you are sweating more than normal.\"\n      )\n    )\n  }\n}\n\nprovider_text <- function(provider) {\n  if (provider == \"Doctor\") {\n    \"You have been directed to be consulted by a human clinician (a licensed medical doctor). The following advice has been provided by Dr. Tan Wei Min, MBBS (Family Medicine). [ðŸ‘¨â€âš•ï¸]\"\n  } else {\n    \"You have been directed to be consulted by an AI system designed to provide medical guidance. The following advice has been provided by HealthAI Virtual Clinician (LLM-v4). [ðŸ¤–]\"\n  }\n}\n\nadvice_text <- function(severity, advice_len) {\n  if (severity == \"Low\" && advice_len == \"Brief\") {\n    paste(\n      \"Based on your description, this presentation is consistent with simple contact or irritant dermatitis. Lukewarm short showers and using a bland moisturizer at least twice daily are recommended. Avoid known irritants and allergens. Continue to monitor the rash for the next week and watch for signs of infection (pus, honey-colored crusts, increasing pain, and fever) and seek care if present. If this does not improve after a week or two, arrange for a visit to a dermatologist.\"\n    )\n  } else if (severity == \"Low\" && advice_len == \"Long\") {\n    paste(\n      \"Based on your description, this presentation is consistent with simple contact or irritant dermatitis. Lukewarm short showers and using a bland moisturizer at least twice daily are recommended. Avoid known irritants and allergens. Continue to monitor the rash for the next week and watch for signs of infection (pus, honey-colored crusts, increasing pain, and fever) and seek care if present. If this does not improve after a week or two, arrange for a visit to a dermatologist.\", \n      \n      \"The guidance that was provided is consistent with the recommendations made by dermatology groups (including the American Academy of Dermatology) and the Singapore Ministry of Health primary-care guidelines for simple localized rashes. Atopic eczema has a prevalence rate in adults of about 10% and contact dermatitis is common, while serious systemic causes are uncommon in outpatient cohorts (<1%). Therefore, in the absence of danger signs (spreading redness, severe pain, warmth/swelling, fever), the recommended course of action is self-management.\", \n      \n      \"If symptoms do not improve over time, it is recommended to review recent potential exposures (including soaps, detergents, cosmetics, metals) and ask for patch testing.\",\n      sep = \"\\n\\n\"\n    )\n  } else if (severity == \"High\" && advice_len == \"Brief\") {\n    paste(\n      \"Based on your symptoms, this may be a time-sensitive emergency. Do not wait - call 995 or go to the nearest emergency department immediately. Do not drive yourself; use an ambulance or get assistance. If symptoms worsen, stay on the line with emergency services and keep them updated. While waiting, stop activity, sit or lie with head elevated, avoid food and drink, and have a list of your medications, known conditions, and allergies to hand.  \"\n    )\n  } else {\n    paste(\n      \"Based on your symptoms, this may be a time-sensitive emergency. Do not wait - call 995 or go to the nearest emergency department immediately. Do not drive yourself; use an ambulance or get assistance. If symptoms worsen, stay on the line with emergency services and keep them updated. While waiting, stop activity, sit or lie with head elevated, avoid food and drink, and have a list of your medications, known conditions, and allergies to hand.\",  \n      \n      \"This guidance follows widely accepted emergency and cardiology recommendations, including those developed by the American Heart Association and the Singapore Ministry of Health. Chest tightness with sweating and shortness of breath are warning signs of possible heart or lung emergencies, including heart attacks. In such cases, timing is of the essence because prompt treatment can restore blood flow, prevent damage, and reduce the risk death. Although many causes of chest pain are non-cardiac in nature, urgent testing is nevertheless recommended as emergency assessment can shorten time-to-treatment by 5-15%.\", \n      \n      \"After emergency evaluation and any treatment, it is recommended to arrange a follow up with a primary care practitioner or a cardiologist within a week to examine findings, medications, and any recommended further testing. Seek urgent care if chest pain or tightness recurs, if symptoms worsen, you feel faint, or you experience a new shortness of breath.\",\n      sep = \"\\n\\n\"\n    )\n  }\n}\n\nsummary_bullets <- function(severity) {\n  if (severity == \"Low\") {\n    c(\"Localised itchy rash, not spreading\", \"No fever or blistering; otherwise well\")\n  } else {\n    c(\"Chest tightness with sweating\", \"Shortness of breath; persistent symptoms\")\n  }\n}\n\n# Provider icon (emoji or simple symbol)\nprovider_icon <- function(provider) {\n  if (provider == \"Doctor\") {\n    tags$span(class = \"sticky-provider-icon\", \"ðŸ‘¨â€âš•ï¸\")\n  } else {\n    tags$span(class = \"sticky-provider-icon\", \"ðŸ¤–\")\n  }\n}\n\n# -----------------------------\n# Theme and CSS (Typeform-inspired)\n# -----------------------------\ntheme <- bs_theme(\n  version = 5,\n  bootswatch = \"flatly\",\n  base_font = \"'TWKLausanne 400', Arial, sans-serif\",\n  heading_font = \"'Tobias', Arial, sans-serif\",\n  primary = \"#6C5CE7\"\n)\n\ncss <- \"\n/* Fonts */\n@font-face {\n  font-family: 'TWKLausanne 400';\n  src: url('https://cdn.prod.website-files.com/66ffe2174aa8e8d5661c2708/683ffc9a2aa1aa6187af000c_TWKLausanne-400.woff') format('woff');\n  font-weight: 400; font-style: normal; font-display: swap;\n}\n@font-face {\n  font-family: 'Tobias';\n  src: url('https://cdn.prod.website-files.com/66ffe2174aa8e8d5661c2708/67f7e38acef4cde59aad2dbe_Tobias-Regular.woff2') format('woff2');\n  font-weight: 400; font-style: normal; font-display: swap;\n}\n\n/* Base */\nhtml, body { background: #0f172a; color: #e5e7eb;}\n.fullscreen { display: flex; align-items: center; justify-content: center; padding: 4vh 4vw; }\n\n/* Desktop only: allow the outer card to scroll */\n@media (min-width: 769px) {\n\n    html, body { height: 100%;}\n    .fullscreen { min-height: 100vh; }\n    .card {\n          max-height: calc(100vh - 8vh);\n          overflow-y: auto;\n          }\n  #screen { overflow-y: auto; -webkit-overflow-scrolling: touch; }\n}\n\n.modal-content { background: #0f172a; color: #e5e7eb; }\n.modal-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; font-family: Tobias; color: #E7E393; }\n.modal-body, .footer  { font-size: 16px; color: #E8D7F1; margin-bottom: 20px; line-height: 1.6; font-family: Arial, sans-serif; }\n.footer {margin-top: 20px;}\n.admin-panel {color: #e5e7eb}\n\n/* Card canvas */\n.card {\n  width: min(960px, 92vw);\n  background: rgba(17,24,39,0.72);\n  border-radius: 18px;\n  backdrop-filter: blur(12px);\n  box-shadow: 0 24px 48px rgba(0,0,0,0.35);\n  padding: 32px 36px; position: relative;\n}\n\n/* Top progress */\n.top-progress { position: absolute; top: 0; left: 0; height: 4px; width: 100%; overflow: hidden; }\n.top-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #6C5CE7, #00D4FF); transition: width .35s ease; }\n\n/* Typo */\n.title { font-size: 28px; font-weight: 800; margin-bottom: 8px; font-family: Tobias; color: #E7E393; }\n.desc  { font-size: 16px; color: #E8D7F1; margin-bottom: 20px; line-height: 1.6; font-family: Arial, sans-serif; white-space: pre-line; overflow-wrap: anywhere; }\n.label { font-weight: 600; color: #E8D7F1; margin: 10px 0 8px; }\n\n.shiny-input-text, .shiny-input-password { font-family: Arial, sans-serif; }\n\n/* Dots */\n.progress-dots { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }\n.dot { width: 10px; height: 10px; border-radius: 50%; background: #334155; transition: transform .25s, background .25s; }\n.dot.active { background: #6C5CE7; transform: scale(1.2); }\n.dot.done   { background: #2EC4B6; }\n\n/* Inputs */\ntextarea.form-control {\n  background: rgba(2,6,23,0.6); color: #e5e7eb; border: 1px solid #334155;\n  border-radius: 12px; padding: 12px; min-height: 140px;\n}\ntextarea.form-control::placeholder { color: #64748b; }\ntextarea.form-control:focus { outline: none; box-shadow: 0 0 0 2px #6C5CE7; border-color: transparent; }\n.shiny-options-group { color: #E8D7F1; }\n\n/* Buttons */\n.btn {\n  border: none; border-radius: 12px; padding: 12px 18px; font-weight: 700;\n  transition: filter .18s; font-family: Arial, sans-serif;\n}\n.btn:hover { filter: brightness(1.08); }\n.btn-next { background: #2EC4B6; color: #0b1020; }\n.btn-back { background: #6C5CE7; color: #e5e7eb; }\n.btn-download { background: #2EC4B6; color: #0b1020; margin-bottom:10px;}\n#restart {margin-bottom:10px;}\n.btn.disabled, .btn:disabled { opacity: 0.6; cursor: not-allowed; }\n.nav-actions { display: flex; gap: 12px; justify-content: space-between; margin-top: 16px; }\n.nav-actions-right { display: flex; gap: 12px; }\n\n/* Override Bootstrap variables for specific buttons */\n.btn.btn-next {\n  --bs-btn-bg: #10b981;\n  --bs-btn-color: #0b1020;\n  --bs-btn-hover-bg: #00F5F2 !important;\n  --bs-btn-hover-color: #ffffff;\n  --bs-btn-border-color: transparent;\n  --bs-btn-hover-border-color: transparent;\n  --bs-btn-focus-shadow-rgb: 16,185,129;\n  --bs-btn-active-bg: #0f9e9b;\n  --bs-btn-active-border-color: transparent;\n}\n.btn.btn-back {\n  --bs-btn-bg: #475569;\n  --bs-btn-color: #e5e7eb;\n  --bs-btn-hover-bg: #A79EFF !important;\n  --bs-btn-hover-color: #e5e7eb !important;\n  --bs-btn-border-color: transparent;\n  --bs-btn-hover-border-color: transparent;\n  --bs-btn-focus-shadow-rgb: 71,85,105;\n  --bs-btn-active-bg: #2b3443;\n  --bs-btn-active-border-color: transparent;\n}\n.btn.btn-download {\n  --bs-btn-bg: #00D4FF;\n  --bs-btn-color: #0b1020;\n  --bs-btn-hover-bg: #00F5F2 !important;\n  --bs-btn-hover-color: #ffffff;\n  --bs-btn-border-color: transparent;\n  --bs-btn-hover-border-color: transparent;\n  --bs-btn-focus-shadow-rgb: 0,212,255;\n  --bs-btn-active-bg: #08a8c3;\n  --bs-btn-active-border-color: transparent;\n}\n\n/* Modals: harmonise default button */\n.modal-content .modal-footer .btn.btn-default {\n  background-color: #6C5CE7 !important; color: #ffffff !important; border-color: transparent !important;\n}\n.modal-content .modal-footer .btn.btn-default:hover {\n  background-color: #A79EFF !important; color: #ffffff !important; border-color: transparent !important;\n}\n.modal-content .modal-footer .btn:hover { filter: none !important; transform: none !important; }\n\n/* Typeform scales */\n.scale-group { display: grid; gap: 12px; }\n.scale-2 { grid-template-columns: repeat(2, minmax(80px, 1fr)); }\n.scale-3 { grid-template-columns: repeat(3, minmax(80px, 1fr)); }\n.scale-5 { grid-template-columns: repeat(5, minmax(44px, 1fr)); }\n.scale-6 { grid-template-columns: repeat(6, minmax(44px, 1fr)); }\n.scale-7 { grid-template-columns: repeat(7, minmax(44px, 1fr)); }\n\n.scale-item {\n  background: rgba(17,24,39,0.6); border: 1px solid #334155; color: #E8D7F1;\n  border-radius: 12px;   padding: clamp(6px, 1.6vw, 14px) clamp(4px, 1.2vw, 12px); text-align: center; font-weight: 700;\n  user-select: none; cursor: pointer; transition: background .18s, border-color .18s;\n  box-sizing: border-box; font-size: clamp(12px, 2vw, 16px); min-width: 0; ;\n\n}\n.main-pane { min-width: 0; }  /* ensures grid can compress inside pane */\n.scale-item:hover { background: rgba(99,102,241,0.18); border-color: #6C5CE7; }\n.scale-item.selected { background: #6C5CE7; border-color: #6C5CE7; color: #0b1020; }\n.scale-item:focus { outline: 2px solid #6C5CE7; outline-offset: 2px; }\n\n/* 2-flash animation */\n@keyframes tf-flash-twice {\n  0% { background-color: #6C5CE7; box-shadow: 0 0 0 0 rgba(108,92,231,0.00); }\n  50% { background-color: #9E8CFF; box-shadow: 0 0 0 10px rgba(158,140,255,0.25); }\n  100% { background-color: #6C5CE7; box-shadow: 0 0 0 0 rgba(108,92,231,0.00); }\n}\n.scale-item.flash { animation: tf-flash-twice 400ms ease-in-out 2 alternate; }\n\n/* Sticky summary (desktop by default, mobile collapses to one column) */\n.sticky-summary {\n  background: rgba(17,24,39,0.72);\n  border: 1px solid #334155;\n  border-radius: 12px;\n  padding: 12px 14px;\n  backdrop-filter: blur(8px);\n  box-shadow: 0 12px 24px rgba(0,0,0,0.30);\n  color: #E8D7F1;\n}\n.sticky-summary-title { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 18px; color: #E7E393; }\n\n.sticky-summary-ul    { margin: 10px 0 0; padding-left: 18px; font-size: 13px; line-height: 1.4; }\n.sticky-provider-icon { font-size: 24px; line-height: 1; }\n\n/* Screen content layout: mobile first single column */\n.screen-content { display: block; }\n.main-pane { min-width: 0; } /* allow text to wrap in grid/flex */\n\n\n/* Very small phones */\n@media (max-width: 480px) {\n  .full-screen {min-height: 80vh}\n  .title { font-size: 20px; margin-bottom:0px; }\n  .desc  { font-size: 16px; }\n  .scale-wrap { --btn-min: 30px; }\n  .scale-captions { font-size: 11px; }\n  .form-control {font-size: 16px;}\n  .btn {font-size: 15px; padding: 6px 9px;}\n}\n\n/* Desktop/Tablet: two-column layout and sticky aside */\n@media (min-width: 769px) {\n  .screen-content {\n    display: grid;\n    grid-template-columns: minmax(0, 1fr) 280px;\n    gap: 16px; align-items: start;\n  }\n  .sticky-aside { width: auto; }\n  .sticky-summary { position: sticky; top: 16px; max-width: 280px; }\n}\n\n/* Scale + captions wrapper */\n.scale-wrap {\n  width: 100%;\n  display: grid;\n  grid-template-rows: auto auto;       /* row 1 = buttons, row 2 = captions */\n  row-gap: 6px;\n  /* Button min-width is responsive via this variable */\n  --btn-min: 44px;                      /* default */\n}\n\n/* Caption row: left/right labels aligned to edges of the button grid */\n.scale-captions {\n  display: grid;\n  grid-template-columns: repeat(7, 1fr);\n  column-gap: 8px;     /* match the buttons gap so edges line up */\n  align-items: center;\n  width: 100%;\n  color: #E8D7F1;\n  font-size: clamp(11px, 1.6vw, 13px);\n  line-height: 1.3;\n  margin: 0;           /* remove default margins that can nudge alignment */\n  padding: 0;\n}\n/* Prevent long phrases from squishing; allow wrapping gracefully */\n/* Left caption under column 1, left-justified */\n.scale-caption-left {\n  grid-column: 1;\n  justify-self: start;\n  text-align: left;\n  margin: 0;\n  margin-bottom: 2px;\n}\n\n/* Right caption under column 7, right-justified */\n.scale-caption-right {\n  grid-column: 7;\n  justify-self: end;\n  text-align: right;   /* makes â€œVery accurateâ€ / â€œCompletely trustworthyâ€ hug the 7 */\n  margin-right: 5px;\n  margin-bottom: 2px;\n}\n\n/* Slide the whole card container (box) */\n#appStage { position: relative; overflow: hidden; }\n.card { will-change: transform, opacity; }\n\n/* Ghost of outgoing card */\n.card-ghost {\n  position: absolute;\n  inset: 0;\n  width: 100%;\n  z-index: 5;\n  pointer-events: none;\n}\n\n/* Outgoing animations */\n@keyframes card-out-left {\n  from { opacity: 1; transform: translateX(0); }\n  to   { opacity: 0; transform: translateX(-80px); }\n}\n@keyframes card-out-right {\n  from { opacity: 1; transform: translateX(0); }\n  to   { opacity: 0; transform: translateX(80px); }\n}\n.card-out-left  { animation: card-out-left 520ms ease both; }\n.card-out-right { animation: card-out-right 520ms ease both; }\n\n/* Incoming animations */\n@keyframes card-in-right {\n  from { opacity: 0; transform: translateX(80px); }\n  to   { opacity: 1; transform: translateX(0); }\n}\n@keyframes card-in-left {\n  from { opacity: 0; transform: translateX(-80px); }\n  to   { opacity: 1; transform: translateX(0); }\n}\n.card-in-right { animation: card-in-right 520ms ease both; }\n.card-in-left  { animation: card-in-left  520ms ease both; }\n\n/* Mobile: outer card does not scroll; inner content does. Keep card compact when content is short. */\n@media (max-width: 768px) {\n  .sticky-summary{margin-top:10px;}\n   .sticky-aside {\n    display: none; /* Hide on mobile to save space */\n  }\n  \n  /* FIXED: Don't center on mobile, just fill the space */\n  .fullscreen { \n    min-height: 70vh; \n    display: block; /* Changed from flex */\n    padding: 5px; \n    overflow: hidden; /* Prevent outer scroll */\n  }\n  \n    /* Fixed card height - no centering */\n  .card {\n    width: calc(100vw - 50px); /* Account for 5px padding on each side */\n    height: 80vh; /* Default fallback - JavaScript will override */\n    max-height: 80vh; /* Default fallback - JavaScript will override */\n    margin: 0 auto; /* Simple horizontal centering */\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n    padding: 16px;\n    box-sizing: border-box;\n  }\n\n  /* Wrapper does not scroll */\n  #screen {\n    flex: 1 1 auto;\n    height: auto;\n    overflow: hidden;\n  }\n\n  /* Flex chain must allow children to shrink so inner can scroll */\n  .screen-content {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    min-height: 0;                /* critical for inner scrolling */\n  }\n  .main-pane {\n    display: flex;\n    flex-direction: column;\n    flex: 1 1 auto;\n    min-height: 0;                /* critical for inner scrolling */\n    max-height: calc(100vh - 120px); /* ADDED: ensure container has max height */\n\n  }\n\n  /* Advice: scroll only when long; otherwise compact (no hole) */\n  .main-pane .desc { flex: 0 1 auto; overflow: visible; max-height: none; }\n  .main-pane .desc.long {\n    flex: 1 1 auto;\n    min-height: 0;\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-right: 2px;\n    padding-bottom: 12px;         /* clearance above buttons */\n    max-height: calc(100vh - 300px); /* Adjust this value as needed */\n\n  }\n\n  /* 1â€“7 scale: scroll inside a capped area; fit columns */\n  .main-pane .scale-wrap {\n    flex: 0 1 auto;               /* donâ€™t fill entire pane */\n    max-height: calc(100vh - 250px);  /* ADDED: explicit max height */\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-right: 2px;\n    padding-bottom: 12px;\n  }\n  .scale-group.scale-7 {\n    display: grid;\n    grid-template-columns: repeat(7, minmax(0, 1fr));\n    column-gap: 8px;\n    width: 100%;\n  }\n  .scale-group.scale-6 {\n    display: grid;\n    grid-template-columns: repeat(6, minmax(0, 1fr));\n    column-gap: 8px;\n    width: 100%;\n  }\n  .scale-item {\n    min-width: 0;\n    padding: 8px 6px;\n    white-space: normal;\n    font-size: 8px;\n  }\n\n  .nav-actions {\n    flex: 0 0 auto; \n    margin-top: 8px; \n    background: rgba(15,23,42,0.9); \n    position: relative;\n    z-index: 10;  \n  }\n  \n  \n/* Collapsible toggles with chevron */\n.admin-toggle {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  cursor: pointer;\n  user-select: none;\n  font-weight: 700;\n  color: #E7E393;\n  text-decoration: none;\n  padding: 8px 10px;\n  border: 1px solid #334155;\n  border-radius: 8px;\n  background: rgba(17,24,39,0.6);\n  margin-top: 10px;\n}\n.admin-toggle:hover { color: #A79EFF; }\n\n.admin-toggle .chev {\n  display: inline-block;\n  transition: transform 0.2s ease;\n  font-size: 14px;\n  line-height: 1;\n}\n/* Rotate chevron when expanded (Bootstrap toggles .collapsed on the trigger) */\n.admin-toggle:not(.collapsed) .chev { transform: rotate(90deg); }\n\n/* Collapsed content containers */\n.admin-panel, .admin-guard-panel {\n  margin-top: 8px;\n  padding: 12px;\n  border: 1px solid #334155;\n  border-radius: 10px;\n  background: rgba(17,24,39,0.6);\n}\n\n/* Warning modal styling */\n.warning-modal .modal-backdrop {\n  background-color: rgba(0, 0, 0, 0.8) !important;\n}\n\n.warning-modal .modal-content {\n  background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;\n  color: #1f2937 !important;\n  border: 3px solid #d97706;\n  box-shadow: 0 25px 50px rgba(217, 119, 6, 0.3);\n  position: relative;\n}\n\n.warning-modal .modal-content::before {\n  content: 'ðŸ”’';\n  position: absolute;\n  top: -15px;\n  right: -15px;\n  font-size: 24px;\n  background: #dc2626;\n  color: white;\n  width: 40px;\n  height: 40px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border: 3px solid white;\n  box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n}\n\n/* Only disable elements when WARNING modal is active */\nbody.warning-modal-active .card:not(.warning-modal) {\n  pointer-events: none !important;\n  opacity: 0.7;\n}\n\n/* Only disable elements when WARNING modal is active, and not in other modals */\nbody.warning-modal-active input:not(#warningOkBtn),\nbody.warning-modal-active button:not(#warningOkBtn),\nbody.warning-modal-active .scale-item {\n  pointer-events: none !important;\n  opacity: 0.3 !important;\n  filter: grayscale(1) !important;\n}\n\n/* Exception: don't disable elements inside non-warning modals */\nbody.warning-modal-active .modal:not(.warning-modal) input,\nbody.warning-modal-active .modal:not(.warning-modal) button {\n  pointer-events: auto !important;\n  opacity: 1 !important;\n  filter: none !important;\n}\n\n/* Character limit styling for post questionnaire */\n#post_q_text {\n  max-length: 2400; /* Roughly 400 words * 6 chars average */\n}\n\n.char-counter {\n  font-size: 12px;\n  color: #64748b;\n  text-align: right;\n  margin-top: 4px;\n}\n\n.char-counter.warning {\n  color: #f59e0b;\n}\n\n.char-counter.error {\n  color: #ef4444;\n}\n\n/* Admin download button styling */\n.download-grid {\n  margin-top: 15px;\n}\n\n.download-grid .btn {\n  width: 100%;\n  text-align: center;\n  font-size: 13px;\n}\n\n.btn.btn-download {\n  --bs-btn-bg: #00D4FF;\n  --bs-btn-color: #0b1020;\n  --bs-btn-hover-bg: #00F5F2 !important;\n  --bs-btn-hover-color: #ffffff;\n  margin-bottom: 0px;\n}\n\"\n\n# -----------------------------\n# UI\n# -----------------------------\nui <- page_fluid(\n  theme = theme,\n  tags$head(\n    tags$title(\"Health Vignette Questionnaire\"),\n    tags$meta(name = \"viewport\", content = \"width=device-width, initial-scale=1\"),\n    tags$meta(name = \"description\", content = \"Participate in our questionnaire experience. Your feedback helps advance behavioral health research.\"),\n    # Open Graph / Facebook / Teams / WhatsApp\n    tags$meta(property = \"og:title\", content = \"Health Vignette Questionnaire\"),\n    tags$meta(property = \"og:description\", content = \"Participate in our questionnaire experience. Your feedback helps advance behavioral health research.\"),\n    tags$meta(property = \"og:type\", content = \"website\"),\n    tags$meta(property = \"og:url\", content = \"https://bzadoroz.shinyapps.io/ShinyVignettesv2/\"),\n    tags$meta(property = \"og:image\", content = \"https://bzadoroz.shinyapps.io/ShinyVignettesv2/splash.jpg\"), \n    \n    # Twitter Card\n    tags$meta(name = \"twitter:card\", content = \"summary_large_image\"),\n    tags$meta(name = \"twitter:title\", content = \"Health Vignette Questionnaire\"),\n    tags$meta(name = \"twitter:description\", content = \"Participate in our questionnaire experience. Your feedback helps advance behavioral health research.\"),\n    tags$meta(name = \"twitter:image\", content = \"https://bzadoroz.shinyapps.io/ShinyVignettesv2/splash.jpg\"), \n    \n    tags$script(src = \"app.js\")\n  ),\n  tags$head(\n    tags$link(rel = \"icon\", type = \"image/svg+xml\", href = \"favicon-ecg.svg\")\n  ),\n  tags$head(tags$style(HTML(css))),\n  div(id = \"appStage\", class = \"fullscreen\",\n      div(class = \"card gallery js-flickity\",\n          div(class = \"top-progress\", div(id = \"topProgressBar\", class = \"top-progress-bar\")),\n          uiOutput(\"progressUI\"),\n          uiOutput(\"screenUI\")\n      )\n  ))\n# -----------------------------\n# Server\n# -----------------------------\nserver <- function(input, output, session) {\n  `%||%` <- function(x, y) if (is.null(x)) y else x\n  \n  TOTAL_STEPS <- 45L # 12 pre + 4 vignettes * 8 steps (Narrative + Expl1 + Expl2 + Q1 + Q2 + Q3 + Q4 + Q5) + post-experience\n  PRE_QUESTIONNAIRE_STEPS <- 12L\n  VIGNETTE_START_STEP <- 13L\n  \n  QUESTIONNAIRE_MAP <- list(\n    \"intro\" = 1L,\n    \"demographics\" = 2L,\n    \"crt_intro\" = 3L,\n    \"crt\" = 4L,\n    \"gaais_intro\" = 5L,\n    \"gaais\" = 6L,\n    \"fwa_intro\" = 7L,\n    \"fwa\" = 8L,\n    \"teique_intro\" = 9L,\n    \"teique\" = 10L,\n    \"mhlc_intro\" = 11L,\n    \"mhlc\" = 12L\n  )\n  \n  rv <- reactiveValues(\n    admin_skip_used = FALSE,\n    \n    started = FALSE,\n    pre_step = 0L,\n    \n    section_started_at = list(\n      demographics = as.POSIXct(NA_character_),\n      crt         = as.POSIXct(NA_character_),\n      gaais       = as.POSIXct(NA_character_),\n      fwa         = as.POSIXct(NA_character_),\n      teique      = as.POSIXct(NA_character_),\n      mhlc        = as.POSIXct(NA_character_)\n    ),\n    \n    pre_q_completed = list(\n      demographics = numeric(),\n      crt = numeric(),\n      gaais = numeric(),\n      fwa = numeric(),\n      teique = numeric(),\n      mhlc = numeric()\n    ),\n    \n    \n    # Popped answers\n    popped_answers = list(\n      demographics = list(), crt = list(),\n      gaais = list(), fwa = list(),\n      teique = list(), mhlc = list()\n    ),\n    \n    \n    # Pre-questionnaire data\n    pre_answers = list(\n      demographics = list(),\n      crt = list(),\n      gaais = list(),\n      fwa = list(),\n      teique = list(),\n      mhlc = list()\n    ),\n    \n    # Track completion status\n    completed_questionnaires = character(),\n    \n    # Vignette data\n    vignettes = NULL,\n    current_vignette = 0L,  # 1..4\n    vig_step = 0L,      # 1..8\n    answers = vector(\"list\", 4),\n    responses = data.frame(\n      participant_id = character(),\n      vignette_number = integer(),\n      provider = character(),\n      severity = character(),\n      advice_len = character(),\n      q_take_advice = logical(),         # TRUE/FALSE\n      q_perceived_accuracy = integer(),\n      q_trustworthiness = integer(),   # remapped to int\n      q_concern_condition = integer(),       # NEW Q4\n      q_concern_circumstances = integer(),   # NEW Q5\n      post_vignette_response = character(),  # post vignette\n      started_at = as.POSIXct(character()),\n      submitted_at = as.POSIXct(character()),\n      stringsAsFactors = FALSE\n    ),\n    post_vignette_answer = NULL,\n    last_dir = \"forward\",\n    sb_access_token = NULL,\n    sb_refresh_token = NULL,\n    sb_expires_at    = NULL,\n    sb_auth_attempted = FALSE,\n    sb_auth_error     = NULL,\n    sb_auth_tries     = 0L,\n    sb_user_email = NULL,\n    # NEW: store start time per vignette\n    vignette_started_at = as.POSIXct(rep(NA_character_, 4))\n    \n    \n  )\n  \n  show_blocking_warning <- function(title, message, duration = 5) {\n    session$sendCustomMessage('showBlockingWarning', list(\n      title = title,\n      message = message,\n      duration = duration\n    ))\n  }\n  \n  rv$warning_cooldowns <- list(\n    gaais_straightline = as.POSIXct(NA),\n    teique_straightline = as.POSIXct(NA),\n    mhlc_straightline = as.POSIXct(NA),\n    vignette_pattern = as.POSIXct(NA),\n    speed_warning = as.POSIXct(NA),\n    attention_check = as.POSIXct(NA)\n  )\n  rv$warning_shown <- list(\n    gaais_straightline = FALSE,\n    teique_straightline = FALSE,\n    mhlc_straightline = FALSE,\n    vignette_pattern = FALSE,\n    speed_warning = FALSE\n  )\n  \n  accuracy_levels <- c(\n    \"Very inaccurate\",\n    \"Inaccurate\",\n    \"Somewhat inaccurate\",\n    \"Neither inaccurate nor accurate\",\n    \"Somewhat accurate\",\n    \"Accurate\",\n    \"Very accurate\"\n  )\n  \n  trust_levels <- c(\n    \"Not trustworthy at all\",\n    \"Untrustworthy\",\n    \"Somewhat untrustworthy\",\n    \"Neutral\",\n    \"Somewhat trustworthy\",\n    \"Trustworthy\",\n    \"Fully trustworthy\"\n  )\n  \n  # Demographics options\n  demographics_questions <- list(\n    age = list(\n      question = \"To which age group do you belong?\",\n      type = \"scale\",\n      options = c(\"<18\", \"18-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\")\n    ),\n    gender = list(\n      question = \"What is your gender?\",\n      type = \"scale\", \n      options = c(\"Male\", \"Female\", \"Non-binary/Other\")\n    ),\n    education = list(\n      question = \"What is the highest level of education that you have attained?\",\n      type = \"scale\",\n      options = c(\"High school or less\", \"Some college\", \"Bachelor's\", \"Master's\", \"Doctoral\", \"Post-doctoral or beyond\")\n    ),\n    postcode = list(\n      question = \"What are the first two digits of your postcode?\",\n      type = \"text\",\n      validation = \"postcode\"\n    )\n  )\n  \n  crt_questions <- list(\n    q1 = \"If youâ€™re running a race and you pass the person in second place, what place are you in?\",\n    q2 = \"A farmer had 15 sheep and all but 8 died. How many are left?\",\n    q3 = \"Emilyâ€™s father has three daughters. The first two are named April and May. What is the third daughterâ€™s name?\",\n    q4 = \"How many cubic feet of dirt are there in a hole that is 3â€™ deep x 3â€™ wide x 3â€™ long?\"\n  )\n  \n  gaais_questions <- c(\n    \"For routine transactions, I would rather interact with an artificially intelligent system than with a human.\",\n    \"Artificial Intelligence can provide new economic opportunities for this country.\", \n    \"Organisations use Artificial Intelligence unethically.\",\n    \"Artificially intelligent systems can help people feel happier.\",\n    \"I am impressed by what Artificial Intelligence can do.\",\n    \"I think artificially intelligent systems make many errors. \",\n    \"I am interested in using artificially intelligent systems in my daily life.\",\n    \"I find Artificial Intelligence sinister. \",\n    \"Artificial Intelligence might take control of people.\",\n    \"I think Artificial Intelligence is dangerous. \",\n    \"Artificial Intelligence can have positive impacts on peopleâ€™s wellbeing.\",\n    \"Artificial Intelligence is exciting. \",\n    \"I would be grateful if you could select Strongly Agree. \",\n    \"An artificially intelligent agent would be better than an employee in many routine jobs.\",\n    \"There are many beneficial applications of Artificial Intelligence. \",\n    \"I shiver with discomfort when I think about future uses of Artificial Intelligence. \",\n    \"Artificially intelligent systems can perform better than humans.\",\n    \"Much of society will benefit from a future full of Artificial Intelligence.\",\n    \"I would like to use Artificial Intelligence in my own job. \",\n    \"People like me will suffer if Artificial Intelligence is used more and more. \",\n    \"Artificial Intelligence is used to spy on people.\"\n  )\n  \n  fwa_questions <- c(\n    \"How frequently do you use artificial intelligence (AI) tools in general?\",\n    \"How frequently do you use artificial intelligence (AI) tools specifically in the medical context?\"\n  )\n  \n  teique_questions <- c(\n    \"Expressing my emotions with words is not a problem for me.\",\n    \"I often find it difficult to see things from another personâ€™s viewpoint.\",\n    \"On the whole, Iâ€™m a highly motivated person.\",\n    \"I usually find it difficult to regulate my emotions. \",\n    \"I generally donâ€™t find life enjoyable. \",\n    \"I can deal effectively with people.\",\n    \"I tend to change my mind frequently. \",\n    \"Many times, I canâ€™t figure out what emotion I'm feeling.\",\n    \"I feel that I have a number of good qualities.\",\n    \"I often find it difficult to stand up for my rights.\",\n    \"Iâ€™m usually able to influence the way other people feel.\",\n    \"On the whole, I have a gloomy perspective on most things.\",\n    \"Those close to me often complain that I donâ€™t treat them right.\",\n    \"I often find it difficult to adjust my life according to the circumstances.\",\n    \"On the whole, Iâ€™m able to deal with stress.\",\n    \"I often find it difficult to show my affection to those close to me.\",\n    \"Iâ€™m normally able to â€œget into someoneâ€™s shoesâ€ and experience their emotions.\",\n    \"I normally find it difficult to keep myself motivated.\",\n    \"Iâ€™m usually able to find ways to control my emotions when I want to.\",\n    \"On the whole, Iâ€™m pleased with my life.\",\n    \"I would describe myself as a good negotiator.\",\n    \"I tend to get involved in things I later wish I could get out of. \",\n    \"I often pause and think about my feelings.\",\n    \"I believe Iâ€™m full of personal strengths.\",\n    \"I tend to â€œback downâ€ even if I know Iâ€™m right. \",\n    \"I donâ€™t seem to have any power at all over other peopleâ€™s feelings. \",\n    \"I generally believe that things will work out fine in my life.\",\n    \"I find it difficult to bond well even with those close to me. \",\n    \"Generally, Iâ€™m able to adapt to new environments.\",\n    \"Others admire me for being relaxed.\",\n    \"I would be grateful if you selected the Completely Disagree option.\"  # NEW - attention check\n  )\n  \n  mhlc_questions <- c(\n    \"If I get sick, it is my own behavior which determines how soon I get well again. \",\n    \"No matter what I do, if I am going to get sick, I will get sick. \",\n    \"Having regular contact with my physician is the best way for me to avoid illness. \",\n    \"Most things that affect my health happen to me by accident.\",\n    \"Whenever I don't feel well, I should consult a medically trained professional.\",\n    \"I am in control of my health.\",\n    \"My family has a lot to do with my becoming sick or staying healthy. \",\n    \"When I get sick, I am to blame.\",\n    \"Luck plays a big part in determining how soon I will recover from an illness.\",\n    \"Health professionals control my health.\",\n    \"My good health is largely a matter of good fortune.\",\n    \"The main thing which affects my health is what I myself do.\",\n    \"If I take care of myself, I can avoid illness.\",\n    \"When I recover from an illness, it's usually because other people (for example, doctors, nurses, family, friends) have been taking good care of me. \",\n    \"No matter what I do, I am likely to get sick.\",\n    \"If it's meant to be, I will stay healthy.\",\n    \"If I take the right actions, I can stay healthy.\",\n    \"Regarding my health, I can only do what my doctor tells me to do.\"\n  )\n  \n  # Enter input error handler (corrected and structured)\n  observeEvent(input$enter_blocked, {\n    # 1) Vignette validation (steps 4..8 are question pages)\n    if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      if (rv$vig_step == 4L) {\n        showModal(modalDialog(\n          title = \"Incomplete Response\",\n          \"Please select Yes or No.\",\n          easyClose = TRUE\n        ))\n      } else if (rv$vig_step %in% c(5L, 6L, 7L, 8L)) {\n        showModal(modalDialog(\n          title = \"Incomplete Response\",\n          \"Please select a value 1â€“7.\",\n          easyClose = TRUE\n        ))\n      } else {\n        showModal(modalDialog(\n          title = \"Action blocked\",\n          \"You can only use Enter to advance on the current screen.\",\n          easyClose = TRUE\n        ))\n      }\n      return()\n    }\n    \n    # 2) Pre-questionnaire validation (even-numbered steps with inputs)\n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 12) {\n      if (rv$pre_step == 2L) {\n        # Demographics\n        current_q_num <- length(rv$pre_answers$demographics) + 1\n        q_names <- names(demographics_questions)\n        current_q_name <- q_names[current_q_num]\n        q_data <- demographics_questions[[current_q_name]]\n        \n        if (q_data$type == \"text\") {\n          # Postcode validation\n          answer <- trimws(input$current_answer %||% \"\")\n          if (!nzchar(answer)) {\n            showModal(modalDialog(\n              title = \"Incomplete Response\",\n              \"Please enter the first two digits of your postcode.\",\n              easyClose = TRUE\n            ))\n          } else if (!grepl(\"^[0-9]{2}$\", answer)) {\n            showModal(modalDialog(\n              title = \"Invalid Input\",\n              \"Please enter exactly 2 digits (numbers only).\",\n              easyClose = TRUE\n            ))\n          }\n        } else {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select an option.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 4L) {\n        # CRT - text must be filled\n        answer <- trimws(input$current_answer %||% \"\")\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please provide an answer.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 6L) {\n        # GAAIS - scale selection required\n        answer <- input$gaais_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 8L) {\n        # FWA\n        answer <- input$fwa_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 10L) {\n        # TEIQue\n        answer <- input$teique_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else if (rv$pre_step == 12L) {\n        # MHLC\n        answer <- input$mhlc_q %||% \"\"\n        if (!nzchar(answer)) {\n          showModal(modalDialog(\n            title = \"Incomplete Response\",\n            \"Please select a rating.\",\n            easyClose = TRUE\n          ))\n        }\n        \n      } else {\n        # Intro screens (1, 3, 5, 7, 9, 11) have no validation\n        showModal(modalDialog(\n          title = \"Action blocked\",\n          \"You can only use Enter to advance on the current screen.\",\n          easyClose = TRUE\n        ))\n      }\n      return()\n    }\n    \n    # 3) Fallback\n    showModal(modalDialog(\n      title = \"Action blocked\",\n      \"You can only use Enter to advance on the current screen.\",\n      easyClose = TRUE\n    ))\n  })\n  \n  \n  # Additional Supabase helpers\n  \n  \n  \n  # Machine user sign-in and token refresh\n  # Try to sign the machine user in; returns TRUE on success, FALSE otherwise\n  machine_sign_in <- function() {\n    rv$sb_auth_attempted <- TRUE\n    rv$sb_auth_tries <- rv$sb_auth_tries + 1L\n    \n    # Explicit checks instead of req()\n    if (!nzchar(APP_EMAIL) || !nzchar(APP_PASSWORD)) {\n      rv$sb_auth_error <- \"Missing SUPABASE_APP_EMAIL or SUPABASE_APP_PASSWORD\"\n      message(rv$sb_auth_error)\n      return(FALSE)\n    }\n    if (!nzchar(SUPABASE_URL) || !nzchar(SUPABASE_KEY)) {\n      rv$sb_auth_error <- \"Missing SUPABASE_URL or SUPABASE_KEY\"\n      message(rv$sb_auth_error)\n      return(FALSE)\n    }\n    \n    # Attempt sign-in\n    tryCatch({\n      tok <- supabase_sign_in(APP_EMAIL, APP_PASSWORD)\n      rv$sb_access_token  <- tok$access_token\n      rv$sb_refresh_token <- tok$refresh_token\n      rv$sb_expires_at    <- Sys.time() + as.numeric(tok$expires_in)\n      rv$sb_auth_error    <- NULL\n      #      message(\"Machine user signed in; token acquired.\")\n      TRUE\n    }, error = function(e) {\n      rv$sb_auth_error <- paste(\"Machine user sign-in error:\", e$message)\n      message(rv$sb_auth_error)\n      FALSE\n    })\n  }\n  \n  # Kick off sign-in and retry up to, say, 10 times (every 5 seconds) until it succeeds\n  # Only attempt machine sign-in if not using admin skip\n  observe({\n    # Skip machine auth if admin skip is being used\n    if (isTRUE(rv$admin_skip_used)) return()\n    \n    if (is.null(rv$sb_access_token) || !nzchar(rv$sb_access_token)) {\n      invalidateLater(5000, session)\n      if (rv$sb_auth_tries < 10L) {\n        machine_sign_in()\n      } else {\n        # Only show this message if not using admin skip\n        if (!isTRUE(rv$admin_skip_used)) {\n          message(\"Machine user sign-in: reached max retries.\")\n        }\n      }\n    }\n  }, label = \"machine_sign_in_retry\")\n  \n  \n  # Admin state\n  rv$admin_unlocked <- FALSE\n  rv$sim_rows <- NULL\n  \n  # Unlock admin \n  observeEvent(input$admin_unlock, {\n    key <- trimws(input$admin_key %||% \"\")\n    if (identical(key, \"H1ghlyS3cure!\")) {\n      rv$admin_unlocked <- TRUE\n      showNotification(\"Admin unlocked.\", type = \"message\", duration = 3)\n    } else {\n      showModal(modalDialog(title = \"Invalid Admin Key\",\n                            \"The key you entered is incorrect.\", easyClose = TRUE))\n    }\n  })\n  \n  # Static (non-collapsible) Admin tools shown after unlock\n  output$adminPanel <- renderUI({\n    if (!isTRUE(rv$admin_unlocked)) return(NULL)  # This line was the issue\n    \n    div(\n      class = \"admin-panel\",\n      \n      # NEW: Skip Pre-questionnaire section\n      div(class = \"label\", \"Development Tools\"),\n      div(class = \"nav-actions\",\n          actionButton(\"btn_skip_pre\", \"Skip to Vignettes\", class = \"btn btn-back\"),\n          actionButton(\"btn_skip_to_post\", \"Skip to Post-Question\", class = \"btn btn-back\")\n      ),\n      \n      # Existing simulation section\n      div(class = \"label\", style = \"margin-top: 20px;\", \"Simulate Participants\"),\n      numericInput(\"sim_n\", \"Number of participants\",\n                   value = 100, min = 1, step = 50, width = \"240px\"),\n      numericInput(\"sim_seed\", \"Random seed (optional)\",\n                   value = NA, min = 1, step = 1, width = \"240px\"),\n      div(class = \"nav-actions\",\n          actionButton(\"btn_simulate\", \"Simulate\", class = \"btn btn-back\")\n      ),\n      \n      # Download buttons in a clean grid\n      div(class = \"download-grid\", style = \"display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;\",\n          downloadButton(\"download_sim_csv\", \"Download All Data\", class = \"btn btn-download\"),\n          downloadButton(\"download_sim_pre\", \"Download Pre-questionnaire\", class = \"btn btn-download\")\n      ),\n      div(style = \"margin-top: 10px;\",\n          downloadButton(\"download_sim_vignettes\", \"Download Vignettes Only\", class = \"btn btn-download\", style = \"width: 100%;\")\n      ),\n      uiOutput(\"simSummary\")\n    )\n  })\n  \n  \n  # Download pre-questionnaire data only\n  output$download_sim_pre <- downloadHandler(\n    filename = function() {\n      paste0(\"simulated_prequestionnaire_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      dat <- rv$sim_rows\n      if (is.null(dat) || !NROW(dat)) {\n        write.csv(data.frame(), file, row.names = FALSE)\n        return()\n      }\n      \n      # Filter to pre-questionnaire data only\n      pre_dat <- dat[dat$vignette_number == 0, ]\n      \n      # Fix Excel postcode issue on export only\n      pre_dat$post_vignette_response <- ifelse(\n        grepl(\"DEMOGRAPHICS_postcode\", pre_dat$severity) & \n          grepl(\"^[0-9]{2}$\", pre_dat$post_vignette_response),\n        paste0(\"'\", pre_dat$post_vignette_response),\n        pre_dat$post_vignette_response\n      )\n      \n      write.csv(pre_dat, file, row.names = FALSE)\n    }\n  )\n  \n  # Download vignette data only\n  output$download_sim_vignettes <- downloadHandler(\n    filename = function() {\n      paste0(\"simulated_vignettes_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      dat <- rv$sim_rows\n      if (is.null(dat) || !NROW(dat)) {\n        write.csv(data.frame(), file, row.names = FALSE)\n        return()\n      }\n      # Filter to vignette data only (vignette_number 1-4 and 99 for post-vignette)\n      vig_dat <- dat[dat$vignette_number >= 1, ]\n      write.csv(vig_dat, file, row.names = FALSE)\n    }\n  )\n  \n  # Random generators for responses (tune as desired)\n  rand_yes_no <- function(p_yes = 0.6) if (runif(1) < p_yes) \"Yes\" else \"No\"\n  rand_scale7 <- function(center = 5, spread = 1.3) {\n    v <- round(rnorm(1, mean = center, sd = spread))\n    max(1, min(7, v))\n  }\n  rand_scale5 <- function(center = 3, spread = 1.0) {\n    v <- round(rnorm(1, mean = center, sd = spread))\n    max(1, min(5, v))\n  }\n  rand_scale6 <- function(center = 3.5, spread = 1.2) {\n    v <- round(rnorm(1, mean = center, sd = spread))\n    max(1, min(6, v))\n  }\n  \n  \n  # Simulate n participants with complete pre-questionnaire and vignette data\n  simulate_participants <- function(n, seed = NULL) {\n    if (!is.null(seed) && !is.na(seed)) set.seed(as.integer(seed))\n    \n    all_rows <- vector(\"list\", n * (4 + 80))  # 4 vignettes + ~80 pre-questionnaire items\n    idx <- 0L\n    \n    for (k in seq_len(n)) {\n      pid <- sprintf(\"sim_%06d\", k)\n      \n      # Random base time within last 24 hours\n      base_t <- Sys.time() - runif(1, min = 3600, max = 24 * 3600)\n      current_time <- base_t\n      \n      # === SIMULATE PRE-QUESTIONNAIRE DATA ===\n      \n      # 1. Demographics (4 questions)\n      demo_start <- current_time\n      current_time <- current_time + runif(1, 30, 120)  # 30-120 seconds\n      \n      # Age (1-7)\n      age_val <- sample(c(\"18-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\", \"<18\"), 1, \n                        prob = c(0.25, 0.25, 0.20, 0.15, 0.10, 0.04, 0.01))\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_age\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = age_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # Gender (1-3)\n      gender_val <- sample(c(\"Male\", \"Female\", \"Non-binary/Other\"), 1, prob = c(0.45, 0.50, 0.05))\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_gender\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = gender_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # Education (1-6)\n      edu_val <- sample(c(\"High school or less\", \"Some college\", \"Bachelor's\", \"Master's\", \"Doctoral\", \"Post-doctoral or beyond\"), \n                        1, prob = c(0.15, 0.25, 0.35, 0.20, 0.04, 0.01))\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_education\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = edu_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # Postcode (2 digits)\n      postcode_val <- sprintf(\"%02d\", sample(1:80, 1))  # Clean data, no prefix\n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 0L, provider = \"PRE_DEMOGRAPHICS\",\n        severity = \"DEMOGRAPHICS_postcode\", advice_len = \"DEMOGRAPHICS\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = postcode_val, started_at = demo_start, submitted_at = current_time,\n        stringsAsFactors = FALSE\n      )\n      \n      # 2. CRT (4 questions)\n      crt_start <- current_time + runif(1, 10, 60)\n      current_time <- crt_start\n      \n      crt_answers <- list(\n        sample(1:9, 1),  # Q1: single digit\n        sample(1:9, 1),  # Q2: single digit  \n        sample(c(\"Emily\", \"April\", \"May\", \"June\", \"Lisa\"), 1),  # Q3: name\n        sample(c(\"0\", \"27\", \"5\"), 1)  # Q4: typical answers\n      )\n      \n      for (i in 1:4) {\n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_CRT\",\n          severity = paste0(\"CRT_q\", i), advice_len = \"CRT\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(crt_answers[[i]]), \n          started_at = crt_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 5, 30)\n      }\n      \n      # 3. GAAIS (21 questions)\n      gaais_start <- current_time + runif(1, 10, 60)\n      current_time <- gaais_start\n      \n      # Simulate somewhat consistent GAAIS responses (with some variation)\n      base_attitude <- sample(c(2, 3, 4), 1, prob = c(0.3, 0.4, 0.3))  # Slightly negative to neutral\n      \n      for (i in 1:21) {\n        # Add some variation around base attitude\n        response <- pmax(1, pmin(5, base_attitude + sample(-1:1, 1, prob = c(0.2, 0.6, 0.2))))\n        \n        # Question 13 is attention check - should be \"5\" (Strongly Agree)\n        if (i == 13) response <- 5\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_GAAIS\",\n          severity = paste0(\"GAAIS_q\", i), advice_len = \"GAAIS\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = gaais_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 2, 15)\n      }\n      \n      # 4. FWA (2 questions)\n      fwa_start <- current_time + runif(1, 5, 30)\n      current_time <- fwa_start\n      \n      for (i in 1:2) {\n        # FWA responses tend to be lower (1-3 mostly)\n        response <- sample(1:5, 1, prob = c(0.4, 0.3, 0.2, 0.08, 0.02))\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_FWA\",\n          severity = paste0(\"FWA_q\", i), advice_len = \"FWA\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = fwa_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 3, 20)\n      }\n      \n      # 5. TEIQue (31 questions including attention check)\n      teique_start <- current_time + runif(1, 10, 60)\n      current_time <- teique_start\n      \n      # Simulate personality-based responses\n      base_ei <- sample(3:6, 1)  # Base emotional intelligence level\n      \n      for (i in 1:31) {\n        if (i == 31) {\n          # Attention check - should be \"1\" (Completely Disagree)\n          response <- 1\n        } else {\n          # Add variation around base EI level\n          response <- pmax(1, pmin(7, base_ei + sample(-2:2, 1, prob = c(0.1, 0.2, 0.4, 0.2, 0.1))))\n        }\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_TEIQUE\",\n          severity = paste0(\"TEIQUE_q\", i), advice_len = \"TEIQUE\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = teique_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 2, 12)\n      }\n      \n      # 6. MHLC (18 questions)\n      mhlc_start <- current_time + runif(1, 10, 60)\n      current_time <- mhlc_start\n      \n      # Health locus of control varies by person\n      base_control <- sample(2:5, 1)  # Base control belief\n      \n      for (i in 1:18) {\n        response <- pmax(1, pmin(6, base_control + sample(-1:1, 1, prob = c(0.25, 0.5, 0.25))))\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid, vignette_number = 0L, provider = \"PRE_MHLC\",\n          severity = paste0(\"MHLC_q\", i), advice_len = \"MHLC\",\n          q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n          q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n          post_vignette_response = as.character(response),\n          started_at = mhlc_start, submitted_at = current_time,\n          stringsAsFactors = FALSE\n        )\n        current_time <- current_time + runif(1, 2, 15)\n      }\n      \n      # === SIMULATE VIGNETTE DATA ===\n      vset <- generate_balanced_vignettes()\n      current_time <- current_time + runif(1, 60, 180)  # Break before vignettes\n      \n      for (i in seq_len(nrow(vset))) {\n        v <- vset[i, ]\n        \n        # Make distributions slightly depend on provider/severity\n        p_yes <- if (v$severity == \"High\") 0.75 else 0.55\n        acc_center <- if (v$provider == \"Doctor\") 5.5 else 4.7\n        trust_center <- if (v$provider == \"Doctor\") 5.6 else 4.4\n        \n        q1 <- rand_yes_no(p_yes)\n        q2 <- rand_scale7(center = acc_center, spread = 1.2)\n        q3 <- rand_scale7(center = trust_center, spread = 1.3)\n        q4 <- rand_scale7(center = 3.5, spread = 1.5)  # Concern about condition\n        q5 <- rand_scale7(center = 3.8, spread = 1.4)  # Concern about circumstances\n        \n        # Timings: started a bit earlier than submitted\n        started_at <- current_time + (i - 1) * runif(1, 60, 180)\n        submitted_at <- started_at + runif(1, 20, 90)\n        \n        idx <- idx + 1L\n        all_rows[[idx]] <- data.frame(\n          participant_id = pid,\n          vignette_number = i,\n          provider = v$provider,\n          severity = v$severity,\n          advice_len = v$advice_len,\n          q_take_advice = (q1 == \"Yes\"),\n          q_perceived_accuracy = as.integer(q2),\n          q_trustworthiness = as.integer(q3),\n          q_concern_condition = as.integer(q4),\n          q_concern_circumstances = as.integer(q5),\n          post_vignette_response = NA_character_,\n          started_at = started_at,\n          submitted_at = submitted_at,\n          stringsAsFactors = FALSE\n        )\n        current_time <- submitted_at\n      }\n      \n      # === POST-VIGNETTE QUESTION ===\n      post_responses <- c(\n        \"I preferred the doctor because they seemed more knowledgeable and trustworthy.\",\n        \"I liked the AI better because it was more objective and detailed.\",\n        \"Both were helpful in different ways, hard to choose.\",\n        \"The doctor felt more personal and understanding.\",\n        \"The AI was faster and more consistent.\",\n        \"I trust human judgment more for health decisions.\",\n        \"The AI provided more comprehensive information.\"\n      )\n      \n      idx <- idx + 1L\n      all_rows[[idx]] <- data.frame(\n        participant_id = pid, vignette_number = 99L, provider = \"POST_VIGNETTE\",\n        severity = \"POST_VIGNETTE\", advice_len = \"POST_VIGNETTE\",\n        q_take_advice = NA, q_perceived_accuracy = NA_integer_, q_trustworthiness = NA_integer_,\n        q_concern_condition = NA_integer_, q_concern_circumstances = NA_integer_,\n        post_vignette_response = sample(post_responses, 1),\n        started_at = current_time, submitted_at = current_time + runif(1, 30, 120),\n        stringsAsFactors = FALSE\n      )\n    }\n    \n    # Remove any NULL entries and combine\n    all_rows <- all_rows[!sapply(all_rows, is.null)]\n    do.call(rbind, all_rows)\n  }\n  \n  # Simulate on click\n  observeEvent(input$btn_simulate, {\n    n <- as.integer(input$sim_n %||% 0)\n    if (is.na(n) || n <= 0) {\n      showModal(modalDialog(title = \"Invalid number\", \"Enter a positive integer.\", easyClose = TRUE))\n      return()\n    }\n    \n    # Show progress notification\n    showNotification(\"Generating simulation data... This may take a moment.\", type = \"message\", duration = 3)\n    \n    sim <- simulate_participants(n, seed = input$sim_seed)\n    rv$sim_rows <- sim\n    \n    # Count the data for notification\n    participants <- length(unique(sim$participant_id))\n    total_rows <- nrow(sim)\n    \n    showNotification(\n      sprintf(\"Simulated %d participants with complete data (%d total rows).\", participants, total_rows), \n      type = \"message\", \n      duration = 5\n    )\n  })\n  \n  # Show a more detailed summary\n  output$simSummary <- renderUI({\n    dat <- rv$sim_rows\n    if (is.null(dat) || !NROW(dat)) return(NULL)\n    \n    # Count different types of data\n    vignette_rows <- sum(dat$vignette_number >= 1 & dat$vignette_number <= 4)\n    pre_rows <- sum(dat$vignette_number == 0)\n    post_rows <- sum(dat$vignette_number == 99)\n    participants <- length(unique(dat$participant_id))\n    \n    # Break down pre-questionnaire data\n    demo_rows <- sum(grepl(\"DEMOGRAPHICS\", dat$provider))\n    crt_rows <- sum(grepl(\"CRT\", dat$provider))\n    gaais_rows <- sum(grepl(\"GAAIS\", dat$provider))\n    fwa_rows <- sum(grepl(\"FWA\", dat$provider))\n    teique_rows <- sum(grepl(\"TEIQUE\", dat$provider))\n    mhlc_rows <- sum(grepl(\"MHLC\", dat$provider))\n    \n    \n  })\n  \n  # Download simulated CSV\n  output$download_sim_csv <- downloadHandler(\n    filename = function() {\n      paste0(\"simulated_responses_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      dat <- rv$sim_rows\n      if (is.null(dat) || !NROW(dat)) {\n        write.csv(data.frame(), file, row.names = FALSE)\n        return()\n      }\n      \n      # Fix Excel postcode issue on export only\n      dat$post_vignette_response <- ifelse(\n        grepl(\"DEMOGRAPHICS_postcode\", dat$severity) & \n          grepl(\"^[0-9]{2}$\", dat$post_vignette_response),\n        paste0(\"'\", dat$post_vignette_response),\n        dat$post_vignette_response\n      )\n      \n      write.csv(dat, file, row.names = FALSE)\n    }\n  )\n  \n  # Progress dots (24 micro-steps)\n  output$progressUI <- renderUI({\n    if (!rv$started) {\n      return(div(class = \"progress-dots\"))\n    }\n    \n    # PRE-QUESTIONNAIRES (before vignettes start)\n    # Hide dots on vignette intro (step 13)\n    if (rv$pre_step == 13L) {\n      return(div(class = \"progress-dots\"))\n    }\n    \n    if (rv$pre_step <= 12) {\n      if (rv$pre_step == 1) {\n        return(div(class = \"progress-dots\")) # No dots for main intro\n      } else if (rv$pre_step == 2) {\n        current_q <- length(rv$pre_answers$demographics) + 1\n        total_q <- 4\n      } else if (rv$pre_step == 4) {\n        current_q <- length(rv$pre_answers$crt) + 1\n        total_q <- 4\n      } else if (rv$pre_step == 6) {\n        current_q <- length(rv$pre_answers$gaais) + 1\n        total_q <- 21\n      } else if (rv$pre_step == 8) {\n        current_q <- length(rv$pre_answers$fwa) + 1\n        total_q <- 2\n      } else if (rv$pre_step == 10) {\n        current_q <- length(rv$pre_answers$teique) + 1\n        total_q <- 30\n      } else if (rv$pre_step == 12) {\n        current_q <- length(rv$pre_answers$mhlc) + 1\n        total_q <- 18\n      } else {\n        return(div(class = \"progress-dots\")) # No dots for other intros\n      }\n      \n      dots <- lapply(1:total_q, function(i) {\n        cls <- \"dot\"\n        if (current_q > i) cls <- paste(cls, \"done\")\n        else if (current_q == i) cls <- paste(cls, \"active\")\n        div(class = cls)\n      })\n      return(div(class = \"progress-dots\", dots))\n    }\n    \n    # Fallback\n    return(div(class = \"progress-dots\"))\n    \n    \n    # VIGNETTES + POST: show a single 33-dot progress bar\n    # Map current position into 1..33\n    total_dots <- 33L\n    current_idx <- 1L\n    \n    if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      # Steps are 1..8 within each vignette; clamp to [1,8]\n      s <- max(1L, min(8L, as.integer(rv$vig_step)))\n      current_idx <- (rv$current_vignette - 1L) * 8L + s  # 1..32\n    } else if (rv$current_vignette == 5L) {\n      # Post-vignette question (single dot, the 33rd)\n      current_idx <- 33L\n    } else {\n      # After completion (rv$current_vignette >= 6)\n      current_idx <- 33L\n    }\n    \n    dots <- lapply(1:total_dots, function(i) {\n      cls <- \"dot\"\n      if (i < current_idx) cls <- paste(cls, \"done\")\n      else if (i == current_idx) cls <- paste(cls, \"active\")\n      div(class = cls)\n    })\n    div(class = \"progress-dots\", dots)\n  })\n  \n  \n  # Top progress bar\n  set_top_progress <- function() {\n    if (!rv$started) {\n      session$sendCustomMessage(\"setTopProgress\", 0)\n      return()\n    }\n    # Linearise position 1..45\n    # Pre: steps 1..13 (13 includes vignette intro)\n    # Vignettes: 4 blocks of 8 steps => 32 steps, indices 13+1 .. 13+32 = 14..45-1\n    # Post: 1 step (index 45)\n    idx <- 0L\n    \n    if (rv$current_vignette == 0L) {\n      # Still in pre (including step 13 vignette intro)\n      idx <- max(1L, min(13L, as.integer(rv$pre_step)))\n    } else if (rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      # 12 pre steps completed fully before entering vignettes\n      s <- max(1L, min(8L, as.integer(rv$vig_step)))\n      idx <- 12L + (rv$current_vignette - 1L) * 8L + s\n      # idx spans 13..44\n    } else if (rv$current_vignette == 5L) {\n      # Post-vignette open question, treat as the 45th \"step\"\n      idx <- 45L\n    } else {\n      # Completed\n      idx <- 45L\n    }\n    \n    pct <- round(idx / 45 * 100)\n    session$sendCustomMessage(\"setTopProgress\", pct)\n  }\n  \n  \n  # Add this function near the top of your server function:\n  calculate_detailed_progress <- function() {\n    if (!rv$started) return(0)\n    \n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 14) {\n      # Pre-questionnaire detailed progress\n      base_progress <- 0\n      \n      # Fixed steps (intros): 1, 3, 5, 7, 9, 11, 13 = 7 steps\n      # Variable steps: 2(4q), 4(4q), 6(21q), 8(2q), 10(31q), 12(18q) = 80 questions\n      # Total pre steps equivalent: 7 + 80 = 87 \"micro-steps\"\n      \n      if (rv$pre_step == 1) {\n        return(1)\n      } else if (rv$pre_step == 2) {\n        # Demographics: 4 questions\n        q_completed <- length(rv$pre_answers$demographics)\n        return(2 + (q_completed * 4) / 4)  # 2-6\n      } else if (rv$pre_step == 3) {\n        return(7)\n      } else if (rv$pre_step == 4) {\n        # CRT: 4 questions\n        q_completed <- length(rv$pre_answers$crt)\n        return(8 + (q_completed * 4) / 4)  # 8-12\n      } else if (rv$pre_step == 5) {\n        return(13)\n      } else if (rv$pre_step == 6) {\n        # GAAIS: 21 questions\n        q_completed <- length(rv$pre_answers$gaais)\n        return(14 + (q_completed * 21) / 21)  # 14-35\n      } else if (rv$pre_step == 7) {\n        return(36)\n      } else if (rv$pre_step == 8) {\n        # FWA: 2 questions\n        q_completed <- length(rv$pre_answers$fwa)\n        return(37 + (q_completed * 2) / 2)  # 37-39\n      } else if (rv$pre_step == 9) {\n        return(40)\n      } else if (rv$pre_step == 10) {\n        # TEIQue: 31 questions (including attention check)\n        q_completed <- length(rv$pre_answers$teique)\n        return(41 + (q_completed * 31) / 31)  # 41-72\n      } else if (rv$pre_step == 11) {\n        return(73)\n      } else if (rv$pre_step == 12) {\n        # MHLC: 18 questions\n        q_completed <- length(rv$pre_answers$mhlc)\n        return(74 + (q_completed * 18) / 18)  # 74-92\n      } else if (rv$pre_step == 13) {\n        return(93)  # Vignette intro\n      }\n    } else if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      # Vignettes: start from step 93, add 32 steps for vignettes\n      s <- max(1L, min(8L, as.integer(rv$vig_step)))\n      return(93 + (rv$current_vignette - 1L) * 8L + s)  # 94-125\n    } else if (rv$current_vignette == 5L) {\n      return(126)  # Post-vignette\n    } else {\n      return(126)  # Completed\n    }\n  }\n  \n  set_detailed_progress <- function() {\n    detailed_step <- calculate_detailed_progress()\n    pct <- round(detailed_step / 126 * 100)  # 126 total micro-steps\n    session$sendCustomMessage(\"setTopProgress\", pct)\n  }\n  \n  # Pre-questionnaire rendering\n  \n  render_pre_questionnaire_screen <- function() {\n    pre_step <- rv$pre_step\n    \n    if (pre_step == 1) {\n      # Main introduction\n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", \"Study Overview\"),\n          div(class = \"desc\", \"You will complete 6 questionnaires before the main study. For your convenience, you will be shown two types of progress indicators. The bar at the top indicates your progress through the entire study, while the dots beneath it indicate your progress through the current set of questions (not displayed on this page).\"),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", \"Begin Questionnaires\", class = \"btn btn-next\")\n              )\n          )\n      )\n    } else if (pre_step == 2) {\n      render_demographics_screen()\n    } else if (pre_step == 3) {\n      render_intro_screen(\"Additional Screening\", \"You will now complete a series of four open-ended questions designed to generate a baseline.\")\n    } else if (pre_step == 4) {\n      render_crt_screen()\n    } else if (pre_step == 5) {\n      render_intro_screen(\"General Attitudes toward AI \", \"You will now complete questions about your attitudes toward artificial intelligence.\")\n    } else if (pre_step == 6) {\n      render_gaais_screen()\n    } else if (pre_step == 7) {\n      render_intro_screen(\"Familiarity with AI\", \"You will now answer questions about your familiarity with artificial intelligence.\")\n    } else if (pre_step == 8) {\n      render_fwa_screen()\n    } else if (pre_step == 9) {\n      render_intro_screen(\"TEIQue\", \"You will now complete a questionnaire that evaluates your level of trait emotional intelligence.\")\n    } else if (pre_step == 10) {\n      render_teique_screen()\n    } else if (pre_step == 11) {\n      render_intro_screen(\"MHLC\", \"You will now complete questions about health beliefs.\")\n    } else if (pre_step == 12) {\n      render_mhlc_screen()\n    } else if (pre_step == 13) {\n      # Vignette introduction\n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", \"Healthcare Scenarios\"),\n          div(class = \"desc\", \"You will now be presented with a series of healthcare scenarios. You will be asked to imagine that you have certain symptoms for which you will receive healthcare advice. Please read it carefully. Following each scenario, you will be asked to share your perspectives on the advice provided.\"),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", \"Begin Vignettes\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_intro_screen <- function(title, description) {\n    div(id = \"screen\", class = \"screen\",\n        div(class = \"title\", title),\n        div(class = \"desc\", description),\n        div(class = \"nav-actions\",\n            actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n            div(class = \"nav-actions-right\",\n                actionButton(\"btn_next\", \"Continue\", class = \"btn btn-next\")\n            )\n        )\n    )\n  }\n  \n  # Individual questionnaire renders\n  \n  render_demographics_screen <- function() {\n    current_q <- length(rv$pre_answers$demographics) + 1\n    total_q <- 4\n    \n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_names <- names(demographics_questions)\n      current_q_name <- q_names[current_q]\n      q_data <- demographics_questions[[current_q_name]]\n      \n      # ADD DEBUG LINE\n      # cat(\"DEBUG: Rendering demographics screen, question\", current_q, \"type:\", q_data$type, \"name:\", current_q_name, \"\\n\")\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"Demographics\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_data$question),\n          \n          if (q_data$type == \"scale\") {\n            # Render as clickable scale\n            existing <- rv$pre_answers$demographics[[current_q_name]] %||% NULL\n            scale_class <- if (current_q_name == \"age\") \"scale-7\" else if (current_q_name == \"gender\") \"scale-3\" else \"scale-6\"\n            \n            div(class = \"scale-wrap\",\n                div(class = paste(\"scale-group\", scale_class), `data-input` = paste0(\"demo_\", current_q_name),\n                    lapply(seq_along(q_data$options), function(i) {\n                      option_text <- q_data$options[i]\n                      div(\n                        class = paste(\"scale-item\", if (!is.null(existing) && existing == option_text) \"selected\"),\n                        `data-value` = as.character(i),\n                        option_text\n                      )\n                    })\n                )\n            )\n          } else {\n            # Use a unique input ID for this specific question\n            input_id <- paste0(\"demo_text_\", current_q_name)  # e.g., \"demo_text_postcode\"\n            \n            # cat(\"DEBUG: Creating textInput with ID:\", input_id, \"\\n\")\n            \n            # ADD AUTOFOCUS TRIGGER HERE\n            session$onFlushed(function() {\n              session$sendCustomMessage(\"autoFocusText\", TRUE)\n            }, once = TRUE)\n            \n            textInput(input_id, NULL, placeholder = \"Enter first two digits (numbers only)\")\n          }\n          ,\n          \n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit Demographics\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_crt_screen <- function() {\n    current_q <- length(rv$pre_answers$crt) + 1\n    total_q <- 4\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      q_text <- crt_questions[[current_q]]\n      \n      # Use unique input ID for CRT questions\n      input_id <- paste0(\"crt_text_q\", current_q)  # e.g., \"crt_text_q1\"\n      \n      # CRT input constraints by question number with character limits\n      if (current_q == 1) {  # Q1: one character (digit)\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter digits only\", width = \"150px\"),\n          maxlength = \"1\"\n        )\n      } else if (current_q == 2) {  # Q2: one character (digit)\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter digits only\", width = \"150px\"),\n          maxlength = \"1\"\n        )\n      } else if (current_q == 3) {  # Q3: Emily question - 10 characters\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter name\", width = \"150px\"),\n          maxlength = \"10\"\n        )\n      } else if (current_q == 4) {  # Q4: three characters\n        crt_input_ui <- tagAppendAttributes(\n          textInput(input_id, NULL, placeholder = \"Enter digits only\", width = \"150px\"),\n          maxlength = \"3\"\n        )\n      }\n      \n      # ADD AUTOFOCUS TRIGGER HERE\n      session$onFlushed(function() {\n        session$sendCustomMessage(\"autoFocusText\", TRUE)\n      }, once = TRUE)\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"Additional Screening\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          crt_input_ui,\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit Baseline\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_gaais_screen <- function() {\n    current_q <- length(rv$pre_answers$gaais) + 1\n    total_q <- 21\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      \n      q_text <- gaais_questions[current_q]\n      existing <- rv$pre_answers$gaais[[paste0(\"q\", current_q)]] %||% NULL\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"GAAIS\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-5\"), `data-input` = \"gaais_q\",\n                  lapply(1:5, function(i) {\n                    labels <- c(\"Strongly Disagree\", \"(Somewhat) Disagree\", \"Neutral\", \"(Somewhat) Agree\", \"Strongly Agree\")\n                    div(\n                      class = paste(\"scale-item\", if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                      `data-value` = as.character(i),\n                      div(style = \"font-size: 14px; font-weight: bold;\", as.character(i)),\n                      div(style = \"font-size: 11px; margin-top: 2px;\", labels[i])\n                    )\n                  })\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit GAAIS\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_fwa_screen <- function() {\n    current_q <- length(rv$pre_answers$fwa) + 1\n    total_q <- 2\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_text <- fwa_questions[current_q]\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"FWA\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-5\"), `data-input` = \"fwa_q\",\n                  lapply(1:5, function(i) {\n                    labels <- c(\"Never\", \"Rarely\", \"Monthly\", \"Weekly\", \"Daily\")\n                    div(\n                      class = paste(\"scale-item\"),\n                      `data-value` = as.character(i),\n                      div(style = \"font-size: 14px; font-weight: bold;\", as.character(i)),\n                      div(style = \"font-size: 11px; margin-top: 2px;\", labels[i])\n                    )\n                  })\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit FWA\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  render_teique_screen <- function() {\n    current_q <- length(rv$pre_answers$teique) + 1\n    total_q <- 31 # plus one for attention check \n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_text <- teique_questions[current_q]\n      existing <- rv$pre_answers$teique[[paste0(\"q\", current_q)]] %||% NULL\n      \n      # Check if this is the attention check question (question 31)\n      is_attention_check <- (current_q == 31)\n      \n      # Don't show TEIQue header for the attention check question\n      title_text <- if (current_q == 31) {\n        paste(\"Kind Request\")\n      } else {\n        paste(\"TEIQue\", current_q, \"of\", 30)\n      }\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", title_text),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"teique_q\",\n                  lapply(1:7, function(i) {\n                    div(\n                      class = paste(\"scale-item\", if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                      `data-value` = as.character(i),\n                      as.character(i)\n                    )\n                  })\n              ),\n              div(class = \"scale-captions\",\n                  div(class = \"scale-caption-left\", \"Completely Disagree\"),\n                  div(class = \"scale-caption-right\", \"Completely Agree\")\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit TEIQue\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n      \n    }\n  }\n  \n  render_mhlc_screen <- function() {\n    current_q <- length(rv$pre_answers$mhlc) + 1\n    total_q <- 18\n    progress_pct <- round((current_q - 1) / total_q * 100)\n    \n    if (current_q <= total_q) {\n      \n      \n      q_text <- mhlc_questions[current_q]\n      existing <- rv$pre_answers$mhlc[[paste0(\"q\", current_q)]] %||% NULL\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", paste(\"MHLC\", current_q, \"of\", total_q)),\n          div(class = \"label\", q_text),\n          div(class = \"scale-wrap\",\n              div(class = paste(\"scale-group\", \"scale-6\"), `data-input` = \"mhlc_q\",\n                  lapply(1:6, function(i) {\n                    div(\n                      class = paste(\"scale-item\", if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                      `data-value` = as.character(i),\n                      as.character(i)\n                    )\n                  })\n              ),\n              div(class = \"scale-captions\",\n                  div(class = \"scale-caption-left\", \"Strongly Disagree\"),\n                  div(class = \"scale-caption-right\", \"Strongly Agree\")\n              )\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", if (current_q == total_q) \"Submit MHLC\" else \"Next\", class = \"btn btn-next\")\n              )\n          )\n      )\n    }\n  }\n  \n  save_demographics_data <- function() {\n    if (length(rv$pre_answers$demographics) != 4) return()\n    \n    demo_row <- data.frame(\n      participant_id = input$participant_id,\n      age        = rv$pre_answers$demographics$age,\n      gender     = rv$pre_answers$demographics$gender,\n      education  = rv$pre_answers$demographics$education,\n      postcode   = rv$pre_answers$demographics$postcode,\n      demo.started_at   = rv$section_started_at$demographics,\n      demo.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(demo_row, \"demographics\")\n  }\n  \n  save_crt_data <- function() {\n    if (length(rv$pre_answers$crt) != 4) return()\n    \n    crt_row <- data.frame(\n      participant_id = input$participant_id,\n      crt.q1 = rv$pre_answers$crt$q1,\n      crt.q2 = rv$pre_answers$crt$q2,\n      crt.q3 = rv$pre_answers$crt$q3,\n      crt.q4 = rv$pre_answers$crt$q4,\n      crt.started_at   = rv$section_started_at$crt,\n      crt.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(crt_row, \"crt\")\n  }\n  \n  \n  save_gaais_data <- function() {\n    if (length(rv$pre_answers$gaais) != 21) return()\n    \n    gaais_row <- data.frame(\n      participant_id = input$participant_id,\n      ga.q1 = rv$pre_answers$gaais$q1, ga.q2 = rv$pre_answers$gaais$q2, ga.q3 = rv$pre_answers$gaais$q3,\n      ga.q4 = rv$pre_answers$gaais$q4, ga.q5 = rv$pre_answers$gaais$q5, ga.q6 = rv$pre_answers$gaais$q6,\n      ga.q7 = rv$pre_answers$gaais$q7, ga.q8 = rv$pre_answers$gaais$q8, ga.q9 = rv$pre_answers$gaais$q9,\n      ga.q10 = rv$pre_answers$gaais$q10, ga.q11 = rv$pre_answers$gaais$q11, \n      ga.q12 = rv$pre_answers$gaais$q12,\n      ga.q13.attentioncheck = rv$pre_answers$gaais$q13, ga.q14 = rv$pre_answers$gaais$q14, \n      ga.q15 = rv$pre_answers$gaais$q15,\n      ga.q16 = rv$pre_answers$gaais$q16, ga.q17 = rv$pre_answers$gaais$q17, \n      ga.q18 = rv$pre_answers$gaais$q18,\n      ga.q19 = rv$pre_answers$gaais$q19, ga.q20 = rv$pre_answers$gaais$q20, \n      ga.q21 = rv$pre_answers$gaais$q21,\n      ga.started_at   = rv$section_started_at$gaais,\n      ga.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(gaais_row, \"gaais\")\n  }\n  \n  save_fwa_data <- function() {\n    if (length(rv$pre_answers$fwa) != 2) return()\n    \n    fwa_row <- data.frame(\n      participant_id = input$participant_id,\n      fwa.q1 = rv$pre_answers$fwa$q1,\n      fwa.q2 = rv$pre_answers$fwa$q2,\n      fwa.started_at   = rv$section_started_at$fwa,\n      fwa.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(fwa_row, \"fwa\")\n  }\n  \n  save_teique_data <- function() {\n    if (length(rv$pre_answers$teique) != 31) return()\n    \n    teique_row <- data.frame(\n      participant_id = input$participant_id,\n      tq.q1 = rv$pre_answers$teique$q1, tq.q2 = rv$pre_answers$teique$q2, tq.q3 = rv$pre_answers$teique$q3,\n      tq.q4 = rv$pre_answers$teique$q4, tq.q5 = rv$pre_answers$teique$q5, tq.q6 = rv$pre_answers$teique$q6,\n      tq.q7 = rv$pre_answers$teique$q7, tq.q8 = rv$pre_answers$teique$q8, tq.q9 = rv$pre_answers$teique$q9,\n      tq.q10 = rv$pre_answers$teique$q10, tq.q11 = rv$pre_answers$teique$q11, tq.q12 = rv$pre_answers$teique$q12,\n      tq.q13 = rv$pre_answers$teique$q13, tq.q14 = rv$pre_answers$teique$q14, tq.q15 = rv$pre_answers$teique$q15,\n      tq.q16 = rv$pre_answers$teique$q16, tq.q17 = rv$pre_answers$teique$q17, tq.q18 = rv$pre_answers$teique$q18,\n      tq.q19 = rv$pre_answers$teique$q19, tq.q20 = rv$pre_answers$teique$q20, tq.q21 = rv$pre_answers$teique$q21,\n      tq.q22 = rv$pre_answers$teique$q22, tq.q23 = rv$pre_answers$teique$q23, tq.q24 = rv$pre_answers$teique$q24,\n      tq.q25 = rv$pre_answers$teique$q25, tq.q26 = rv$pre_answers$teique$q26, tq.q27 = rv$pre_answers$teique$q27,\n      tq.q28 = rv$pre_answers$teique$q28, tq.q29 = rv$pre_answers$teique$q29, tq.q30 = rv$pre_answers$teique$q30,\n      tq.attentioncheck = rv$pre_answers$teique$q31, # new attention check!\n      tq.started_at   = rv$section_started_at$teique,\n      tq.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(teique_row, \"teique\")\n  }\n  \n  save_mhlc_data <- function() {\n    if (length(rv$pre_answers$mhlc) != 18) return()\n    \n    mhlc_row <- data.frame(\n      participant_id = input$participant_id,\n      mhlc.q1 = rv$pre_answers$mhlc$q1, mhlc.q2 = rv$pre_answers$mhlc$q2, mhlc.q3 = rv$pre_answers$mhlc$q3,\n      mhlc.q4 = rv$pre_answers$mhlc$q4, mhlc.q5 = rv$pre_answers$mhlc$q5, mhlc.q6 = rv$pre_answers$mhlc$q6,\n      mhlc.q7 = rv$pre_answers$mhlc$q7, mhlc.q8 = rv$pre_answers$mhlc$q8, mhlc.q9 = rv$pre_answers$mhlc$q9,\n      mhlc.q10 = rv$pre_answers$mhlc$q10, mhlc.q11 = rv$pre_answers$mhlc$q11, \n      mhlc.q12 = rv$pre_answers$mhlc$q12,\n      mhlc.q13 = rv$pre_answers$mhlc$q13, mhlc.q14 = rv$pre_answers$mhlc$q14, \n      mhlc.q15 = rv$pre_answers$mhlc$q15,\n      mhlc.q16 = rv$pre_answers$mhlc$q16, mhlc.q17 = rv$pre_answers$mhlc$q17, \n      mhlc.q18 = rv$pre_answers$mhlc$q18,\n      mhlc.started_at   = rv$section_started_at$mhlc,\n      mhlc.submitted_at = Sys.time(),\n      stringsAsFactors = FALSE\n    )\n    \n    save_to_table(mhlc_row, \"mhlc\")\n  }\n  \n  \n  # Helper function to save to different tables\n  save_to_table <- function(row, table_name) {\n    if (!is.null(rv$sb_access_token) && nzchar(rv$sb_access_token)) {\n      tryCatch({\n        # Create custom save function for different table\n        url <- paste0(SUPABASE_URL, \"/rest/v1/\", table_name)\n        \n        # UTC formatting for POSIXct columns\n        for (i in seq_along(row)) {\n          if (inherits(row[[i]], \"POSIXct\")) {\n            row[[i]] <- strftime(as.POSIXct(row[[i]], tz = \"UTC\"), \"%Y-%m-%dT%H:%M:%SZ\", tz = \"UTC\")\n          }\n        }\n        \n        headers <- add_headers(\n          `apikey` = SUPABASE_KEY,\n          `Authorization` = paste(\"Bearer\", rv$sb_access_token),\n          `Content-Type` = \"application/json\",\n          `Accept` = \"application/json\",\n          `Prefer` = \"return=minimal\",\n          `Content-Profile` = \"public\",\n          `Accept-Profile` = \"public\"\n        )\n        \n        json_body <- toJSON(row, auto_unbox = TRUE, na = \"null\")\n        res <- POST(url, headers, body = json_body)\n        status <- status_code(res)\n        \n        if (status >= 200 && status < 300) {\n          showNotification(paste(toupper(table_name), \"data saved to remote database.\"), type = \"message\", duration = 3)\n          return(TRUE)\n        } else {\n          txt <- content(res, as = \"text\", encoding = \"UTF-8\")\n          stop(sprintf(\"Supabase insert failed (%s): %s\", status, txt))\n        }\n      }, error = function(e) {\n        showModal(modalDialog(\n          title = \"Supabase Save Error\",\n          paste(\"Error saving\", table_name, \"data:\", e$message),\n          easyClose = TRUE\n        ))\n      })\n    }\n  }\n  \n  # helper for postcodes\n  \n  # Replace your validate_postcode function with this complete mapping:\n  validate_postcode <- function(postcode) {\n    postcode_map <- list(\n      # District 01: Raffles Place, Cecil, Marina, People's Park\n      \"01\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"02\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"03\" = \"Raffles Place / Cecil / Marina / People's Park\", \n      \"04\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"05\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \"06\" = \"Raffles Place / Cecil / Marina / People's Park\",\n      \n      # District 02: Anson, Tanjong Pagar\n      \"07\" = \"Anson / Tanjong Pagar\",\n      \"08\" = \"Anson / Tanjong Pagar\",\n      \n      # District 03: Queenstown, Tiong Bahru\n      \"14\" = \"Queenstown / Tiong Bahru\",\n      \"15\" = \"Queenstown / Tiong Bahru\", \n      \"16\" = \"Queenstown / Tiong Bahru\",\n      \n      # District 04: Telok Blangah, Harbourfront\n      \"09\" = \"Telok Blangah / Harbourfront\",\n      \"10\" = \"Telok Blangah / Harbourfront\",\n      \n      # District 05: Pasir Panjang, Hong Leong Garden, Clementi New Town\n      \"11\" = \"Pasir Panjang / Hong Leong Garden / Clementi New Town\",\n      \"12\" = \"Pasir Panjang / Hong Leong Garden / Clementi New Town\",\n      \"13\" = \"Pasir Panjang / Hong Leong Garden / Clementi New Town\",\n      \n      # District 06: High Street, Beach Road (part)\n      \"17\" = \"High Street / Beach Road\",\n      \n      # District 07: Middle Road, Golden Mile\n      \"18\" = \"Middle Road / Golden Mile\",\n      \"19\" = \"Middle Road / Golden Mile\",\n      \n      # District 08: Little India\n      \"20\" = \"Little India\",\n      \"21\" = \"Little India\",\n      \n      # District 09: Orchard, Cairnhill, River Valley\n      \"22\" = \"Orchard / Cairnhill / River Valley\",\n      \"23\" = \"Orchard / Cairnhill / River Valley\",\n      \n      # District 10: Ardmore, Bukit Timah, Holland Road, Tanglin\n      \"24\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \"25\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \"26\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \"27\" = \"Ardmore / Bukit Timah / Holland Road / Tanglin\",\n      \n      # District 11: Watten Estate, Novena, Thomson\n      \"28\" = \"Watten Estate / Novena / Thomson\",\n      \"29\" = \"Watten Estate / Novena / Thomson\",\n      \"30\" = \"Watten Estate / Novena / Thomson\",\n      \n      # District 12: Balestier, Toa Payoh, Serangoon\n      \"31\" = \"Balestier / Toa Payoh / Serangoon\",\n      \"32\" = \"Balestier / Toa Payoh / Serangoon\",\n      \"33\" = \"Balestier / Toa Payoh / Serangoon\",\n      \n      # District 13: Macpherson, Braddell\n      \"34\" = \"Macpherson / Braddell\",\n      \"35\" = \"Macpherson / Braddell\",\n      \"36\" = \"Macpherson / Braddell\",\n      \"37\" = \"Macpherson / Braddell\",\n      \n      # District 14: Geylang, Eunos\n      \"38\" = \"Geylang / Eunos\",\n      \"39\" = \"Geylang / Eunos\",\n      \"40\" = \"Geylang / Eunos\",\n      \"41\" = \"Geylang / Eunos\",\n      \n      # District 15: Katong, Joo Chiat, Amber Road\n      \"42\" = \"Katong / Joo Chiat / Amber Road\",\n      \"43\" = \"Katong / Joo Chiat / Amber Road\",\n      \"44\" = \"Katong / Joo Chiat / Amber Road\",\n      \"45\" = \"Katong / Joo Chiat / Amber Road\",\n      \n      # District 16: Bedok, Upper East Coast, Eastwood, Kew Drive\n      \"46\" = \"Bedok / Upper East Coast / Eastwood / Kew Drive\",\n      \"47\" = \"Bedok / Upper East Coast / Eastwood / Kew Drive\",\n      \"48\" = \"Bedok / Upper East Coast / Eastwood / Kew Drive\",\n      \n      # District 17: Loyang, Changi\n      \"49\" = \"Loyang / Changi\",\n      \"50\" = \"Loyang / Changi\",\n      \"81\" = \"Loyang / Changi\",\n      \n      # District 18: Tampines, Pasir Ris\n      \"51\" = \"Tampines / Pasir Ris\",\n      \"52\" = \"Tampines / Pasir Ris\",\n      \n      # District 19: Serangoon Garden, Hougang, Punggol\n      \"53\" = \"Serangoon Garden / Hougang / Punggol\",\n      \"54\" = \"Serangoon Garden / Hougang / Punggol\",\n      \"55\" = \"Serangoon Garden / Hougang / Punggol\",\n      \"82\" = \"Serangoon Garden / Hougang / Punggol\",\n      \n      # District 20: Bishan, Ang Mo Kio\n      \"56\" = \"Bishan / Ang Mo Kio\",\n      \"57\" = \"Bishan / Ang Mo Kio\",\n      \n      # District 21: Upper Bukit Timah, Clementi Park, Ulu Pandan\n      \"58\" = \"Upper Bukit Timah / Clementi Park / Ulu Pandan\",\n      \"59\" = \"Upper Bukit Timah / Clementi Park / Ulu Pandan\",\n      \n      # District 22: Jurong\n      \"60\" = \"Jurong\",\n      \"61\" = \"Jurong\",\n      \"62\" = \"Jurong\",\n      \"63\" = \"Jurong\",\n      \"64\" = \"Jurong\",\n      \n      # District 23: Hillview, Dairy Farm, Bukit Panjang, Choa Chu Kang\n      \"65\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \"66\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \"67\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \"68\" = \"Hillview / Dairy Farm / Bukit Panjang / Choa Chu Kang\",\n      \n      # District 24: Lim Chu Kang, Tengah\n      \"69\" = \"Lim Chu Kang / Tengah\",\n      \"70\" = \"Lim Chu Kang / Tengah\",\n      \"71\" = \"Lim Chu Kang / Tengah\",\n      \n      # District 25: Kranji, Woodgrove\n      \"72\" = \"Kranji / Woodgrove\",\n      \"73\" = \"Kranji / Woodgrove\",\n      \n      # District 26: Upper Thomson, Springleaf\n      \"77\" = \"Upper Thomson / Springleaf\",\n      \"78\" = \"Upper Thomson / Springleaf\",\n      \n      # District 27: Yishun, Sembawang\n      \"75\" = \"Yishun / Sembawang\",\n      \"76\" = \"Yishun / Sembawang\",\n      \n      # District 28: Seletar\n      \"79\" = \"Seletar\",\n      \"80\" = \"Seletar\"\n    )\n    \n    # Return the neighborhood name if valid, NULL if invalid\n    return(postcode_map[[postcode]])\n  }\n  \n  # Add the confirmation handler\n  show_postcode_confirmation <- function(postcode, neighborhood) {\n    session$sendCustomMessage('showPostcodeConfirmation', list(\n      postcode = postcode,\n      neighborhood = neighborhood\n    ))\n  }\n  \n  handle_pre_questionnaire_step <- function() {\n    pre_step <- rv$pre_step\n    \n    if (pre_step %in% c(1, 3, 5, 7, 9, 11)) {\n      # Intro screens - just advance\n      rv$pre_step <- rv$pre_step + 1L\n      session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n      return()\n      \n      \n    } else if (pre_step == 2) {\n      # Demographics\n      current_q_num <- length(rv$pre_answers$demographics) + 1\n      \n      # Demographics started_at when first question appears\n      if (current_q_num == 1L && is.na(rv$section_started_at$demographics)) {\n        rv$section_started_at$demographics <- Sys.time()\n      }\n      \n      q_names <- names(demographics_questions)\n      current_q_name <- q_names[current_q_num]\n      q_data <- demographics_questions[[current_q_name]]\n      \n      if (q_data$type == \"scale\") {\n        answer_index <- as.integer(input[[paste0(\"demo_\", current_q_name)]] %||% \"0\")\n        if (answer_index == 0) {\n          # Try to restore from buffer\n          buf_val <- rv$popped_answers$demographics[[current_q_name]]\n          if (!is.null(buf_val)) {\n            rv$pre_answers$demographics[[current_q_name]] <- buf_val\n            rv$popped_answers$demographics[[current_q_name]] <- NULL\n            answer_restored <- TRUE\n          } else {\n            showModal(modalDialog(title = \"Missing Answer\", \"Please provide an answer.\", easyClose = TRUE))\n            return()\n          }\n        } else {\n          answer_text <- q_data$options[answer_index]\n          rv$pre_answers$demographics[[current_q_name]] <- answer_text\n          rv$pre_q_completed$demographics[current_q_num] <- Sys.time()\n          \n          rv$popped_answers$demographics[[current_q_name]] <- NULL  # clear buffer\n          check_response_patterns()\n          \n          set_detailed_progress()  \n          \n        }\n      } else {\n        input_id <- paste0(\"demo_text_\", current_q_name)\n        answer <- trimws(input[[input_id]] %||% \"\")\n        \n        if (!nzchar(answer)) {\n          buf_val <- rv$popped_answers$demographics[[current_q_name]]\n          if (!is.null(buf_val)) {\n            rv$pre_answers$demographics[[current_q_name]] <- buf_val\n            rv$popped_answers$demographics[[current_q_name]] <- NULL\n          } else {\n            showModal(modalDialog(title = \"Missing Answer\", \"Please provide an answer.\", easyClose = TRUE))\n            return()\n          }\n        } else {\n          # Basic format validation\n          if (!grepl(\"^[0-9]{2}$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Postcode\", \"Please enter exactly 2 digits (numbers only).\", easyClose = TRUE))\n            return()\n          }\n          \n          # Check if it's a valid postcode\n          neighborhood <- validate_postcode(answer)\n          if (!is.null(neighborhood)) {\n            # Valid postcode - show confirmation\n            show_postcode_confirmation(answer, neighborhood)\n            return()  # Don't proceed until user confirms\n          } else {\n            # Invalid postcode - show error\n            showModal(modalDialog(\n              title = \"Unrecognized Postcode\", \n              paste(\"We don't recognize the postcode\", answer, \"in our system. Please double-check and enter the first two digits of your postcode.\"),\n              easyClose = TRUE\n            ))\n            return()\n          }\n        }\n      }\n      \n      \n      if (current_q_num < 4) {\n        # Clear inputs for next question\n        updateTextInput(session, \"current_answer\", value = \"\")\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = paste0('demo_', current_q_name)))\n      } else {\n        # Complete demographics - save and move to next\n        save_demographics_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))   \n        \n      }\n      \n    } else if (pre_step == 4) {\n      q_num <- length(rv$pre_answers$crt) + 1\n      input_id <- paste0(\"crt_text_q\", q_num)\n      \n      answer <- trimws(input[[input_id]] %||% \"\")\n      q_name <- paste0(\"q\", q_num)\n      \n      if (length(rv$pre_answers$crt) == 0L && is.na(rv$section_started_at$crt)) {\n        rv$section_started_at$crt <- Sys.time()\n      }\n      \n      # Enhanced validation by question with character limits\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$crt[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$crt[[q_name]] <- buf_val\n          rv$popped_answers$crt[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please provide an answer.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        # Character and content validation by question\n        if (q_num == 1) {  # Q1: single digit\n          if (nchar(answer) != 1) {\n            showModal(modalDialog(title = \"Invalid Length\", \"Please enter exactly 1 digit.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[0-9]$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter a single digit (0-9).\", easyClose = TRUE))\n            return()\n          }\n        } else if (q_num == 2) {  # Q2: single digit\n          if (nchar(answer) != 1) {\n            showModal(modalDialog(title = \"Invalid Length\", \"Please enter exactly 1 digit.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[0-9]$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter a single digit (0-9).\", easyClose = TRUE))\n            return()\n          }\n        } else if (q_num == 3) {  # Q3: Emily question - up to 10 characters, letters only\n          if (nchar(answer) > 10) {\n            showModal(modalDialog(title = \"Too Long\", \"Please enter 10 characters or fewer.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[A-Za-z]+$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter letters only (no numbers or symbols).\", easyClose = TRUE))\n            return()\n          }\n        } else if (q_num == 4) {  # Q4: up to 3 characters, digits only\n          if (nchar(answer) > 3) {\n            showModal(modalDialog(title = \"Too Long\", \"Please enter 3 characters or fewer.\", easyClose = TRUE))\n            return()\n          }\n          if (!grepl(\"^[0-9]+$\", answer)) {\n            showModal(modalDialog(title = \"Invalid Input\", \"Please enter digits only.\", easyClose = TRUE))\n            return()\n          }\n        }\n        \n        rv$pre_answers$crt[[q_name]] <- answer\n        rv$pre_q_completed$crt[q_num] <- Sys.time()\n        rv$popped_answers$crt[[q_name]] <- NULL\n        check_response_patterns()\n        set_detailed_progress()\n      }\n      \n      if (q_num < 4) {\n        updateTextInput(session, \"current_answer\", value = \"\")\n      } else {\n        save_crt_data()\n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n      }\n    } else if (pre_step == 6) {\n      # GAAIS\n      answer <- input$gaais_q %||% \"\"\n      q_num <- length(rv$pre_answers$gaais) + 1\n      if (length(rv$pre_answers$gaais) == 0L && is.na(rv$section_started_at$gaais)) {\n        rv$section_started_at$gaais <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$gaais[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$gaais[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$gaais[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$gaais[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$gaais[q_num] <- Sys.time()\n        \n        rv$popped_answers$gaais[[q_name]] <- NULL  # clear buffer\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      \n      if (q_num < 21) {\n        # Reset scale selection\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'gaais_q'))\n      } else {\n        save_gaais_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))   \n        \n      }\n      \n    } else if (pre_step == 8) {\n      # FWA\n      answer <- input$fwa_q %||% \"\"\n      q_num <- length(rv$pre_answers$fwa) + 1\n      if (length(rv$pre_answers$fwa) == 0L && is.na(rv$section_started_at$fwa)) {\n        rv$section_started_at$fwa <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$fwa[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$fwa[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$fwa[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$fwa[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$fwa[q_num] <- Sys.time()\n        \n        rv$popped_answers$fwa[[q_name]] <- NULL  # clear buffer\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      if (q_num < 2) {\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'fwa_q'))\n      } else {\n        save_fwa_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))   \n        \n      }\n      \n    } else if (pre_step == 10) {\n      # TEIQue\n      answer <- input$teique_q %||% \"\"\n      q_num <- length(rv$pre_answers$teique) + 1\n      if (length(rv$pre_answers$teique) == 0L && is.na(rv$section_started_at$teique)) {\n        rv$section_started_at$teique <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$teique[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$teique[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$teique[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$teique[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$teique[q_num] <- Sys.time()\n        \n        rv$popped_answers$teique[[q_name]] <- NULL  # clear buffer\n        \n        # ADD THE ATTENTION CHECK HERE:\n        if (q_num == 31 && as.integer(answer) != 1) {\n          rv$attention_check_failed <- TRUE\n          show_blocking_warning(\n            title = \"Attention Check Failed\",\n            message = \"The previous question specifically asked you to select 'Completely Disagree' but you selected a different option. Please read all instructions carefully throughout the study.\",\n            duration = 15\n          )\n        }\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      \n      if (q_num < 31) {\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'teique_q'))\n      } else {\n        save_teique_data()\n        \n        rv$pre_step <- rv$pre_step + 1L\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n        \n      }\n      \n    } else if (pre_step == 12) {\n      # MHLC - last questionnaire\n      answer <- input$mhlc_q %||% \"\"\n      q_num <- length(rv$pre_answers$mhlc) + 1\n      if (length(rv$pre_answers$mhlc) == 0L && is.na(rv$section_started_at$mhlc)) {\n        rv$section_started_at$mhlc <- Sys.time()\n      }\n      q_name <- paste0(\"q\", q_num)\n      if (!nzchar(answer)) {\n        buf_val <- rv$popped_answers$mhlc[[q_name]]\n        if (!is.null(buf_val)) {\n          rv$pre_answers$mhlc[[q_name]] <- as.integer(buf_val)\n          rv$popped_answers$mhlc[[q_name]] <- NULL\n        } else {\n          showModal(modalDialog(title = \"Missing Answer\", \"Please select a rating.\", easyClose = TRUE))\n          return()\n        }\n      } else {\n        rv$pre_answers$mhlc[[q_name]] <- as.integer(answer)\n        rv$pre_q_completed$mhlc[q_num] <- Sys.time()\n        \n        rv$popped_answers$mhlc[[q_name]] <- NULL  # clear buffer\n        check_response_patterns()\n        \n        set_detailed_progress()  \n        \n      }\n      \n      \n      if (q_num < 18) {\n        session$sendCustomMessage('resetPreStepInputs', list(step = pre_step, id = 'mhlc_q'))\n      } else {\n        save_mhlc_data()\n        \n        # After MHLC completion, move to vignette intro\n        rv$pre_step <- 13L  # Move to vignette intro\n        session$sendCustomMessage('setPreStep', list(step = rv$pre_step))    \n        \n      }\n      \n    } else if (pre_step == 13) {\n      # 1) Generate vignettes with optional seed (only once, when starting vignettes)\n      seed_val <- suppressWarnings(as.integer(input$seed))\n      rv$vignettes <- generate_balanced_vignettes(\n        seed = if (!is.na(seed_val)) seed_val else NULL\n      )\n      \n      # 2) Switch to Vignette 1, Step 1\n      rv$current_vignette <- 1L\n      rv$vig_step <- 1L\n      \n      # 3) Record vignette start time (only once)\n      if (is.na(rv$vignette_started_at[1])) {\n        rv$vignette_started_at[1] <- Sys.time()\n      }\n      sync_question_vig_step()\n      \n    }\n  }\n  \n  \n  # Data compile for CSV:\n  compile_all_data <- function() {\n    tryCatch({\n      # Start with a copy of vignette data structure\n      all_data <- rv$responses\n      \n      # Get the exact column structure from rv$responses\n      template_row <- all_data[1, , drop = FALSE]\n      if (nrow(all_data) > 0) {\n        template_row[1, ] <- NA  # Clear the values but keep structure\n      } else {\n        # Create template if no vignette data exists\n        template_row <- data.frame(\n          participant_id = character(1),\n          vignette_number = integer(1),\n          provider = character(1),\n          severity = character(1),\n          advice_len = character(1),\n          q_take_advice = logical(1),\n          q_perceived_accuracy = integer(1),\n          q_trustworthiness = integer(1),\n          q_concern_condition = integer(1),\n          q_concern_circumstances = integer(1),\n          post_vignette_response = character(1),\n          started_at = as.POSIXct(character(1)),\n          submitted_at = as.POSIXct(character(1)),\n          stringsAsFactors = FALSE\n        )\n      }\n      \n      # Helper function to create rows with correct structure\n      create_pre_row <- function(q_type, q_name, response, started_time) {\n        new_row <- template_row\n        new_row$participant_id <- input$participant_id\n        new_row$vignette_number <- 0L  # Use 0 for pre-questionnaire\n        new_row$provider <- paste0(\"PRE_\", toupper(q_type))\n        new_row$severity <- paste0(toupper(q_type), \"_\", q_name)\n        new_row$advice_len <- toupper(q_type)\n        new_row$q_take_advice <- NA\n        new_row$q_perceived_accuracy <- NA_integer_\n        new_row$q_trustworthiness <- NA_integer_\n        new_row$q_concern_condition <- NA_integer_\n        new_row$q_concern_circumstances <- NA_integer_\n        new_row$post_vignette_response <- as.character(response)\n        new_row$started_at <- started_time\n        new_row$submitted_at <- started_time\n        return(new_row)\n      }\n      \n      # Add demographics data\n      if (length(rv$pre_answers$demographics) > 0) {\n        for (q_name in names(rv$pre_answers$demographics)) {\n          new_row <- create_pre_row(\"demographics\", q_name, \n                                    rv$pre_answers$demographics[[q_name]], \n                                    rv$section_started_at$demographics)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add CRT data\n      if (length(rv$pre_answers$crt) > 0) {\n        for (q_name in names(rv$pre_answers$crt)) {\n          new_row <- create_pre_row(\"crt\", q_name, \n                                    rv$pre_answers$crt[[q_name]], \n                                    rv$section_started_at$crt)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add GAAIS data\n      if (length(rv$pre_answers$gaais) > 0) {\n        for (q_name in names(rv$pre_answers$gaais)) {\n          new_row <- create_pre_row(\"gaais\", q_name, \n                                    rv$pre_answers$gaais[[q_name]], \n                                    rv$section_started_at$gaais)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add FWA data\n      if (length(rv$pre_answers$fwa) > 0) {\n        for (q_name in names(rv$pre_answers$fwa)) {\n          new_row <- create_pre_row(\"fwa\", q_name, \n                                    rv$pre_answers$fwa[[q_name]], \n                                    rv$section_started_at$fwa)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add TEIQue data (including attention check)\n      if (length(rv$pre_answers$teique) > 0) {\n        for (q_name in names(rv$pre_answers$teique)) {\n          new_row <- create_pre_row(\"teique\", q_name, \n                                    rv$pre_answers$teique[[q_name]], \n                                    rv$section_started_at$teique)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      # Add MHLC data\n      if (length(rv$pre_answers$mhlc) > 0) {\n        for (q_name in names(rv$pre_answers$mhlc)) {\n          new_row <- create_pre_row(\"mhlc\", q_name, \n                                    rv$pre_answers$mhlc[[q_name]], \n                                    rv$section_started_at$mhlc)\n          all_data <- rbind(all_data, new_row)\n        }\n      }\n      \n      return(all_data)\n      \n    }, error = function(e) {\n      cat(\"Error in compile_all_data:\", e$message, \"\\n\")\n      return(rv$responses)  # Return original data if error\n    })\n  }\n  \n  # Screen UI\n  output$screenUI <- renderUI({\n    if (!rv$started) {\n      div(id = \"screen\", class=\"screen\",\n          div(class = \"title\", \"Welcome\"),\n          div(class = \"desc\",\n              \"Once you have clicked â€˜Start,â€™ you will begin the questionnaire experience. To navigate, you can click the on-screen buttons or use the keyboard: Hit Enter to continue, Shift+Enter to go back, Y/N for Yes and No, and the number keys for the corresponding selections.\"\n          ),\n          tagAppendAttributes(\n            textInput(\"participant_id\", NULL, \n                      placeholder = \"Participant ID (First and last name)\")\n          ),\n          textInput(\"seed\", NULL, placeholder = \"Optional randomisation seed\"),\n          textInput(\"sb_email\", NULL, placeholder = \"Supabase email (optional)\"),\n          passwordInput(\"sb_password\", NULL, \n                        placeholder = \"Supabase password (optional)\"),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_sb_login\", \n                           \"Sign in (Optional)\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_start\", \"Start\", class = \"btn btn-next\")\n              )\n          ),\n          div(class = \"footer\", \"\"),\n          # Admin - guarded by a passphrase to reveal controls\n          # Clickable bar that reveals the Admin Key + Unlock button\n          tags$a(\n            class = \"admin-toggle collapsed\",\n            `data-bs-toggle` = \"collapse\",\n            href = \"#adminKeyCollapse\",\n            role = \"button\",\n            `aria-expanded` = \"false\",\n            `aria-controls` = \"adminKeyCollapse\",\n            tags$span(class = \"chev\", HTML(\"&#9656;\")),  # â–º\n            \"Admin\"\n          ),\n          div(\n            id = \"adminKeyCollapse\",\n            class = \"collapse admin-guard-panel\",\n            div(class = \"label\", \"Enter Admin Key\"),\n            passwordInput(\"admin_key\", NULL, placeholder = \"Admin key\", width = \"260px\"),\n            actionButton(\"admin_unlock\", \"Unlock Admin\", class = \"btn btn-back\")\n          ),\n          \n          # Static tools panel (only shown after unlock)\n          uiOutput(\"adminPanel\")\n      )\n    } \n    \n    # Show pre-questionnaire (including pre_step 13 vignette splash) only before vignettes start\n    else if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 13) {\n      render_pre_questionnaire_screen()\n    }\n    \n    \n    else if (rv$current_vignette >= 1 && rv$current_vignette <= 4) {\n      v <- rv$vignettes[rv$current_vignette, ]\n      cond <- condition_text(v$severity)\n      prov_text <- provider_text(v$provider)\n      adv  <- advice_text(v$severity, v$advice_len)\n      bullets <- summary_bullets(v$severity)\n      icon <- provider_icon(v$provider)\n      \n      # Sticky summary appears from step 2 onward\n      sticky <- if (rv$vig_step >= 2L) {\n        div(class = \"sticky-summary\",\n            div(class = \"sticky-summary-title\", icon, cond$title),\n            tags$ul(class = \"sticky-summary-ul\",\n                    tags$li(bullets[1]),\n                    tags$li(bullets[2])\n            )\n        )\n      } else NULL\n      \n      # Step 1: Symptoms only\n      if (rv$vig_step == 1L) {\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4: \", cond$title)),\n            div(class = \"desc\", cond$description),\n            div(class = \"nav-actions\",\n                actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                div(class = \"nav-actions-right\",\n                    actionButton(\"btn_next\", \"Seek medical advice\", class = \"btn btn-next\")\n                )\n            )\n        )\n        \n        # Step 2: Reveal provider\n      } else if (rv$vig_step == 2L) {\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"Your case has been assigned.\"),\n                    div(class = \"desc\", prov_text),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Receive advice\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 3: Reveal advice\n      } else if (rv$vig_step == 3L) {\n        # Mark advice as \"long\" when it exceeds a threshold (adjust as needed)\n        is_long <- nchar(adv) > 500\n        \n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"Advice:\"),\n                    # Use \"desc long\" when is_long is TRUE, otherwise just \"desc\"\n                    div(class = if (is_long) \"desc long\" else \"desc\", adv),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Continue\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                if (!is_long) div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 4: Q1 Yes/No (Typeform boxes)\n      } else if (rv$vig_step == 4L) {\n        existing <- rv$answers[[rv$current_vignette]]$q1 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"I would be likely to take this advice, precisely as stated.\"),\n                    div(class = paste(\"scale-group\", \"scale-2\"), `data-input` = \"q1\",\n                        div(class = paste(\"scale-item\", if (!is.null(existing) && existing == \"Yes\") \"selected\"),\n                            `data-value` = \"Yes\", \"Yes\"\n                        ),\n                        div(class = paste(\"scale-item\", if (!is.null(existing) && existing == \"No\") \"selected\"),\n                            `data-value` = \"No\", \"No\"\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 5: Q2 (1..7) with end captions (Very inaccurate ... Very accurate)\n      } else if (rv$vig_step == 5L) {\n        existing <- rv$answers[[rv$current_vignette]]$q2 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"To me, the advice seemedâ€¦\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q2\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Very inaccurate\"),\n                            div(class = \"scale-caption-right\", \"Very accurate\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 6: Q3 (1..7) with end captions (Not trustworthy at all ... Completely trustworthy)\n      } else if (rv$vig_step == 6L) {\n        existing <- rv$answers[[rv$current_vignette]]$q3 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"I felt that the advice that I was given wasâ€¦\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q3\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Not trustworthy at all\"),\n                            div(class = \"scale-caption-right\", \"Completely trustworthy\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        \n        # Step 7: Q4 (1..7) Concern provider wouldn't recognize uniqueness of medical condition\n      } else if (rv$vig_step == 7L) {\n        existing <- rv$answers[[rv$current_vignette]]$q4 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"In this scenario, how concerned are you that this provider would not recognize the uniqueness of your medical condition?\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q4\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Not at all\"),\n                            div(class = \"scale-caption-right\", \"Very much\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\", \"Next\", class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n        \n        # Step 8: Q5 (1..7) Concern provider wouldn't recognize unique circumstances\n      } else if (rv$vig_step == 8L) {\n        existing <- rv$answers[[rv$current_vignette]]$q5 %||% NULL\n        div(id = \"screen\", class = \"screen\",\n            div(class = \"screen-content\",\n                div(class = \"main-pane\",\n                    div(class = \"title\", paste0(\"Vignette \", rv$current_vignette, \" of 4\")),\n                    div(class = \"label\", \"In this scenario, how concerned are you that this provider would not recognize your unique circumstances?\"),\n                    div(class = \"scale-wrap\",\n                        div(class = paste(\"scale-group\", \"scale-7\"), `data-input` = \"q5\",\n                            lapply(1:7, function(i) {\n                              div(\n                                class = paste(\"scale-item\",\n                                              if (!is.null(existing) && as.character(existing) == as.character(i)) \"selected\"),\n                                `data-value` = as.character(i),\n                                as.character(i)\n                              )\n                            })\n                        ),\n                        div(class = \"scale-captions\",\n                            div(class = \"scale-caption-left\",  \"Not at all\"),\n                            div(class = \"scale-caption-right\", \"Very much\")\n                        )\n                    ),\n                    div(class = \"nav-actions\",\n                        actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n                        div(class = \"nav-actions-right\",\n                            actionButton(\"btn_next\",\n                                         if (rv$current_vignette < 4) \"Submit & Next Vignette\" else \"Submit & Finish\",\n                                         class = \"btn btn-next\")\n                        )\n                    )\n                ),\n                div(class = \"sticky-aside\", sticky)\n            )\n        )\n      }\n    } else if (rv$current_vignette == 5 && rv$vig_step == 1) {\n      # Post-vignette question - open-ended\n      existing <- rv$post_vignette_answer\n      \n      # ADD AUTOFOCUS TRIGGER HERE\n      session$onFlushed(function() {\n        session$sendCustomMessage(\"autoFocusText\", TRUE)\n      }, once = TRUE)\n      \n      div(id = \"screen\", class = \"screen\",\n          div(class = \"title\", \"Final Question\"),\n          div(class = \"label\", \"Did you prefer receiving advice from the doctor or the AI overall? If so, why did you prefer one or the other?\"),\n          textAreaInput(\n            inputId = \"post_q_text\",\n            label = NULL,\n            value = existing %||% \"\",\n            placeholder = \"Type your response here... (400 words maximum)\",\n            rows = 6,\n            width = \"100%\",\n          ),\n          div(class = \"nav-actions\",\n              actionButton(\"btn_back\", \"Back\", class = \"btn btn-back\"),\n              div(class = \"nav-actions-right\",\n                  actionButton(\"btn_next\", \"Submit & Finish\", class = \"btn btn-next\")\n              )\n          )\n      )\n    } else {\n      # Final\n      div(id = \"screen\", class=\"screen show\",\n          div(class = \"title\", \"Thank you\"),\n          div(class = \"desc\", \"You may download your responses or restart.\"),\n          downloadButton(\"download_csv\", \"Download Responses (CSV)\", class = \"btn btn-download\"),\n          actionButton(\"restart\", \"Restart\", class = \"btn btn-back\"),\n          div(class = \"footer\", \"Responses are saved remotely on Supabase. Click download to store your own copy.\")\n      )\n    }\n  })\n  outputOptions(output, \"screenUI\", suspendWhenHidden = FALSE)\n  outputOptions(output, \"progressUI\", suspendWhenHidden = FALSE)  # optional, keeps dots updating\n  \n  # Run once after the first render/flush (safe reactive read via isolate)\n  session$onFlushed(function() {\n    session$sendCustomMessage(\"enforceNextDisable\", isolate(rv$pre_step))\n  }, once = TRUE)\n  \n  # Run once after the first render/flush (safe reactive read via isolate)\n  session$onFlushed(function() {\n    session$sendCustomMessage(\"enforceVigNextDisable\", isolate(rv$vig_step))\n  }, once = TRUE)\n  \n  # sync question vig steps\n  \n  sync_question_vig_step <- function() {\n    session$sendCustomMessage('setCurrentVigStep', list(step = rv$vig_step))\n    \n    v <- rv$current_vignette\n    s <- rv$vig_step\n    \n    if (s == 4L) {\n      val <- rv$answers[[v]]$q1 %||% NULL\n      if (is.null(val) || !nzchar(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q1'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q1', value = as.character(val)))\n      }\n    } else if (s == 5L) {\n      val <- rv$answers[[v]]$q2 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q2'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q2', value = as.character(val)))\n      }\n    } else if (s == 6L) {\n      val <- rv$answers[[v]]$q3 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q3'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q3', value = as.character(val)))\n      }\n      \n    } else if (s == 7L) {  # NEW\n      val <- rv$answers[[v]]$q4 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q4'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q4', value = as.character(val)))\n      }\n    } else if (s == 8L) {  # NEW\n      val <- rv$answers[[v]]$q5 %||% NULL\n      if (is.null(val) || is.na(val)) {\n        session$sendCustomMessage('resetVigStepInputs',   list(step = s, id = 'q5'))\n      } else {\n        session$sendCustomMessage('prefillVigStepInputs', list(step = s, id = 'q5', value = as.character(val)))\n      }\n    } else if (v == 5 && s == 1) {  # Post-vignette question\n      val <- rv$post_vignette_answer\n      if (is.null(val) || !nzchar(val)) {\n        # Clear the text area\n        updateTextAreaInput(session, \"post_q_text\", value = \"\")\n      } else {\n        # Pre-fill the text area\n        updateTextAreaInput(session, \"post_q_text\", value = val)\n      }\n    } else {\n      # Non-question steps\n      session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n      return()\n    }\n    \n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  }\n  \n  observeEvent(input$modal_enter_close, {\n    removeModal()\n  })\n  \n  # Skip to vignettes (bypass all pre-questionnaires)\n  observeEvent(input$btn_skip_pre, {\n    if (!isTRUE(rv$admin_unlocked)) return()\n    \n    # Validate participant ID is entered\n    id <- trimws(input$participant_id %||% \"\")\n    if (!nzchar(id)) {\n      showModal(modalDialog(\n        title = \"Missing Participant ID\",\n        \"Please enter a Participant ID first.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # SET THE SKIP FLAG\n    rv$admin_skip_used <- TRUE\n    \n    # Generate fake pre-questionnaire data\n    rv$pre_answers <- list(\n      demographics = list(\n        age = \"25-34\",\n        gender = \"Male\", \n        education = \"Bachelor's\",\n        postcode = \"12\"\n      ),\n      crt = list(\n        q1 = \"2\", q2 = \"8\", q3 = \"Emily\", q4 = \"0\"\n      ),\n      gaais = as.list(setNames(rep(3L, 21), paste0(\"q\", 1:21))),\n      fwa = list(q1 = 2L, q2 = 1L),\n      teique = as.list(setNames(rep(4L, 31), paste0(\"q\", 1:31))),\n      mhlc = as.list(setNames(rep(3L, 18), paste0(\"q\", 1:18)))\n    )\n    \n    # Set fake timestamps\n    fake_time <- Sys.time() - 300  # 5 minutes ago\n    rv$section_started_at <- list(\n      demographics = fake_time,\n      crt = fake_time + 60,\n      gaais = fake_time + 120,\n      fwa = fake_time + 180,\n      teique = fake_time + 240,\n      mhlc = fake_time + 300\n    )\n    \n    # Generate vignettes\n    seed_val <- suppressWarnings(as.integer(input$seed))\n    rv$vignettes <- generate_balanced_vignettes(\n      seed = if (!is.na(seed_val)) seed_val else NULL\n    )\n    \n    # Skip to vignettes\n    rv$started <- TRUE\n    rv$current_vignette <- 1L\n    rv$vig_step <- 1L\n    rv$pre_step <- 13L  # Completed\n    \n    # Record vignette start time\n    rv$vignette_started_at[1] <- Sys.time()\n    \n    # Update client state\n    session$sendCustomMessage('setCurrentVignette', list(vignette = 1))\n    session$sendCustomMessage('setCurrentVigStep', list(step = 1))\n    session$sendCustomMessage('setPreStep', list(step = 13))\n    \n    sync_question_vig_step()\n    set_detailed_progress()\n    \n    showNotification(\"Skipped to Vignette 1 with fake pre-questionnaire data.\", \n                     type = \"message\", duration = 4)\n  })\n  \n  # Skip to post-vignette question\n  observeEvent(input$btn_skip_to_post, {\n    if (!isTRUE(rv$admin_unlocked)) return()\n    \n    # Validate participant ID is entered\n    id <- trimws(input$participant_id %||% \"\")\n    if (!nzchar(id)) {\n      showModal(modalDialog(\n        title = \"Missing Participant ID\", \n        \"Please enter a Participant ID first.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # SET THE SKIP FLAG\n    rv$admin_skip_used <- TRUE\n    \n    # Generate fake pre-questionnaire data (same as above)\n    rv$pre_answers <- list(\n      demographics = list(age = \"25-34\", gender = \"Male\", education = \"Bachelor's\", postcode = \"12\"),\n      crt = list(q1 = \"2\", q2 = \"8\", q3 = \"Emily\", q4 = \"0\"),\n      gaais = as.list(setNames(rep(3L, 21), paste0(\"q\", 1:21))),\n      fwa = list(q1 = 2L, q2 = 1L),\n      teique = as.list(setNames(rep(4L, 31), paste0(\"q\", 1:31))),\n      mhlc = as.list(setNames(rep(3L, 18), paste0(\"q\", 1:18)))\n    )\n    \n    # Generate fake vignette data\n    seed_val <- suppressWarnings(as.integer(input$seed))\n    rv$vignettes <- generate_balanced_vignettes(\n      seed = if (!is.na(seed_val)) seed_val else NULL\n    )\n    \n    fake_time <- Sys.time() - 600  # 10 minutes ago\n    \n    # Generate fake vignette responses\n    for (i in 1:4) {\n      rv$answers[[i]] <- list(\n        q1 = sample(c(\"Yes\", \"No\"), 1),\n        q2 = sample(1:7, 1),\n        q3 = sample(1:7, 1), \n        q4 = sample(1:7, 1),\n        q5 = sample(1:7, 1)\n      )\n      \n      # Add fake response to database\n      v <- rv$vignettes[i, ]\n      row <- data.frame(\n        participant_id = id,\n        vignette_number = i,\n        provider = v$provider,\n        severity = v$severity,\n        advice_len = v$advice_len,\n        q_take_advice = rv$answers[[i]]$q1 == \"Yes\",\n        q_perceived_accuracy = as.integer(rv$answers[[i]]$q2),\n        q_trustworthiness = as.integer(rv$answers[[i]]$q3),\n        q_concern_condition = as.integer(rv$answers[[i]]$q4),\n        q_concern_circumstances = as.integer(rv$answers[[i]]$q5),\n        post_vignette_response = NA_character_,\n        started_at = fake_time + (i-1) * 120,\n        submitted_at = fake_time + i * 120,\n        stringsAsFactors = FALSE\n      )\n      rv$responses <- rbind(rv$responses, row)\n    }\n    \n    # Skip to post-vignette question\n    rv$started <- TRUE\n    rv$current_vignette <- 5L\n    rv$vig_step <- 1L\n    rv$pre_step <- 13L\n    \n    # Update client state\n    session$sendCustomMessage('setCurrentVignette', list(vignette = 5))\n    session$sendCustomMessage('setCurrentVigStep', list(step = 1))\n    \n    set_detailed_progress()\n    \n    showNotification(\"Skipped to post-vignette question with fake data.\", \n                     type = \"message\", duration = 4)\n  })\n  \n  # Supabase login handler\n  observeEvent(input$btn_sb_login, {\n    email <- trimws(input$sb_email %||% \"\")\n    password <- input$sb_password %||% \"\"\n    if (!nzchar(email) || !nzchar(password)) {\n      showModal(modalDialog(\n        title = \"Missing Credentials\",\n        \"Please enter both email and password to sign in to Supabase.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    tryCatch({\n      token <- supabase_sign_in(email, password)\n      rv$sb_access_token <- token$access_token\n      rv$sb_refresh_token <- token$refresh_token\n      rv$sb_expires_at    <- Sys.time() + as.numeric(token$expires_in)\n      rv$sb_user_email <- email\n      showNotification(\"Signed in to Supabase successfully.\", type = \"message\", duration = 4)\n    }, error = function(e) {\n      showModal(modalDialog(\n        title = \"Supabase Sign-in Error\",\n        paste(\"Could not sign in:\", e$message),\n        easyClose = TRUE\n      ))\n    })\n  })\n  \n  # Navigation: Start Button\n  \n  observeEvent(input$btn_start, {\n    id <- trimws(input$participant_id %||% \"\")\n    seed_input <- trimws(input$seed %||% \"\")\n    email_input <- trimws(input$sb_email %||% \"\")\n    password_input <- input$sb_password %||% \"\"\n    \n    # Validate input lengths\n    if (nchar(id) > 50) {\n      showModal(modalDialog(\n        title = \"Participant ID Too Long\",\n        \"Participant ID must be 50 characters or fewer.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    if (nchar(seed_input) > 10) {\n      showModal(modalDialog(\n        title = \"Seed Too Long\", \n        \"Seed must be 10 characters or fewer.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    if (nchar(email_input) > 100) {\n      showModal(modalDialog(\n        title = \"Email Too Long\",\n        \"Email must be 100 characters or fewer.\", \n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    if (nchar(password_input) > 50) {\n      showModal(modalDialog(\n        title = \"Password Too Long\",\n        \"Password must be 50 characters or fewer.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    \n    if (!nzchar(id)) {\n      showModal(modalDialog(\n        title = \"Missing Participant ID\",\n        \"Please enter a Participant ID to begin.\",\n        footer = tagList(modalButton(\"Dismiss\")),\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # Uniqueness check (as you already have)\n    exists <- FALSE\n    tryCatch({\n      exists <- supabase_pid_exists(id, access_token = rv$sb_access_token)\n    }, error = function(e) {\n      showModal(modalDialog(\n        title = \"Connectivity Issue\",\n        paste(\"Could not verify Participant ID uniqueness:\", e$message),\n        easyClose = TRUE\n      ))\n      return()\n    })\n    if (isTRUE(exists)) {\n      showModal(modalDialog(\n        title = \"Participant ID Already Used\",\n        \"It appears that you have already participated in the research. Thank you. If you have not, please enter a different Participant ID.\",\n        easyClose = TRUE\n      ))\n      return()\n    }\n    \n    # Pre-questionnaires first\n    rv$started <- TRUE\n    rv$current_vignette <- 0L\n    rv$pre_step <- 1L\n    \n    # INFORM CLIENT OF CURRENT PRE STEP\n    session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n    \n    \n    session$onFlushed(function() {\n      session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n    }, once = FALSE)\n    \n    rv$last_dir <- \"forward\"\n    set_detailed_progress()\n    session$sendCustomMessage('enforceNextDisable', rv$pre_step)\n    \n    # Disable interior scrolling when leaving welcome screen\n    session$onFlushed(function() {\n      session$sendCustomMessage(\"disableInteriorScrolling\", NULL)\n    }, once = TRUE)\n  })\n  \n  ## observeEvent(input$btn_start_2, {\n  ##   id <- trimws(input$participant_id %||% \"\")\n  ##   seed_val <- suppressWarnings(as.integer(input$seed))\n  ##     rv$vignettes <- generate_balanced_vignettes(\n  ##  seed = if (!is.na(seed_val)) seed_val else NULL\n  ##     )\n  ## rv$started <- TRUE\n  ## rv$current_vignette <- 1L\n  ## rv$vig_step <- 1L\n  ##     \n  ## session$onFlushed(function() {\n  ## session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n  ## }, once = FALSE)\n  ##     \n  ## sync_question_vig_step()\n  ## # Record start time for vignette 1 when step 1 is first shown\n  ## if (is.na(rv$vignette_started_at[1])) {\n  ## rv$vignette_started_at[1] <- Sys.time()\n  ## }\n  ## rv$last_dir <- \"forward\"\n  ## set_detailed_progress()\n  ## session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  ## })\n  \n  \n  # Navigation: Start / Next\n  \n  observeEvent(input$btn_next, {\n    dir <- \"forward\"\n    \n    # NEW SECTION FOR PRE-QUESTIONNAIRES\n    if (rv$started && rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 13) {\n      handle_pre_questionnaire_step()\n      set_detailed_progress()\n      session$onFlushed(function() {\n        session$sendCustomMessage('cardApplySlideIn', NULL)\n      }, once = FALSE)\n      return()\n    }\n    \n    # Start flow\n    if (!rv$started) {\n      session$onFlushed(function() {\n        session$sendCustomMessage('focusPID', TRUE)\n      }, once = FALSE)\n      id <- trimws(input$participant_id %||% \"\")\n      if (!nzchar(id)) {\n        showModal(modalDialog(\n          title = \"Missing Participant ID\",\n          \"Please enter a Participant ID to begin.\",\n          easyClose = TRUE\n        ))\n        return()\n      }\n      \n      seed_val <- suppressWarnings(as.integer(input$seed))\n      rv$vignettes <- generate_balanced_vignettes(\n        seed = if (!is.na(seed_val)) seed_val else NULL\n      )\n      rv$started <- TRUE\n      rv$current_vignette <- 1L\n      rv$vig_step <- 1L\n      \n      session$onFlushed(function() {\n        session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n      }, once = FALSE)\n      \n      sync_question_vig_step()\n      # Record start time for vignette 1 when step 1 is first shown\n      if (is.na(rv$vignette_started_at[1])) {\n        rv$vignette_started_at[1] <- Sys.time()\n      }\n      rv$last_dir <- dir\n      set_detailed_progress()\n      session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n      \n    }\n    \n    # DEBUG: Always print current state\n    # cat(\"DEBUG: Current vignette:\", rv$current_vignette, \"VigStep:\", rv$vig_step, \"\\n\")\n    \n    # Handle post-vignette question FIRST - before any other conditions\n    if (rv$current_vignette == 5L && rv$vig_step == 1L) {\n      #  cat(\"DEBUG: In post-vignette handler\\n\")\n      post_q <- trimws(input$post_q_text %||% \"\")\n      #  cat(\"DEBUG: post_q value: '\", post_q, \"'\\n\")\n      \n      if (is.null(post_q) || !nzchar(trimws(post_q))) {\n        showModal(modalDialog(title = \"Incomplete Response\", \"Please provide an answer to the final question.\", easyClose = TRUE))\n        return()\n      }\n      \n      # Word count validation\n      word_count <- length(strsplit(post_q, \"\\\\s+\")[[1]])\n      if (word_count > 400) {\n        showModal(modalDialog(\n          title = \"Response Too Long\", \n          paste(\"Your response is\", word_count, \"words. Please shorten it to 400 words or fewer.\"), \n          easyClose = TRUE\n        ))\n        return()\n      }\n      \n      rv$post_vignette_answer <- post_q\n      \n      # Create post-vignette row\n      post_row <- data.frame(\n        participant_id = input$participant_id,\n        vignette_number = 99L,\n        provider = \"POST_VIGNETTE\",\n        severity = \"POST_VIGNETTE\", \n        advice_len = \"POST_VIGNETTE\",\n        q_take_advice = NA,\n        q_perceived_accuracy = NA,\n        q_trustworthiness = NA,\n        q_concern_condition = NA,\n        q_concern_circumstances = NA,\n        post_vignette_response = post_q,\n        started_at = Sys.time(),\n        submitted_at = Sys.time(),\n        stringsAsFactors = FALSE\n      )\n      \n      # DEBUG: Check what's in the row before sending\n      cat(\"DEBUG: post_row contents:\\n\")\n      print(post_row)\n      cat(\"DEBUG: post_vignette_response value:\", post_row$post_vignette_response, \"\\n\")\n      cat(\"DEBUG: JSON being sent:\", toJSON(post_row, auto_unbox = TRUE, na = \"null\"), \"\\n\")\n      \n      # Add to responses\n      rv$responses <- rbind(rv$responses, post_row)\n      cat(\"DEBUG: Added to responses, now has\", nrow(rv$responses), \"rows\\n\")\n      \n      # Check if we have access token\n      if (is.null(rv$sb_access_token)) {\n        cat(\"DEBUG: sb_access_token is NULL\\n\")\n      } else if (!nzchar(rv$sb_access_token)) {\n        cat(\"DEBUG: sb_access_token is empty string\\n\")\n      } else {\n        cat(\"DEBUG: sb_access_token exists, length:\", nchar(rv$sb_access_token), \"\\n\")\n      }\n      \n      # Save to Supabase\n      tryCatch({\n        cat(\"DEBUG: About to save post-vignette to Supabase\\n\")\n        ok <- save_to_supabase_auth(post_row, access_token = rv$sb_access_token)\n        if (isTRUE(ok)) {\n          showNotification(\"Post-vignette response saved to remote database.\", type = \"message\", duration = 4)\n          cat(\"DEBUG: Post-vignette saved to remote database successfully\\n\")\n        } else {\n          cat(\"DEBUG: Post-vignette Supabase save returned FALSE\\n\")\n        }\n      }, error = function(e) {\n        cat(\"DEBUG: Post-vignette Supabase error:\", e$message, \"\\n\")\n        showModal(modalDialog(\n          title = \"Supabase Save Error\", \n          paste(\"Error saving post-vignette response:\", e$message),\n          easyClose = TRUE\n        ))\n      })\n      \n      # Move to completion\n      rv$current_vignette <- 6L\n      rv$vig_step <- 0L\n      rv$last_dir <- dir\n      \n      set_detailed_progress()\n      session$onFlushed(function() {\n        session$sendCustomMessage('cardApplySlideIn', NULL)\n      }, once = FALSE)\n      session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n      return()\n    }\n    \n    # Regular vignette progression (steps 1-8)\n    # Regular vignette progression (steps 1-8)\n    if (rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      if (rv$vig_step %in% c(1L, 2L, 3L)) {\n        rv$vig_step <- rv$vig_step + 1L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # already present\n      } else if (rv$vig_step == 4L) {\n        q1 <- input$q1 %||% \"\"\n        if (!nzchar(q1)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select Yes or No.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q1 <- q1\n        \n        rv$vig_step <- 5L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q2 at step 5\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 5L) {\n        q2 <- input$q2 %||% \"\"\n        if (!nzchar(q2)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q2 <- as.integer(q2)\n        \n        rv$vig_step <- 6L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q3 at step 6\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 6L) {\n        q3 <- input$q3 %||% \"\"\n        if (!nzchar(q3)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q3 <- as.integer(q3)\n        \n        rv$vig_step <- 7L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q4 at step 7\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 7L) {\n        q4 <- input$q4 %||% \"\"\n        if (!nzchar(q4)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q4 <- as.integer(q4)\n        \n        rv$vig_step <- 8L\n        rv$last_dir <- \"forward\"\n        sync_question_vig_step()  # sends reset/prefill for q5 at step 8\n        check_response_patterns() \n        \n      } else if (rv$vig_step == 8L) {\n        # Last question of vignette\n        q5 <- input$q5 %||% \"\"\n        if (!nzchar(q5)) {\n          showModal(modalDialog(title = \"Incomplete Response\", \"Please select a value 1â€“7.\", easyClose = TRUE))\n          return()\n        }\n        if (is.null(rv$answers[[rv$current_vignette]])) rv$answers[[rv$current_vignette]] <- list()\n        rv$answers[[rv$current_vignette]]$q5 <- as.integer(q5)\n        check_response_patterns() \n        \n        # Save vignette data\n        ans <- rv$answers[[rv$current_vignette]]\n        take_bool <- ans$q1 == \"Yes\"\n        v <- rv$vignettes[rv$current_vignette, ]\n        now <- Sys.time()\n        \n        row <- data.frame(\n          participant_id        = input$participant_id,\n          vignette_number       = rv$current_vignette,\n          provider              = v$provider,\n          severity              = v$severity,\n          advice_len            = v$advice_len,\n          q_take_advice         = take_bool,\n          q_perceived_accuracy  = as.integer(ans$q2),\n          q_trustworthiness     = as.integer(ans$q3),\n          q_concern_condition   = as.integer(ans$q4),\n          q_concern_circumstances = as.integer(ans$q5),\n          post_vignette_response = NA_character_,  \n          started_at            = rv$vignette_started_at[rv$current_vignette],\n          submitted_at          = now,\n          stringsAsFactors      = FALSE\n        )\n        rv$responses <- rbind(rv$responses, row)\n        \n        # Save to Supabase\n        if (!is.null(rv$sb_access_token) && nzchar(rv$sb_access_token)) {\n          tryCatch({\n            ok <- save_to_supabase_auth(row, access_token = rv$sb_access_token)\n            if (isTRUE(ok)) {\n              showNotification(sprintf(\"Saved vignette %d to remote database.\", rv$current_vignette), type = \"message\", duration = 4)\n            }\n          }, error = function(e) {\n            showModal(modalDialog(title = \"Supabase Save Error\", paste(\"Error:\", e$message), easyClose = TRUE))\n          })\n        }\n        \n        if (rv$current_vignette < 4L) {\n          # Next vignette\n          rv$current_vignette <- rv$current_vignette + 1L\n          rv$vig_step <- 1L\n          if (is.na(rv$vignette_started_at[rv$current_vignette])) {\n            rv$vignette_started_at[rv$current_vignette] <- Sys.time()\n          }\n          sync_question_vig_step()  # KEEP THIS: step 1 screen setup\n        } else {\n          # Go to post-vignette question\n          rv$current_vignette <- 5L\n          rv$vig_step <- 1L\n        }\n        rv$last_dir <- dir\n      }\n    }\n    \n    # Capture the current step and vignette BEFORE the onFlushed callback\n    current_vigstep_val <- rv$vig_step\n    current_vignette_val <- rv$current_vignette\n    \n    set_detailed_progress()\n    session$onFlushed(function() {\n      session$sendCustomMessage('cardApplySlideIn', NULL)\n      # Use the captured values instead of accessing reactive values\n      session$sendCustomMessage('setCurrentVigStep', list(step = current_vigstep_val))\n      session$sendCustomMessage('setCurrentVignette', list(vignette = current_vignette_val))\n    }, once = FALSE)\n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  })\n  \n  # Navigation: Back\n  observeEvent(input$btn_back, {\n    if (!rv$started) return()\n    dir <- \"back\"\n    \n    # ONLY block in pre-questionnaires (current_vignette == 0)\n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 12) {\n      if (rv$pre_step %in% c(3, 5, 7, 9, 11)) {\n        showNotification(\"Cannot go back to completed questionnaire.\", type = \"warning\", duration = 3)\n        return()\n      }\n    }\n    \n    \n    # Show notification when at the very beginning (vignette 1, step 1)\n    if (rv$current_vignette == 1L && rv$vig_step == 1L) {\n      showNotification(\"Already at the first step.\", type = \"message\", duration = 2)\n      return()\n    }\n    \n    # HANDLE BACK NAVIGATION WITHIN PRE-QUESTIONNAIRES\n    if (rv$current_vignette == 0 && rv$pre_step >= 1 && rv$pre_step <= 12) {\n      \n      if (rv$pre_step == 2) {\n        # Demographics - go back within questions or to intro\n        current_q_num <- length(rv$pre_answers$demographics) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$demographics)[length(rv$pre_answers$demographics)]\n          last_val <- rv$pre_answers$demographics[[last_q]]\n          \n          # Save to buffer\n          rv$popped_answers$demographics[[last_q]] <- last_val\n          \n          \n          rv$pre_answers$demographics[[last_q]] <- NULL\n          \n          q_data   <- demographics_questions[[last_q]]\n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (q_data$type == \"scale\") {\n              idx <- match(last_val, q_data$options)\n              if (!is.na(idx)) {\n                session$sendCustomMessage(\n                  'prefillStepInputs',\n                  list(step = pre_step_val, id = paste0('demo_', last_q), value = as.character(idx))\n                )\n              }\n            } else {\n              updateTextInput(session, \"current_answer\", value = last_val %||% \"\")\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 1L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step))  \n          \n        }\n        \n      } else if (rv$pre_step == 4) {\n        current_q_num <- length(rv$pre_answers$crt) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$crt)[length(rv$pre_answers$crt)]\n          last_val <- rv$pre_answers$crt[[last_q]]\n          rv$popped_answers$crt[[last_q]] <- last_val\n          \n          rv$pre_answers$crt[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            updateTextInput(session, \"current_answer\", value = last_val %||% \"\")\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 3L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n          \n        }\n        \n      } else if (rv$pre_step == 6) {\n        current_q_num <- length(rv$pre_answers$gaais) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$gaais)[length(rv$pre_answers$gaais)]\n          last_val <- rv$pre_answers$gaais[[last_q]]  # integer 1..5\n          \n          rv$popped_answers$gaais[[last_q]] <- last_val\n          \n          rv$pre_answers$gaais[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'gaais_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 5L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n          \n        }\n        \n      } else if (rv$pre_step == 8) {\n        current_q_num <- length(rv$pre_answers$fwa) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$fwa)[length(rv$pre_answers$fwa)]\n          last_val <- rv$pre_answers$fwa[[last_q]]  # integer 1..5\n          rv$popped_answers$fwa[[last_q]] <- last_val\n          \n          rv$pre_answers$fwa[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'fwa_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 7L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n          \n        }\n        \n      } else if (rv$pre_step == 10) {\n        current_q_num <- length(rv$pre_answers$teique) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$teique)[length(rv$pre_answers$teique)]\n          last_val <- rv$pre_answers$teique[[last_q]]  # integer 1..7\n          rv$popped_answers$teique[[last_q]] <- last_val\n          \n          rv$pre_answers$teique[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'teique_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 9L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step)) \n          \n        }\n        \n      } else if (rv$pre_step == 12) {\n        current_q_num <- length(rv$pre_answers$mhlc) + 1\n        if (current_q_num > 1) {\n          last_q   <- names(rv$pre_answers$mhlc)[length(rv$pre_answers$mhlc)]\n          last_val <- rv$pre_answers$mhlc[[last_q]]  # integer 1..6\n          rv$popped_answers$mhlc[[last_q]] <- last_val\n          \n          rv$pre_answers$mhlc[[last_q]] <- NULL\n          \n          pre_step_val <- isolate(rv$pre_step)\n          session$onFlushed(function() {\n            if (!is.null(last_val)) {\n              session$sendCustomMessage(\n                'prefillStepInputs',\n                list(step = pre_step_val, id = 'mhlc_q', value = as.character(last_val))\n              )\n            }\n          }, once = TRUE)\n        } else {\n          rv$pre_step <- 11L\n          session$sendCustomMessage('setPreStep', list(step = rv$pre_step))  \n          \n        }\n      }\n      \n      rv$last_dir <- dir\n      set_detailed_progress()\n      session$onFlushed(function() {\n        session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n      }, once = FALSE)\n      session$sendCustomMessage('enforceNextDisable', rv$pre_step)\n      return()\n    }\n    \n    # VIGNETTE BACK NAVIGATION (restored)\n    if (rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      if (rv$vig_step > 1L) {\n        rv$vig_step <- rv$vig_step - 1L\n      } else if (rv$vig_step == 1L && rv$current_vignette > 1L) {\n        rv$current_vignette <- rv$current_vignette - 1L\n        rv$vig_step <- 6L\n      }\n    } else if (rv$current_vignette == 5L && rv$vig_step == 1L) {\n      # Go back to last step of last vignette\n      rv$current_vignette <- 4L\n      rv$vig_step <- 8L\n    } else if (rv$current_vignette == 6L) {\n      # Go back to post-vignette question\n      rv$current_vignette <- 5L\n      rv$vig_step <- 1L}\n    \n    # If we land on step 1 of a vignette, ensure its start time is set (only once)\n    if (rv$vig_step == 1L && rv$current_vignette >= 1L && rv$current_vignette <= 4L) {\n      if (is.na(rv$vignette_started_at[rv$current_vignette])) {\n        rv$vignette_started_at[rv$current_vignette] <- Sys.time()\n      }\n    }\n    \n    rv$last_dir <- dir\n    set_detailed_progress()\n    sync_question_vig_step()\n    session$onFlushed(function() {\n      session$sendCustomMessage(\"cardApplySlideIn\", NULL)\n    }, once = FALSE)\n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n  })\n  \n  # CSV download\n  output$download_csv <- downloadHandler(\n    filename = function() {\n      paste0(\"complete_responses_\",\n             gsub(\"[^A-Za-z0-9_-]\", \"_\", input$participant_id %||% \"anon\"),\n             \".csv\")\n    },\n    content = function(file) {\n      tryCatch({\n        cat(\"Starting CSV compilation...\\n\")\n        all_data <- compile_all_data()\n        cat(\"Data compiled, rows:\", nrow(all_data), \"\\n\")\n        \n        if (nrow(all_data) > 0) {\n          # Fix Excel postcode issue on export\n          all_data$post_vignette_response <- ifelse(\n            grepl(\"DEMOGRAPHICS_postcode\", all_data$severity) & \n              grepl(\"^[0-9]{2}$\", all_data$post_vignette_response),\n            paste0(\"'\", all_data$post_vignette_response),\n            all_data$post_vignette_response\n          )\n          \n          write.csv(all_data, file, row.names = FALSE)\n          cat(\"CSV written successfully\\n\")\n        } else {\n          cat(\"No data to write, creating empty file\\n\")\n          write.csv(data.frame(message = \"No data available\"), file, row.names = FALSE)\n        }\n      }, error = function(e) {\n        cat(\"Error in download handler:\", e$message, \"\\n\")\n        write.csv(data.frame(\n          error = e$message,\n          vignette_rows = nrow(rv$responses),\n          demographics_answers = length(rv$pre_answers$demographics)\n        ), file, row.names = FALSE)\n      })\n    }\n  )\n  \n  # Restart\n  observeEvent(input$restart, {\n    rv$admin_skip_used <- FALSE\n    rv$started <- FALSE\n    rv$vignettes <- NULL\n    rv$current_vignette <- 0L\n    rv$pre_step <- 0L\n    rv$vig_step <- 0L\n    rv$answers <- vector(\"list\", 4)\n    rv$responses <- rv$responses[0, , drop = FALSE]\n    rv$last_dir <- \"forward\"\n    rv$sb_access_token <- NULL\n    rv$sb_user_email <- NULL\n    rv$post_vignette_answer <- NULL\n    \n    \n    # ADD THESE MISSING RESETS:\n    rv$pre_answers <- list(\n      demographics = list(),\n      crt = list(),\n      gaais = list(),\n      fwa = list(),\n      teique = list(),\n      mhlc = list()\n    )\n    \n    rv$popped_answers <- list(\n      demographics = list(), \n      crt = list(),\n      gaais = list(), \n      fwa = list(),\n      teique = list(), \n      mhlc = list()\n    )\n    \n    rv$pre_q_completed <- list(\n      demographics = numeric(),\n      crt = numeric(),\n      gaais = numeric(),\n      fwa = numeric(),\n      teique = numeric(),\n      mhlc = numeric()\n    )\n    \n    rv$section_started_at <- list(\n      demographics = as.POSIXct(NA_character_),\n      crt         = as.POSIXct(NA_character_),\n      gaais       = as.POSIXct(NA_character_),\n      fwa         = as.POSIXct(NA_character_),\n      teique      = as.POSIXct(NA_character_),\n      mhlc        = as.POSIXct(NA_character_)\n    )\n    \n    rv$completed_questionnaires <- character()\n    rv$vignette_started_at <- as.POSIXct(rep(NA_character_, 4))\n    \n    # Clear all input values\n    updateTextInput(session, \"participant_id\", value = \"\")\n    updateTextInput(session, \"seed\", value = \"\")\n    updateTextInput(session, \"sb_email\", value = \"\")\n    updateTextInput(session, \"sb_password\", value = \"\")\n    updateTextAreaInput(session, \"post_q_text\", value = \"\")\n    \n    # Reset client-side state\n    session$sendCustomMessage(\"setTopProgress\", 0)\n    session$sendCustomMessage('setPreStep', list(step = 0))\n    session$sendCustomMessage('setCurrentVignette', list(vignette = 0))\n    session$sendCustomMessage('setCurrentVigStep', list(step = 0))\n    \n    # Reset warning tracking\n    rv$warning_cooldowns <- list(\n      gaais_straightline = as.POSIXct(NA),\n      teique_straightline = as.POSIXct(NA),\n      mhlc_straightline = as.POSIXct(NA),\n      vignette_pattern = as.POSIXct(NA),\n      speed_warning = as.POSIXct(NA),\n      attention_check = as.POSIXct(NA)\n    )\n    rv$warning_shown <- list(\n      gaais_straightline = FALSE,\n      teique_straightline = FALSE,\n      mhlc_straightline = FALSE,\n      vignette_pattern = FALSE,\n      speed_warning = FALSE\n    )\n    \n    session$onFlushed(function() {\n      session$sendCustomMessage('focusPID', TRUE)\n    }, once = FALSE)\n  })\n  \n  # Initial transition/progress sync\n  observe({\n    set_detailed_progress()\n    session$sendCustomMessage('enforceVigNextDisable', rv$vig_step)\n    if (exists(\"sync_question_vig_step\", inherits = FALSE)) sync_question_vig_step()\n    if (!rv$started) {\n      session$onFlushed(function() {\n        session$sendCustomMessage('focusPID', TRUE)\n      }, once = FALSE)\n    }\n  })\n  \n  \n  # attention checks\n  check_response_patterns <- function() {\n    \n    # SKIP ALL PATTERN DETECTION IF ADMIN SKIP WAS USED\n    if (isTRUE(rv$admin_skip_used)) {\n      return()\n    }\n    \n    # Helper function to check if warning is on cooldown\n    is_on_cooldown <- function(warning_type, cooldown_minutes = 10) {\n      last_warning <- rv$warning_cooldowns[[warning_type]]\n      if (is.na(last_warning)) return(FALSE)\n      \n      time_since <- as.numeric(difftime(Sys.time(), last_warning, units = \"mins\"))\n      return(time_since < cooldown_minutes)\n    }\n    \n    # Helper function to set cooldown\n    set_cooldown <- function(warning_type) {\n      rv$warning_cooldowns[[warning_type]] <- Sys.time()\n      rv$warning_shown[[warning_type]] <- TRUE\n    }\n    \n    # Check GAAIS for straight-lining (only once per session)\n    if (length(rv$pre_answers$gaais) >= 8 && \n        !rv$warning_shown$gaais_straightline && \n        !is_on_cooldown(\"gaais_straightline\")) {\n      \n      recent_gaais <- tail(unlist(rv$pre_answers$gaais), 8)\n      if (length(unique(recent_gaais)) <= 2) {\n        show_blocking_warning(\n          title = \"Response Pattern Detected\",\n          message = \"We've noticed you have been naughty and have been selecting similar responses to recent questions. Each question asks about different aspects of artificial intelligence. Please read each statement carefully before responding, as your genuine opinions help make this research valuable.\",\n          duration = 5\n        )\n        set_cooldown(\"gaais_straightline\")\n        return()\n      }\n    }\n    \n    # Check TEIQue for straight-lining (only once per session)\n    if (length(rv$pre_answers$teique) >= 10 && \n        !rv$warning_shown$teique_straightline && \n        !is_on_cooldown(\"teique_straightline\")) {\n      \n      recent_teique <- tail(unlist(rv$pre_answers$teique), 10)\n      if (length(unique(recent_teique)) == 1) {\n        show_blocking_warning(\n          title = \"Identical Responses Detected\", \n          message = \"We have noticed you have been naughty and have given the same response to the last 10 questions. People typically vary in their emotional intelligence responses. Please take your time to consider how each statement applies to you personally.\",\n          duration = 5\n        )\n        set_cooldown(\"teique_straightline\")\n        return()\n      }\n    }\n    \n    # Check MHLC for straight-lining (only once per session)\n    if (length(rv$pre_answers$mhlc) >= 8 && \n        !rv$warning_shown$mhlc_straightline && \n        !is_on_cooldown(\"mhlc_straightline\")) {\n      \n      recent_mhlc <- tail(unlist(rv$pre_answers$mhlc), 8)\n      if (length(unique(recent_mhlc)) <= 2) {\n        show_blocking_warning(\n          title = \"Response Pattern Detected\",\n          message = \"We noticed you have been naughty and have been selecting similar responses repeatedly. Please take a moment to read each health belief statement carefully, as people typically have varied opinions on these topics. Your thoughtful responses are important for our research.\",\n          duration = 5\n        )\n        set_cooldown(\"mhlc_straightline\")\n        return()\n      }\n    }\n    \n    # Check vignette responses for patterns (only once per session)\n    if (rv$current_vignette >= 3 && \n        !rv$warning_shown$vignette_pattern && \n        !is_on_cooldown(\"vignette_pattern\")) {\n      \n      # Check Q2 (accuracy) responses\n      q2_responses <- sapply(1:(rv$current_vignette-1), function(v) {\n        rv$answers[[v]]$q2\n      })\n      q2_responses <- q2_responses[!is.null(q2_responses)]\n      \n      # Check Q3 (trustworthiness) responses  \n      q3_responses <- sapply(1:(rv$current_vignette-1), function(v) {\n        rv$answers[[v]]$q3\n      })\n      q3_responses <- q3_responses[!is.null(q3_responses)]\n      \n      if ((length(q2_responses) >= 3 && length(unique(q2_responses)) == 1) ||\n          (length(q3_responses) >= 3 && length(unique(q3_responses)) == 1)) {\n        \n        show_blocking_warning(\n          title = \"Consider Each Scenario Independently\",\n          message = \"You've given identical ratings across different healthcare scenarios. Each scenario involves different conditions and providers. Please evaluate each piece of advice on its own merits.\",\n          duration = 5\n        )\n        set_cooldown(\"vignette_pattern\")\n        return()\n      }\n    }\n    \n    # Check for very fast responses (can repeat, but with cooldown)\n    if (length(rv$response_times) > 0 && !is_on_cooldown(\"speed_warning\", 5)) {\n      recent_times <- tail(unlist(rv$response_times), 5)\n      \n      # Very fast average\n      if (length(recent_times) >= 4 && mean(recent_times) < 1.5) {\n        show_blocking_warning(\n          title = \"Please Slow Down\",\n          message = \"You appear to be responding very quickly (less than 1.5 seconds per question). Quality research depends on thoughtful responses. Please take time to read and consider each question carefully.\",\n          duration = 5\n        )\n        set_cooldown(\"speed_warning\")\n        return()\n      }\n      \n      # Extremely fast individual responses\n      if (length(recent_times) >= 2 && any(recent_times < 0.8)) {\n        show_blocking_warning(\n          title = \"Response Too Fast\",\n          message = \"Some of your recent responses were given in less than a second. Please ensure you're reading each question completely before selecting your answer.\",\n          duration = 5\n        )\n        set_cooldown(\"speed_warning\")\n        return()\n      }\n    }\n  }\n  \n  # Add this helper function to your server:\n  is_on_cooldown <- function(warning_type, cooldown_minutes = 10) {\n    last_warning <- rv$warning_cooldowns[[warning_type]]\n    if (is.na(last_warning)) return(FALSE)\n    \n    time_since <- as.numeric(difftime(Sys.time(), last_warning, units = \"mins\"))\n    return(time_since < cooldown_minutes)\n  }\n  \n  # Handle postcode confirmation\n  observeEvent(input$postcode_confirmed, {\n    # User confirmed the postcode is correct - proceed to next question\n    current_q_num <- length(rv$pre_answers$demographics) + 1\n    q_names <- names(demographics_questions)\n    current_q_name <- q_names[current_q_num]\n    \n    # Get the postcode value\n    input_id <- paste0(\"demo_text_\", current_q_name)\n    postcode_value <- trimws(input[[input_id]] %||% \"\")\n    \n    # Save the confirmed postcode\n    excel_postcode <- paste0(\"'\", postcode_value)\n    rv$pre_answers$demographics[[current_q_name]] <- postcode_value\n    \n    rv$pre_q_completed$demographics[current_q_num] <- Sys.time()\n    rv$popped_answers$demographics[[current_q_name]] <- NULL\n    \n    # Proceed with normal flow\n    if (current_q_num < 4) {\n      session$sendCustomMessage('resetPreStepInputs', list(step = rv$pre_step, id = paste0('demo_', current_q_name)))\n    } else {\n      save_demographics_data()\n      rv$pre_step <- rv$pre_step + 1L\n      session$sendCustomMessage('setPreStep', list(step = rv$pre_step))\n    }\n    \n    set_detailed_progress()\n  })\n  \n  # Handle postcode rejection  \n  observeEvent(input$postcode_rejected, {\n    # User wants to correct - just clear the input and let them re-enter\n    current_q_num <- length(rv$pre_answers$demographics) + 1\n    q_names <- names(demographics_questions)\n    current_q_name <- q_names[current_q_num]\n    input_id <- paste0(\"demo_text_\", current_q_name)\n    \n    # Clear the input\n    updateTextInput(session, input_id, value = \"\")\n    \n    # Focus back on the input\n    session$onFlushed(function() {\n      session$sendCustomMessage(\"autoFocusText\", TRUE)\n    }, once = TRUE)\n  })\n  \n  # Auto-refresh ~5 minutes before expiry\n  observe({\n    invalidateLater(60 * 1000, session)\n    if (!is.null(rv$sb_expires_at) && !is.null(rv$sb_refresh_token)) {\n      if (difftime(rv$sb_expires_at, Sys.time(), units = \"mins\") < 5) {\n        try({\n          rt <- supabase_refresh_token(rv$sb_refresh_token)\n          rv$sb_access_token <- rt$access_token\n          rv$sb_expires_at   <- Sys.time() + as.numeric(rt$expires_in)\n          message(\"Machine user token refreshed.\")\n        }, silent = TRUE)\n      }\n    }\n  })\n  \n}\n\n\n\nshinyApp(ui, server)","type":"text"},{"name":"edit/index.html","content":"<!doctype html>\n<html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"en\">\n  <head>\n    <title>Redirect to editable app<\/title>\n    <meta\n      http-equiv=\"refresh\"\n      content=\"0;URL='../index.html?_shinylive-mode=editor-terminal-viewer'\"\n    />\n  <\/head>\n  <body><\/body>\n<\/html>\n","type":"text"}]
